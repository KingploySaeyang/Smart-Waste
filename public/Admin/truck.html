<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title></title>
  <link rel="stylesheet" href="a_style.css">
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyCyTSsRmX642krpJYOI-TfFpIhnxJBbzxk",
      authDomain: "smart-waste2568.firebaseapp.com",
      projectId: "smart-waste2568",
      storageBucket: "smart-waste2568.firebasestorage.app",
      messagingSenderId: "122699752010",
      appId: "1:122699752010:web:c22ab9b28ac15beaedbcb3",
      measurementId: "G-H82914YP66",
      // üö® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ (‡∏Å‡πä‡∏≠‡∏õ URL ‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Realtime Database ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
      databaseURL: "https://smart-waste2568-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
  </script>
  <script src="../Login/auth.js"></script>
  <script src="admin-lang.js"></script>
  <script src="../i18n/lang.js"></script>
  <script src="../i18n/th.js"></script>
  <script src="../i18n/en.js"></script>
  <script src="../i18n/ms.js"></script>
  <script src="admin-user.js" defer></script>
  <script src="admin-nav.js" defer></script>
  <script src="admin-profile.js" defer></script>
  <script src="admin-auth-bootstrap.js" defer></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

  <style>
    /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏à‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô css ‡∏Å‡∏•‡∏≤‡∏á) */
    body {
      overflow-x: hidden;
    }

    /* ================================
   ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ (‡∏´‡∏ô‡πâ‡∏≤ dashboard / home)
   ================================ */
    .cards {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin: 4px 0 8px;
    }

    .cards .card {
      flex: 1 1 220px;
      background: #f9fafb;
      padding: 18px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, .05);
      transition: .2s;
      margin: 0;
    }

    .cards .card:hover {
      background: #e0f2fe;
      transform: translateY(-2px);
    }

    .cards .card h3 {
      font-size: 17px;
      color: #2f3640;
      margin: 0 0 6px;
    }

    .cards .card p {
      font-size: 21px;
      font-weight: bold;
      color: #00a8ff;
      margin: 0;
    }

    /* ================================
   ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
   ================================ */
    #map {
      width: 100%;
      height: 460px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }

    /* wrapper ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      margin-top: 8px;
    }

    .swal2-container {
      z-index: 2000 !important;
    }

    /* ================================
   Overlay ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ modal ‡∏Å‡∏•‡∏≤‡∏á)
   ================================ */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1100;
    }

    .overlay-card {
      width: min(520px, 92vw);
      max-width: 520px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.38);
      padding: 20px 18px 16px;
      transform: translateY(8px) scale(.97);
      opacity: 0;
      animation: overlayIn .18s ease-out forwards;
    }

    .overlay-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: stretch;
    }

    @keyframes overlayIn {
      from {
        opacity: 0;
        transform: translateY(8px) scale(.96);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @media (min-width: 640px) {
      .overlay-actions {
        flex-direction: row;
        justify-content: flex-end;
      }

      .overlay-actions button {
        min-width: 120px;
      }
    }

    /* ================================
   ICON ‡∏£‡∏ñ (Leaflet)
   ================================ */
    .leaflet-marker-icon.truck-icon {
      background: transparent;
      border: none;
    }

    .truck-pin {
      --pin-color: #f43f5e;
      --pin-label: #0f172a;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      filter: drop-shadow(0 10px 20px rgba(15, 23, 42, .25));
    }

    .truck-pin__bubble {
      width: 46px;
      height: 46px;
      border-radius: 16px 16px 12px 12px;
      background: linear-gradient(135deg, var(--pin-color), rgba(255, 255, 255, .25));
      border: 2px solid rgba(255, 255, 255, .9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--pin-label);
    }

    .truck-pin__pointer {
      width: 0;
      height: 0;
      border: 10px solid transparent;
      border-top-color: var(--pin-color);
      margin-top: -6px;
      filter: brightness(.95);
    }

    /* ================================
   ICON ‡∏ñ‡∏±‡∏á (Leaflet)
   ================================ */
    .leaflet-marker-icon.bin-icon {
      background: transparent;
      border: none;
    }

    .bin-pin {
      --pin-color: #16a34a;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      filter: drop-shadow(0 10px 20px rgba(15, 23, 42, .25));
    }

    .bin-pin__bubble {
      width: 46px;
      height: 46px;
      border-radius: 16px 16px 12px 12px;
      background: linear-gradient(135deg, var(--pin-color), rgba(255, 255, 255, .2));
      border: 2px solid rgba(255, 255, 255, .85);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #0f172a;
    }

    .bin-pin__pointer {
      width: 0;
      height: 0;
      border: 10px solid transparent;
      border-top-color: var(--pin-color);
      margin-top: -6px;
      filter: brightness(.9);
    }

    .bin-pin__label {
      font-size: 12px;
      font-weight: 600;
      color: #0f172a;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 999px;
      padding: 2px 8px;
      line-height: 1;
      box-shadow: 0 4px 10px rgba(15, 23, 42, .12);
    }

    .bin-pin__label.is-unknown {
      color: #475569;
      background: #f8fafc;
    }

    /* ================================
   Responsive ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô cards + map
   ================================ */
    @media(max-width:900px) {
      #map {
        height: 45vh;
      }

      .cards {
        gap: 8px;
      }

      .cards .card {
        flex: 0 0 calc(50% - 8px);
        max-width: calc(50% - 8px);
        padding: 10px 8px;
      }

      .cards .card h3 {
        font-size: 13px;
        margin-bottom: 3px;
      }

      .cards .card p {
        font-size: 16px;
      }
    }

    .sw-popup {
      border-radius: 14px !important;
      font-family: 'Prompt', sans-serif;
    }

    /* =========================
   Language Dropdown (Modern)
   ========================= */
    .lang-switcher {
      position: relative;
    }

    .lang-menu {
      position: absolute;
      top: 46px;
      right: 0;
      background: #ffffff;
      border-radius: 14px;
      padding: 6px;
      min-width: 180px;
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.18);
      display: none;
      z-index: 1200;
    }

    .lang-menu.show {
      display: block;
    }

    .lang-menu button {
      width: 100%;
      text-align: left;
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      background: transparent;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .lang-menu button:hover {
      background: #e0f2fe;
    }

    .lang-menu button:active {
      background: #bae6fd;
    }

    .lang-menu button.active {
      background: #e0f2fe;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <button class="toggle-btn" onclick="toggleMenu()"></button>

  <aside class="sidebar" id="sidebar">
    <h2 id="sidebarTitle"></h2>
    <nav class="menu" data-admin-menu data-active="truck"></nav>
    <div class="sw-logout-slot" data-sw-logout-slot></div>
  </aside>

  <main>
    <div class="topbar">
      <div>
        <h1 id="pageTitleHeading"></h1>
      </div>
      <div class="topbar-right">
        <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏©‡∏≤ -->
        <div class="lang-switcher">
          <button class="icon-btn" id="langIconBtn" type="button">
            <img src="images/lang-icon.png" alt="Language" class="top-icon">
          </button>
          <div class="lang-menu" id="langMenu">
            <button type="button" data-lang="th">‡πÑ‡∏ó‡∏¢</button>
            <button type="button" data-lang="en">English</button>
            <button type="button" data-lang="ms">Bahasa Melayu</button>
          </div>
          <select id="langSelect" style="display:none;">
            <option value="th">‡πÑ‡∏ó‡∏¢</option>
            <option value="en">English</option>
            <option value="ms">Bahasa Melayu</option>
          </select>
        </div>

        <!-- ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Firestore /users) -->
        <a href="profile.html" class="user-chip" id="profileBtn">
          <img src="images/profile-icon.png" alt="Profile" class="top-icon user-avatar">
          <div class="user-chip-text">
            <div class="user-chip-name" id="profileName">User Name</div>
            <div class="user-chip-role" id="profileRole">Role</div>
          </div>
        </a>
      </div>
    </div>

    <div class="content">
      <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏á -->
      <div class="cards">
        <div class="card">
          <h3 id="cardTotalTitle"></h3>
          <p id="totalBins">‚Äî</p>
        </div>
        <div class="card">
          <h3 id="cardMidTitle"></h3>
          <p id="onlineBins">‚Äî</p>
        </div>
        <div class="card">
          <h3 id="cardFullTitle"></h3>
          <p id="fullBins">‚Äî</p>
        </div>
        <div class="card">
          <h3 id="cardLowTitle"></h3>
          <p id="lowBins">‚Äî</p>
        </div>
      </div>

      <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô + ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏ñ + ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏ü‡∏Å‡∏±‡∏™ -->
      <div class="card">
        <div class="row">
          <div style="flex:1 1 260px">
            <label for="zoneFilter" id="zoneFilterLabel"></label>
            <div class="row">
              <select id="zoneFilter">
                <option value=""></option>
              </select>
              <button id="btnCreate" class="ghost">+ </button>
            </div>
            <p id="truckInfo" class="muted" style="margin-top:6px"></p>
          </div>

          <button id="btnCenter" class="ghost"></button>
        </div>
      </div>

      <!-- ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà -->
      <div id="map"></div>

      <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á -->
      <div class="card">
        <div class="row" style="justify-content: space-between; align-items:flex-end; gap:12px;">
          <div>
            <h3 id="usageTitle"></h3>
            <p class="muted" id="usageHint"></p>
          </div>
        </div>
        <p class="muted" id="usageStatus" style="margin-top:6px;"></p>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th id="usageThDate"></th>
                <th id="usageThZone"></th>
                <th id="usageThStart"></th>
                <th id="usageThEnd"></th>
                <th id="usageThDuration"></th>
                <th id="usageThLat"></th>
                <th id="usageThLng"></th>
              </tr>
            </thead>
            <tbody id="usageBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏î‡πâ‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà -->
  <div id="createOverlay" class="overlay" style="display:none;">
    <div id="createPanel" class="card overlay-card">
      <h3 id="createPanelTitle"></h3>

      <div class="row">
        <div>
          <label id="zoneSelectLabel"></label>
          <select id="truckZoneSelect">
            <option value=""></option>
          </select>
        </div>

      </div>

      <div class="row" style="margin-top:8px;">
        <div>
          <label id="truckIdLabel"></label>
          <input id="truckIdPreview" readonly />
        </div>
      </div>

      <div class="overlay-actions" style="margin-top:12px;">
        <button id="btnCancelCreate" class="ghost"></button>
        <button id="btnSaveTruck" type="button" class="primary"></button>
      </div>

    </div>
  </div>


  <script>

    const fs = firebase.firestore();

    /* Map */
    const start = [6.46007, 100.35933];
    const map = L.map('map', {
      preferCanvas: true
    }).setView(start, 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { maxZoom: 20, attribution: '&copy; OpenStreetMap' }).addTo(map);

    // markers: ‡∏£‡∏ñ + ‡∏ñ‡∏±‡∏á
    const truckMarkers = {};         // truckId -> marker
    const truckDocUnsubMap = {};     // truckId -> unsubscribe truck doc
    const truckRunsUnsubMap = {};    // truckId -> unsubscribe active runs
    const truckActiveMap = {};       // truckId -> bool

    const binMarkers = {};           // zone_binDocId -> marker
    let binsDataUnsub = null;        // listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö bin_data
    let binsDataState = {};          // docId -> {lat,lng,binId}
    let binsLevelState = {};   // mac -> fillLevel

    /* Dashboard realtime state */
    const dashboardState = {};       // zoneId -> { totalBins, levelByBin: {binKey:fill} }
    let dashboardUnsubs = [];
    let hasLiveFromRTDB = false;

    /* UI refs */
    const langIconBtn = document.getElementById("langIconBtn");
    const langMenu = document.getElementById("langMenu");
    const langSelect = document.getElementById('langSelect');
    const adminNameEl = document.getElementById('adminName');
    const adminAvatarEl = document.getElementById('adminAvatar');
    const adminRoleEl = document.getElementById('adminRole');

    const zoneFilter = document.getElementById('zoneFilter');
    const truckInfo = document.getElementById('truckInfo');
    const btnCreate = document.getElementById('btnCreate');
    const btnCenter = document.getElementById('btnCenter');

    // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏á
    const totalEl = document.getElementById('totalBins');
    const fullEl = document.getElementById('fullBins');
    const midEl = document.getElementById('onlineBins');
    const lowEl = document.getElementById('lowBins');

    // usage table
    const usageBody = document.getElementById('usageBody');
    const usageStatus = document.getElementById('usageStatus');

    // ‡πÅ‡∏ú‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ (overlay)
    const createOverlay = document.getElementById('createOverlay');
    const createPanel = document.getElementById('createPanel');
    const btnSaveTruck = document.getElementById('btnSaveTruck');
    const btnCancelCreate = document.getElementById('btnCancelCreate');

    // ===== Truck form elements =====
    const truckZoneSelect = document.getElementById("truckZoneSelect");
    const truckIdPreview = document.getElementById("truckIdPreview");


    const displayName =
      window.ADMIN_AUTH?.fullName ||
      window.ADMIN_AUTH?.username ||
      "-";

    if (adminNameEl) adminNameEl.textContent = displayName || "-";
    if (adminAvatarEl) adminAvatarEl.textContent =
      displayName ? displayName.charAt(0).toUpperCase() : "?";

    function lockBodyScroll(lock) {
      document.body.classList.toggle("modal-open", !!lock);
    }

    let currentUserProfile = null;
    /* ===== Language / i18n (SAFE VERSION ‡πÅ‡∏ö‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏ñ) ===== */
    const LangState = window.AdminLang;

    let currentLang =
      (LangState && typeof LangState.getLang === "function")
        ? LangState.getLang()
        : (localStorage.getItem("sw_lang") || "th");

    function t(key) {
      const dict =
        (window.SW_Translations && window.SW_Translations[currentLang]) ||
        (window.SW_Translations && window.SW_Translations.th) ||
        {};
      return dict[key] !== undefined ? dict[key] : key;
    }

    function setStatusForm(text, type) {
      if (typeof msg === "undefined" || !msg) return;
      msg.textContent = text || "";
      msg.className = "muted" + (type === "ok" ? " ok" : type === "err" ? " err" : "");
    }
    function setBinsStatus(text, type) {
      if (typeof binsStatusEl === "undefined" || !binsStatusEl) return;
      binsStatusEl.textContent = text || "";
      binsStatusEl.className = "muted" + (type === "ok" ? " ok" : type === "err" ? " err" : "");
    }
    function errStr(e) {
      return (e && (e.code ? e.code + ": " + (e.message || "") : (e.message || String(e)))) || "unknown";
    }

    /* ===== Helper ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤ / listener ===== */
    // ===== ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏£‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Firestore =====
    async function loadTodaySchedule(zoneId) {
      if (!zoneId) return null;

      const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

      const ref = fs
        .collection("truck_schedule")
        .doc(zoneId)
        .collection("days")
        .doc(today);

      const snap = await ref.get();
      if (!snap.exists) return null;

      return snap.data();
    }

    let usageUnsub = null;
    let currentZoneFilter = ""; // "" = ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï
    const ZONE_FILTER_KEY = "sw_admin_zone_filter";
    const warnedNoSchedule = {}; // truckId_YYYY-MM-DD => true
    let trucks = []; // {id, data}
    let isUsageTableControlledByFirestore = false;

    function formatDurationMs(ms) {
      const durSec = Math.max(0, Math.round(ms / 1000));
      const h = Math.floor(durSec / 3600);
      const m = Math.floor((durSec % 3600) / 60);
      const s = durSec % 60;

      return t('durationFormat')
        .replace('%h%', h)
        .replace('%m%', m)
        .replace('%s%', s);

    }

    function showUsageMessage(key) {
      usageBody.innerHTML = `
    <tr>
      <td colspan="7" class="muted">
        ${t(key)}
      </td>
    </tr>
  `;
      usageStatus.textContent = "";
    }

    function detachUsage() {
      if (typeof usageUnsub === 'function') {
        usageUnsub();
        usageUnsub = null;
      }
      isUsageTableControlledByFirestore = false; // ‚úÖ ‡∏õ‡∏•‡∏î lock
      hasLiveFromRTDB = false;
    }

    function getBinStatusColor(isOnline) {
      return isOnline ? "#16a34a" : "#94a3b8"; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß / ‡πÄ‡∏ó‡∏≤
    }

    /* ===== helper icon ‡∏£‡∏ñ‡πÅ‡∏ö‡∏ö‡∏ù‡∏±‡πà‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ===== */
    function buildTruckIcon(isActive) {
      const statusEmoji = isActive ? "üöõ" : "üöö";
      const color = isActive ? "#fb7185" : "#94a3b8";
      return L.divIcon({
        className: "truck-icon",
        html: `
          <div class="truck-pin" style="--pin-color:${color};">
            <div class="truck-pin__bubble">${statusEmoji}</div>
            <div class="truck-pin__pointer"></div>
          </div>
        `.trim(),
        iconSize: [50, 70],
        iconAnchor: [25, 55],
        popupAnchor: [0, -50]
      });
    }

    /* ===== ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏ã‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö filter ===== */
    async function loadZonesForFilter() {
      zoneFilter.innerHTML = `<option value="">(${t('zoneFilterAll')})</option>`;
      const snap = await fs.collection('zones').get();

      snap.forEach(doc => {
        const d = doc.data() || {};
        const opt = document.createElement('option');
        opt.value = doc.id;
        opt.textContent = d.name || doc.id;
        zoneFilter.appendChild(opt);
      });

      // ‚úÖ restore ‡πÇ‡∏ã‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏Ç‡πâ‡∏≠ 3)
      const saved = localStorage.getItem(ZONE_FILTER_KEY) || "";
      zoneFilter.value = saved;
      currentZoneFilter = saved;
    }

    /* ===== ‡πÇ‡∏´‡∏•‡∏î trucks + listeners ‡∏£‡∏ñ ===== */
    function clearTruckListenersAndMarkers() {
      Object.values(truckDocUnsubMap).forEach(fn => fn && fn());
      Object.values(truckRunsUnsubMap).forEach(fn => fn && fn());
    }

    async function loadTrucks() {
      clearTruckListenersAndMarkers();
      trucks = [];

      const zonesSnap = await fs.collection("trucks").get();

      for (const zoneDoc of zonesSnap.docs) {
        const zoneId = zoneDoc.id;

        const trucksSnap = await fs
          .collection("trucks")
          .doc(zoneId)
          .collection("vehicles")
          .get();

        trucksSnap.forEach(doc => {
          const d = doc.data() || {};
          const truckId = doc.id;

          trucks.push({
            id: truckId,
            data: {
              ...d,
              zone: zoneId // ‚úÖ ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏ã‡∏ô‡πÑ‡∏´‡∏ô
            }
          });
        });
      }

      // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á marker ‡πÉ‡∏´‡πâ‡∏£‡∏ñ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏±‡∏ô (‡∏Ç‡πâ‡∏≠ 1,2)
      trucks.forEach(tr => {
        const truckId = tr.id;

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ marker ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≤‡∏°
        if (truckMarkers[truckId]) return;

        // lat/lng ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å: (1) RTDB ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏à‡∏≥‡πÑ‡∏ß‡πâ (2) Firestore vehicles ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏Å‡πá‡∏ö
        const last = truckLastPosMap[truckId];
        const lat = (typeof last?.lat === "number") ? last.lat : tr.data.lat;
        const lng = (typeof last?.lng === "number") ? last.lng : tr.data.lng;

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏•‡∏¢ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á (‡∏£‡∏ñ‡∏à‡∏∞‡πÇ‡∏ú‡∏•‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠ RTDB ‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏°‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
        if (typeof lat !== "number" || typeof lng !== "number") return;

        const isActive = !!truckActiveMap[truckId]; // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå = false
        const marker = L.marker([lat, lng], { icon: buildTruckIcon(isActive) }).addTo(map);
        truckMarkers[truckId] = marker;

        marker.bindPopup(`<b>${truckId}</b><br>${t('truckInactiveLabel')}`);
      });

      // ‚úÖ ‡πÉ‡∏´‡πâ filter ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô marker ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      updateAllTruckMarkersVisibility();

      fitMapToAllMarkers();
      updateTruckInfoPanel();
    }

    function updateAllTruckMarkersVisibility() {
      trucks.forEach(tr => updateTruckMarkerVisibility(tr.id));
    }
    function updateTruckMarkerVisibility(truckId) {
      const marker = truckMarkers[truckId];
      if (!marker) return;

      const truck = trucks.find(tr => tr.id === truckId);
      if (!truck) return;

      const zoneId = truck.data.zone || "";
      const isActive = !!truckActiveMap[truckId];

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï icon ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ online/offline
      marker.setIcon(buildTruckIcon(isActive));

      const visible = !currentZoneFilter ? true : (zoneId === currentZoneFilter);

      if (visible) {
        if (!map.hasLayer(marker)) map.addLayer(marker);
      } else {
        if (map.hasLayer(marker)) map.removeLayer(marker);
      }
    }

    function updateTruckInfoPanel() {
      if (!currentZoneFilter) {
        const activeIds = Object.keys(truckActiveMap).filter(id => truckActiveMap[id]);
        if (!activeIds.length) {
          truckInfo.textContent = t('truckInfoAllNone');
        } else {
          truckInfo.innerHTML = t('truckInfoAllSome').replace('%count%', activeIds.length);
        }
        return;
      }

      const activeTrucks = trucks.filter(tr =>
        (tr.data.zone || "") === currentZoneFilter && !!truckActiveMap[tr.id]
      );

      if (!activeTrucks.length) {
        truckInfo.textContent = t('truckInfoZoneNoTruck');
        return;
      }

      const truck = activeTrucks[0];
      const d = truck.data;
      const isActive = !!truckActiveMap[truck.id];
      const updatedStr = d.updatedAt && d.updatedAt.toDate
        ? d.updatedAt.toDate().toLocaleString()
        : t('dashPlaceholder');

      const base = t('truckInfoText')
        .replace('%id%', d.truckId || truck.id)
        .replace('%zone%', d.zoneName || d.zone || currentZoneFilter)
        .replace('%name%', d.name || t('dashPlaceholder'))
        .replace('%updatedAt%', updatedStr);

      const statusLabel = isActive ? t('truckActiveLabel') : t('truckInactiveLabel');
      truckInfo.innerHTML = `${base} ‚Ä¢ <span class="ok">${statusLabel}</span>`;
    }

    /* ===== ‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (realtime ‡∏à‡∏≤‡∏Å bin_data + bin_level) ===== */
    function clearBinMarkers() {
      if (binsDataUnsub) {
        binsDataUnsub();
        binsDataUnsub = null;
      }

      Object.values(binMarkers).forEach(m => {
        if (map.hasLayer(m)) map.removeLayer(m);
      });
      for (const k in binMarkers) delete binMarkers[k];
      binsDataState = {};
    }

    function redrawBinMarkers(zoneId) {
      // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå marker ‡πÄ‡∏î‡∏¥‡∏°
      Object.values(binMarkers).forEach(m => {
        if (map.hasLayer(m)) map.removeLayer(m);
      });
      for (const k in binMarkers) delete binMarkers[k];

      const NOW = Date.now();
      const ONLINE_TIMEOUT = 30000;

      Object.entries(binsDataState).forEach(([binId, info]) => {
        const levelInfo = binsLevelState[info.mac];
        const fill =
          typeof levelInfo?.fillLevel === "number"
            ? levelInfo.fillLevel
            : null;

        const isOnline =
          levelInfo && (NOW - levelInfo.lastUpdate <= ONLINE_TIMEOUT);

        const color = getBinStatusColor(isOnline);

        // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á icon ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏™‡∏î‡∏á % ‡∏ó‡∏µ‡πà marker
        const icon = L.divIcon({
          className: "bin-icon",
          html: `
        <div class="bin-pin" style="--pin-color:${color};">
          <div class="bin-pin__bubble">üóëÔ∏è</div>
          <div class="bin-pin__pointer"></div>
          <div class="bin-pin__label ${isOnline ? "" : "is-unknown"}">
            ${fill !== null ? fill + "%" : t('dashPlaceholder')}
          </div>
        </div>
      `,
          iconSize: [50, 64],
          iconAnchor: [25, 52],
          popupAnchor: [0, -48]
        });

        const marker = L.marker([info.lat, info.lng], { icon })
          .bindPopup(
            `${t('mapPopupBin')}<br>` +
            (isOnline ? t('statusOnline') : t('statusOffline')) +
            (fill !== null ? `<br>${t('binLevel')} ${fill}%` : "")
          );

        marker.addTo(map);
        binMarkers[zoneId + "_" + binId] = marker;
      });

      fitMapToAllMarkers();
    }

    function setupBinsForZone(zoneId) {
      clearBinMarkers();
      if (!zoneId) return;

      const dataRef = fs.collection('smartbins')
        .doc(zoneId)
        .collection('bin_data');

      binsDataState = {};   // binId -> { lat, lng, mac }

      // ‚úÖ ‡∏ü‡∏±‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Firestore
      binsDataUnsub = dataRef.onSnapshot(snap => {
        const newState = {};
        snap.forEach(doc => {
          const d = doc.data() || {};
          if (d.isHidden || d.deletedAt) return;
          if (!d.macAddress) return;

          newState[d.binId || doc.id] = {
            lat: d.lat,
            lng: d.lng,
            mac: d.macAddress
          };
        });

        binsDataState = newState;
        redrawBinMarkers(zoneId);
      });
    }

    let fitTimeout;
    function fitMapToAllMarkers() {
      clearTimeout(fitTimeout);
      fitTimeout = setTimeout(() => {
        const ms = [];
        Object.values(truckMarkers).forEach(m => map.hasLayer(m) && ms.push(m));
        Object.values(binMarkers).forEach(m => map.hasLayer(m) && ms.push(m));

        if (ms.length) {
          const group = L.featureGroup(ms);
          map.fitBounds(group.getBounds().pad(0.15));
        }
        map.invalidateSize();
      }, 200);
    }

    /* ===== RTDB Realtime Listener (fillLevel) ===== */
    const rtdbRef = firebase.database().ref("esp32_devices");

    rtdbRef.on("value", snap => {
      const devices = snap.val() || {};

      binsLevelState = {};
      Object.entries(devices).forEach(([mac, d]) => {
        if (typeof d?.fillLevel === "number") {
          binsLevelState[mac] = {
            fillLevel: d.fillLevel,
            lastUpdate: d.lastUpdate || 0
          };
        }
      });

      if (currentZoneFilter) {
        redrawBinMarkers(currentZoneFilter);
      }

      recomputeDashboard();
    });

    function getTruckForZone(zoneId) {
      return trucks.find(tr => tr.data.zone === zoneId) || null;
    }

    /* ===== Dashboard ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏á (realtime) ===== */
    function recomputeDashboard() {
      let total = 0;
      let online = 0;
      let full = 0;
      let normal = 0;

      const NOW = Date.now();
      const ONLINE_TIMEOUT = 30000; // 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå

      Object.values(dashboardState).forEach(zone => {
        total += zone.totalBins || 0;

        zone.macList.forEach(mac => {
          const info = binsLevelState[mac];
          if (!info) return;

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ï‡∏≠‡∏ô‡πÑ‡∏´‡∏ô
          const isOnline = (NOW - info.lastUpdate) <= ONLINE_TIMEOUT;

          if (isOnline) {
            online++;
            if (info.fillLevel >= 80) {
              full++;
            } else {
              normal++;
            }
          }
        });
      });

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI (‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
      if (totalEl) totalEl.textContent = total ?? t('dashPlaceholder');
      fullEl.textContent = full ?? t('dashPlaceholder');
      midEl.textContent = online ?? t('dashPlaceholder');
      lowEl.textContent = normal ?? t('dashPlaceholder');
    }

    async function setupDashboardListeners() {
      dashboardUnsubs.forEach(fn => fn && fn());
      dashboardUnsubs = [];

      const zonesSnap = await fs.collection("zones").get();

      // 1Ô∏è‚É£ ‡∏î‡∏∂‡∏á bin_data ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏µ‡πà‡∏ñ‡∏±‡∏á + mac ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á
      zonesSnap.forEach(zDoc => {
        const zoneId = zDoc.id;
        dashboardState[zoneId] = {
          totalBins: 0,
          macList: [],
          levelByMac: {}
        };

        const unsub = fs.collection("smartbins")
          .doc(zoneId)
          .collection("bin_data")
          .onSnapshot(snap => {
            let count = 0;
            const macs = [];
            snap.forEach(doc => {
              const d = doc.data() || {};
              if (d.isHidden === true || d.deletedAt) return;
              if (!d.macAddress) return;
              count++;
              macs.push(d.macAddress);
            });
            dashboardState[zoneId].totalBins = count;
            dashboardState[zoneId].macList = macs;
            recomputeDashboard();
          });

        dashboardUnsubs.push(unsub);
      });
    }

    /* ===== ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤ ===== */
    function applyLanguage() {

      // ‚ùå ‡πÑ‡∏°‡πà set role ‡πÄ‡∏≠‡∏á
      // ‚úÖ ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ AdminProfile / AdminUser ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£

      document.title = t('pageTitle_truck');
      document.querySelector('.toggle-btn').textContent = t('menuBtn');

      if (window.AdminNav?.setLanguage) {
        window.AdminNav.setLanguage(currentLang);
      }
      if (window.AdminUser?.setLanguage) {
        window.AdminUser.setLanguage(currentLang);
      }
      if (window.AdminProfile?.setLanguage) {
        window.AdminProfile.setLanguage(currentLang);
      }

      document.getElementById('pageTitleHeading').textContent = t('mainTitle_truck');


      const truckIdLabelEl = document.getElementById('truckIdLabel');
      if (truckIdLabelEl) truckIdLabelEl.textContent = t('truckIdLabel');

      if (truckIdPreview) {
        truckIdPreview.placeholder = t('truckIdPlaceholder');
      }

      const sidebarTitleEl = document.getElementById('sidebarTitle');
      if (sidebarTitleEl) sidebarTitleEl.textContent = t('sidebarTitle');

      const langBtn = document.getElementById("langIconBtn");
      if (langBtn) {
        langBtn.setAttribute("aria-label", t("ariaChangeLanguage"));
      }

      document.title = t('pageTitle_truck');
      document.querySelector('.toggle-btn').textContent = t('menuBtn');

      if (window.AdminNav) {
        window.AdminNav.setLanguage(currentLang);
      }

      if (window.AdminUser) {
        window.AdminUser.setLanguage(currentLang);
      }

      document.getElementById('pageTitleHeading').textContent = t('mainTitle_truck');

      // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏á
      document.getElementById('cardTotalTitle').textContent = t('cardTotal');
      document.getElementById('cardFullTitle').textContent = t('cardFull');
      document.getElementById('cardMidTitle').textContent = t('cardMid');
      document.getElementById('cardLowTitle').textContent = t('cardLow');

      // filter zone
      document.getElementById('zoneFilterLabel').textContent = t('zoneFilterLabel');
      if (zoneFilter.options.length > 0) {
        zoneFilter.options[0].textContent = `(${t('zoneFilterAll')})`;
      }
      btnCreate.textContent = t('createTruckBtn');
      btnCenter.textContent = t('focusBtn');

      // usage
      document.getElementById('usageTitle').textContent = t('usageTitle');
      document.getElementById('usageHint').textContent = t('usageHint');
      const monthLabel = document.getElementById('monthSelectLabel');
      if (monthLabel) {
        monthLabel.textContent = t('monthSelectLabel');
      }
      document.getElementById('usageThDate').textContent = t('usageThDate');
      document.getElementById('usageThStart').textContent = t('usageThStart');
      document.getElementById('usageThEnd').textContent = t('usageThEnd');
      document.getElementById('usageThDuration').textContent = t('usageThDuration');
      document.getElementById('usageThLat').textContent = t('usageThLat');
      document.getElementById('usageThLng').textContent = t('usageThLng');

      // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÇ‡∏ã‡∏ô
      const zoneTh = document.getElementById('usageThZone');
      if (zoneTh) zoneTh.textContent = t('usageThZone');

      document.getElementById('usageThStart').textContent = t('usageThStart');
      document.getElementById('usageThEnd').textContent = t('usageThEnd');
      document.getElementById('usageThDuration').textContent = t('usageThDuration');
      document.getElementById('usageThLat').textContent = t('usageThLat');
      document.getElementById('usageThLng').textContent = t('usageThLng');

      // overlay ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ
      const createTitleEl = document.getElementById('createPanelTitle');
      const zoneSelectLabelEl = document.getElementById('zoneSelectLabel');
      if (createTitleEl) createTitleEl.textContent = t('createPanelTitle');
      if (zoneSelectLabelEl) zoneSelectLabelEl.textContent = t('zoneSelectLabel');
      if (btnSaveTruck) btnSaveTruck.textContent = t('saveTruckBtn');
      if (btnCancelCreate) btnCancelCreate.textContent = t('cancelTruckBtn');
      if (truckZoneSelect && truckZoneSelect.options.length > 0) {
        truckZoneSelect.options[0].textContent = t('selectZoneDefault');
      }

      if (!currentZoneFilter) {
        truckInfo.textContent = t('noZoneSelected');
      }

      // ‡∏õ‡∏£‡∏±‡∏ö popup ‡∏£‡∏ñ/‡∏ñ‡∏±‡∏á‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤
      // Object.entries(truckMarkers).forEach(([id, m]) => {
      //   const isActive = !!truckActiveMap[id];
      //   m.bindPopup(isActive ? t('mapPopupTruckActive') : t('mapPopupTruckInactive'));
      // });
      updateTruckInfoPanel();
    }

    function changeLanguage(lang) {
      if (window.SW_Translations && window.SW_Translations[lang]) {
        currentLang = lang;
        localStorage.setItem("sw_lang", lang);

        if (LangState && typeof LangState.setLang === "function") {
          LangState.setLang(lang);
        }

        // ‚úÖ highlight ‡∏†‡∏≤‡∏©‡∏≤‡πÉ‡∏ô dropdown
        document
          .querySelectorAll("#langMenu button")
          .forEach(b => b.classList.toggle("active", b.dataset.lang === lang));

        langSelect.value = currentLang;
        applyLanguage();
      }
    }

    langSelect.addEventListener("change", e => changeLanguage(e.target.value));
    langSelect.value = currentLang;

    langIconBtn.addEventListener("click", () => {
      langMenu.classList.toggle("show");
    });

    langMenu.addEventListener("click", e => {
      const btn = e.target.closest("button[data-lang]");
      if (!btn) return;
      changeLanguage(btn.dataset.lang);
      langMenu.classList.remove("show");
    });

    if (LangState && typeof LangState.onChange === "function") {
      LangState.onChange(lang => {
        if (lang && lang !== currentLang) {
          currentLang = lang;
          langSelect.value = lang;
          applyLanguage();
        }
      });
    }

    // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏†‡∏≤‡∏©‡∏≤ (‡πÑ‡∏°‡πà‡∏¢‡∏∏‡πà‡∏á‡∏Å‡∏±‡∏ö sidebar ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ä‡πâ backdrop ‡πÅ‡∏•‡πâ‡∏ß)
    document.addEventListener("click", e => {
      const clickedInLang = langMenu.contains(e.target) || langIconBtn.contains(e.target);
      if (!clickedInLang) langMenu.classList.remove("show");
    });

    async function loadZonesForTruckForm() {
      truckZoneSelect.innerHTML = `<option value="">${t('selectZoneDefault')}</option>`;
      const snap = await fs.collection("zones").get();
      snap.forEach(doc => {
        const opt = document.createElement("option");
        opt.value = doc.id;
        opt.textContent = doc.data().name || doc.id;
        truckZoneSelect.appendChild(opt);
      });
    }

    async function generateTruckId(zoneId, zoneName) {
      // ‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô (Yala -> Y)
      const Z = (zoneName || zoneId).charAt(0).toUpperCase();
      const prefix = `TRUCK_${Z}`;

      // üîé ‡∏´‡∏≤ truck ‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ TRUCK_Y
      const snap = await fs.collection("trucks")
        .doc(zoneId)
        .collection("vehicles")
        .get();

      let max = 0;
      snap.forEach(doc => {
        const id = doc.id; // TRUCK_Y001
        const m = id.match(/(\d{3})$/);
        if (m) max = Math.max(max, parseInt(m[1], 10));
      });

      return prefix + String(max + 1).padStart(3, "0");
    }

    async function refreshTruckIdPreview() {
      const zoneId = truckZoneSelect.value;
      if (!zoneId) {
        truckIdPreview.value = "";
        return;
      }

      const zoneName =
        truckZoneSelect.options[truckZoneSelect.selectedIndex].text;

      const id = await generateTruckId(zoneId, zoneName);
      truckIdPreview.value = id;
    }

    truckZoneSelect.addEventListener("change", refreshTruckIdPreview);

    function openCreateOverlay() {
      createOverlay.style.display = 'flex';
      createPanel.style.animation = 'none';
      void createPanel.offsetWidth;
      createPanel.style.animation = '';
    }

    function closeCreateOverlay() {
      createOverlay.style.display = 'none';
    }

    btnCreate.addEventListener('click', async () => {
      openCreateOverlay();
      await loadZonesForTruckForm();
      applyLanguage();
    });

    btnCancelCreate.addEventListener('click', () => {
      closeCreateOverlay();
    });

    createOverlay.addEventListener('click', (e) => {
      if (e.target === createOverlay) {
        closeCreateOverlay();
      }
    });

    btnSaveTruck.addEventListener("click", async () => {
      const truckId = truckIdPreview.value;
      if (!truckId) {
        Swal.fire({
          icon: "warning",
          title: t('pleaseSelectZone'),
          confirmButtonText: "OK",
          customClass: {
            popup: "sw-popup"
          },
          didOpen: () => {
            const c = document.querySelector('.swal2-container');
            if (c) c.style.zIndex = 2000;
          }
        });
        return;
      }

      const zoneId = truckZoneSelect.value;
      const zoneName =
        truckZoneSelect.options[truckZoneSelect.selectedIndex].text;

      await fs
        .collection("trucks")
        .doc(zoneId)
        .collection("vehicles")
        .doc(truckId)
        .set({
          truckId,
          zone: zoneId,
          zoneName,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

      closeCreateOverlay();
      await loadTrucks();
    });

    /* ===== ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏ã‡∏ô filter ===== */
    zoneFilter.addEventListener('change', () => {
      currentZoneFilter = zoneFilter.value || "";
      localStorage.setItem(ZONE_FILTER_KEY, currentZoneFilter); // ‚úÖ ‡∏à‡∏≥‡πÇ‡∏ã‡∏ô
      usageBody.innerHTML = `<tr><td colspan="6" class="muted">${t('loading')}</td></tr>`;

      updateAllTruckMarkersVisibility();
      updateTruckInfoPanel();

      if (currentZoneFilter) setupBinsForZone(currentZoneFilter);
      else clearBinMarkers();

      updateUsageTableVisibility(); // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ô‡∏µ‡πâ
    });

    /* ===== ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ===== */
    btnCenter.addEventListener('click', () => {
      fitMapToAllMarkers();
    });

    window.addEventListener('beforeunload', () => {
      clearBinMarkers();
      clearTruckListenersAndMarkers();
      dashboardUnsubs.forEach(fn => fn && fn());
    });

    /* ===== ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π 3 ‡∏Ç‡∏µ‡∏î ===== */
    function toggleMenu() {
      const sidebar = document.getElementById('sidebar');
      const btn = document.querySelector('.toggle-btn');
      const isShow = sidebar.classList.toggle('show');

      if (window.innerWidth <= 900) {
        btn.style.display = isShow ? 'none' : 'block';
      }

      // ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Leaflet ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà
      setTimeout(() => {
        map.invalidateSize();
      }, 300);
    }

    window.toggleMenu = toggleMenu;

    document.addEventListener('click', (e) => {
      const sidebar = document.getElementById('sidebar');
      const btn = document.querySelector('.toggle-btn');
      if (!sidebar.contains(e.target) && e.target !== btn && window.innerWidth <= 900) {
        sidebar.classList.remove('show');
        btn.style.display = 'block';
      }
    });

    window.addEventListener('resize', () => {
      const sidebar = document.getElementById('sidebar');
      const btn = document.querySelector('.toggle-btn');

      if (window.innerWidth > 900) {
        sidebar.classList.remove('show');
        btn.style.display = 'none';
      } else {
        sidebar.classList.remove('show');
        btn.style.display = 'block';
      }

      // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å
      setTimeout(() => {
        map.invalidateSize();
      }, 200);
    });

    const truckServerDeltaMap = {}; // truckId -> (serverLastUpdate - clientNow)
    const truckLastPosMap = {}; // truckId -> {lat,lng}

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Realtime ‡∏à‡∏≤‡∏Å driver_live ---
    function setupDriverLiveListener() {
      const liveRef = firebase.database().ref("driver_live");

      function handleDriverItem(driverKey, data) {
        if (!data) return;

        const truckId = data.truckId;
        const zoneFromRTDB = data.zoneId || data.zone || "";
        if (!truckId) return;

        // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö delta (‡∏ó‡∏≥‡πÉ‡∏´‡πâ ticker ‡∏ß‡∏¥‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ)
        const lastUpdate =
          (typeof data.lastUpdate === "number") ? data.lastUpdate :
            (typeof data.updatedAt === "number") ? data.updatedAt :
              Date.now();

        truckServerDeltaMap[truckId] = lastUpdate - Date.now();

        // ====== ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô "‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" ======
        if (truckId && zoneFromRTDB) {
          const today = new Date().toISOString().slice(0, 10);
          const warnKey = `${truckId}_${today}`;

          if (!warnedNoSchedule[warnKey]) {
            loadTodaySchedule(zoneFromRTDB).then(schedule => {
              const isWorking = data.isWorking === true || data.isworking === true;
              if (!schedule && isWorking) {
                warnedNoSchedule[warnKey] = true;
                Swal.fire({
                  icon: "warning",
                  title: t('noScheduleTitle'),
                  text: t('noScheduleText'),
                });
              }
            });
          }
        }

        const isActive = data.isWorking === true || data.isworking === true;
        truckActiveMap[truckId] = isActive;

        // sync zone ‡πÄ‡∏Ç‡πâ‡∏≤ trucks[] (‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å RTDB)
        const truckObj = trucks.find(tr => tr.id === truckId);
        if (truckObj && zoneFromRTDB) truckObj.data.zone = zoneFromRTDB;

        // ‚úÖ ‡∏à‡∏≥‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÉ‡∏ä‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á marker ‡πÉ‡∏´‡πâ‡∏£‡∏ñ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏ï‡∏≠‡∏ô loadTrucks)
        if (typeof data.lat === "number" && typeof data.lng === "number") {
          truckLastPosMap[truckId] = { lat: data.lat, lng: data.lng };
        }

        // create/get marker (online)
        let marker = truckMarkers[truckId];
        if (!marker) {
          if (typeof data.lat !== "number" || typeof data.lng !== "number") return;
          marker = L.marker([data.lat, data.lng], { icon: buildTruckIcon(isActive) }).addTo(map);
          truckMarkers[truckId] = marker;
        }

        // update position
        if (typeof data.lat === "number" && typeof data.lng === "number") {
          marker.setLatLng([data.lat, data.lng]);
        }

        marker.setIcon(buildTruckIcon(isActive));
        updateTruckMarkerVisibility(truckId);

        const popupHtml =
          `<b>${data.driverName || '-'}</b><br>` +
          (isActive ? t('truckActiveLabel') : t('truckInactiveLabel'));

        if (marker.getPopup()) marker.getPopup().setContent(popupHtml);
        else marker.bindPopup(popupHtml);

        updateLiveTimerInTable(truckId, data);
        updateUsageTableVisibility();
        updateTruckInfoPanel(); // ‡πÉ‡∏´‡πâ panel ‡∏ó‡∏±‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
      }

      liveRef.on("child_added", (snap) => handleDriverItem(snap.key, snap.val()));
      liveRef.on("child_changed", (snap) => handleDriverItem(snap.key, snap.val()));

      liveRef.on("child_removed", (snap) => {
        const data = snap.val() || {};
        const truckId = data.truckId;
        if (!truckId) return;

        truckActiveMap[truckId] = false;
        updateTruckMarkerVisibility(truckId);
        updateTruckInfoPanel();

        // ‡∏õ‡∏¥‡∏î live row ‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á
        const tr = usageBody.querySelector(`tr[data-truck="${truckId}"]`);
        if (tr && tr.dataset.live === "1") {
          tr.dataset.live = "0";
          const durEl = tr.querySelector(".dur");
          if (durEl) durEl.dataset.live = "0";
        }
      });
    }

    function startLiveDurationTicker() {
      if (window.__LIVE_DURATION_TICK__) return;

      window.__LIVE_DURATION_TICK__ = setInterval(() => {
        document.querySelectorAll('#usageBody tr[data-live="1"][data-source="rtdb"]').forEach(row => {
          const truckId = row.dataset.truck;
          const durEl = row.querySelector(".dur");
          if (!durEl) return;

          // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á dataset ‡πÅ‡∏•‡∏∞ attribute ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡πà‡∏≤
          const startMs = Number(durEl.dataset.liveStartMs || durEl.getAttribute("data-live-start-ms") || "0");
          const baseSec = Number(durEl.dataset.baseSec || durEl.getAttribute("data-base-sec") || "0");
          if (!startMs) return;

          // ‚úÖ ‡πÉ‡∏ä‡πâ delta ‡∏ó‡∏≥‡πÉ‡∏´‡πâ "‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏¥‡πà‡∏á‡∏ï‡πà‡∏≠" ‡∏≠‡∏¥‡∏á RTDB ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
          const delta = truckServerDeltaMap[truckId] || 0;
          const nowAdjusted = Date.now() + delta;

          const totalMs = baseSec * 1000 + Math.max(0, nowAdjusted - startMs);
          durEl.textContent = formatDurationMs(totalMs);
        });
      }, 1000);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    function updateLiveTimerInTable(truckId, data) {
      console.log("üßæ updateLiveTimerInTable", {
        truckId,
        startAt: data.startAt,
        isWorking: data.isWorking,
        isworking: data.isworking,
        isFinished: data.isFinished,
        finishedAt: data.finishedAt
      });

      const zoneFromRTDB = data.zoneId || data.zone || "";
      const zoneFromFS = trucks.find(t => t.id === truckId)?.data?.zone || "";
      const zoneResolved = zoneFromRTDB || zoneFromFS || "";

      // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‚Üí ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏ñ‡πÇ‡∏ã‡∏ô‡∏≠‡∏∑‡πà‡∏ô
      if (currentZoneFilter && zoneResolved !== currentZoneFilter) return;

      const tbody = usageBody;
      let row = tbody.querySelector(`tr[data-truck="${truckId}"]`);

      let startMs =
        (typeof data.startAt === "number") ? data.startAt :
          (typeof data.lastStartAt === "number") ? data.lastStartAt :
            (typeof data.startAtMillis === "number") ? data.startAtMillis :
              null;

      // ‚úÖ ‡∏ñ‡πâ‡∏≤ RTDB ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á startAt ‡∏ï‡∏≠‡∏ô‡∏à‡∏ö‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß
      if (!startMs && row && row.dataset.lastStartAt) {
        startMs = Number(row.dataset.lastStartAt);
      }

      // ‚úÖ fallback ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ finishedAt + baseElapsedSec ‡∏Å‡πá‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏≤ start ‡πÑ‡∏î‡πâ
      if (!startMs && typeof data.finishedAt === "number" && typeof data.baseElapsedSec === "number") {
        startMs = data.finishedAt - (data.baseElapsedSec * 1000);
      }

      if (!startMs) {
        console.warn("‚õî ‡πÑ‡∏°‡πà‡∏°‡∏µ startAt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö", truckId, data);
        return;
      }

      // ====== ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ======
      if (!row) {
        row = document.createElement("tr");
        row.dataset.truck = truckId;
        row.dataset.live = "1";
        row.dataset.source = "rtdb";
        row.dataset.persisted = "0";
        row.dataset.lastStartAt = String(startMs);

        const baseSecInit =
          (typeof data.baseElapsedSec === "number") ? data.baseElapsedSec : 0;

        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÇ‡∏ã‡∏ô
        row.innerHTML = `
      <td>${new Date().toLocaleDateString()}</td>
      <td class="zone">${zoneResolved || t('dashPlaceholder')}</td>
      <td>${new Date(startMs).toLocaleTimeString()}</td>
      <td class="end">${t('dashPlaceholder')}</td>

      <td class="dur"
          data-live="1"
          data-live-start-ms="${startMs}"
          data-base-sec="${baseSecInit}">
        ${formatDurationMs(baseSecInit * 1000)}
      </td>

      <td class="lat">${t('dashPlaceholder')}</td>
      <td class="lng">${t('dashPlaceholder')}</td>
    `;

        // ‡∏•‡∏ö placeholder row ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà
        const firstRow = tbody.querySelector("tr");
        if (firstRow && !firstRow.dataset.truck) firstRow.remove();

        tbody.appendChild(row);
      }

      // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ã‡∏ô‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ RTDB ‡∏°‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
      const zoneCell = row.querySelector(".zone");
      if (zoneCell) zoneCell.textContent = zoneResolved || t('dashPlaceholder');

      // ‡∏ñ‡πâ‡∏≤ startAt ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà) ‚Üí ‡∏õ‡∏•‡∏î persisted
      if (row.dataset.lastStartAt !== String(startMs)) {
        row.dataset.persisted = "0";
        row.dataset.lastStartAt = String(startMs);
      }

      // ====== ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà ======
      const working = data.isWorking === true || data.isworking === true;

      if (working) {
        row.dataset.live = "1";
        row.dataset.source = "rtdb";
        row.dataset.persisted = "0";

        row.querySelector(".end").textContent = t('dashPlaceholder');
        row.querySelector(".lat").textContent = t('dashPlaceholder');
        row.querySelector(".lng").textContent = t('dashPlaceholder');

        const baseSec =
          (typeof data.baseElapsedSec === "number") ? data.baseElapsedSec : 0;

        const durEl = row.querySelector(".dur");
        durEl.dataset.live = "1";
        durEl.dataset.liveStartMs = String(startMs);
        durEl.dataset.baseSec = String(baseSec);

        return;
      }

      // ====== ‡∏ñ‡πâ‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ======
      const endMs =
        (typeof data.finishedAt === "number") ? data.finishedAt :
          (typeof data.stoppedAt === "number") ? data.stoppedAt :
            Date.now();

      const finishedFlag =
        data.isFinished === true ||
        data.isFinished === "true" ||
        (typeof data.finishedAt === "number");

      if (!finishedFlag) {
        console.log("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏à‡∏£‡∏¥‡∏á (skip persist)", truckId, data);
        return;
      }

      const baseSec =
        (typeof data.baseElapsedSec === "number") ? data.baseElapsedSec :
          (typeof data.totalSeconds === "number") ? data.totalSeconds :
            null;

      const durationSec = baseSec !== null
        ? baseSec
        : Math.max(0, Math.round((endMs - startMs) / 1000));

      const endLat = (typeof data.lat === "number") ? data.lat : null;
      const endLng = (typeof data.lng === "number") ? data.lng : null;

      // ‡∏Å‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡πâ‡∏≥
      if (row.dataset.persisted !== "1") {
        row.dataset.persisted = "1";

        const zoneId = zoneResolved;
        if (!zoneId) {
          console.warn("‚õî zoneId ‡∏ß‡πà‡∏≤‡∏á ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Firestore ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", data);
        } else {
          const dateKey = new Date().toISOString().slice(0, 10);

          const docRef = fs.collection("trucks")
            .doc(zoneId)
            .collection("vehicles")
            .doc(truckId)
            .collection("truck_operating_time")
            .doc(dateKey);

          docRef.set({
            driverId: data.driverId || null,
            driverName: data.driverName || null,
            truckId: truckId,
            zone: zoneId,
            zoneName: zoneId,

            lat: endLat,
            lng: endLng,

            startAt: firebase.firestore.Timestamp.fromMillis(startMs),
            endAt: firebase.firestore.Timestamp.fromMillis(endMs),

            totalSeconds: durationSec,

            isFinished: true,
            finishedAt: firebase.firestore.Timestamp.fromMillis(endMs),

            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true })
            .then(() => console.log("‚úÖ persisted stop:", truckId, dateKey))
            .catch(err => console.error("‚ùå persist stop failed:", err));
        }
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      row.dataset.live = "0";
      const durEl = row.querySelector(".dur");
      durEl.dataset.live = "0";
      row.querySelector(".end").textContent = new Date(endMs).toLocaleTimeString();
      durEl.textContent = formatDurationMs(durationSec * 1000);

      if (typeof endLat === "number" && typeof endLng === "number") {
        row.querySelector(".lat").textContent = endLat.toFixed(6);
        row.querySelector(".lng").textContent = endLng.toFixed(6);
      } else {
        row.querySelector(".lat").textContent = t('dashPlaceholder');
        row.querySelector(".lng").textContent = t('dashPlaceholder');
      }
    }

    function updateUsageTableVisibility() {
      document.querySelectorAll('#usageBody tr[data-truck]').forEach(tr => {
        const truckId = tr.dataset.truck;

        const fromFS = trucks.find(t => t.id === truckId)?.data?.zone || "";
        const fromRow = tr.querySelector(".zone")?.textContent || "";
        const zoneResolved = fromFS || fromRow || "";

        if (!currentZoneFilter) {
          tr.style.display = "";
        } else {
          tr.style.display = (zoneResolved === currentZoneFilter) ? "" : "none";
        }
      });
    }

    function startNoScheduleDailyReset() {
      if (window.__LIVE_TICKER__) return;
      window.__LIVE_TICKER__ = setInterval(() => {
        const today = new Date().toISOString().slice(0, 10);
        Object.keys(warnedNoSchedule).forEach(k => {
          if (!k.endsWith(today)) delete warnedNoSchedule[k];
        });
      }, 60 * 1000);

    }
    let shownOfflineAlert = false;

    firebase.firestore().onSnapshotsInSync(() => {
      // Firestore ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß
      shownOfflineAlert = false;
    });

    (async function init() {
      document
        .querySelectorAll("#langMenu button")
        .forEach(b => b.classList.toggle("active", b.dataset.lang === currentLang));

      langSelect.value = currentLang;
      await loadZonesForFilter();
      await loadTrucks();
      await setupDashboardListeners(); // ‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö realtime ‡πÅ‡∏ó‡∏ô updateDashboard ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
      setupDriverLiveListener();
      startNoScheduleDailyReset();
      startLiveDurationTicker();
      applyLanguage();
      // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï ‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ
    })();
  </script>
</body>

</html>