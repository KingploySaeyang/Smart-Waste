<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title></title>
  <link rel="stylesheet" href="a_style.css">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    /* -------- Firebase -------- */
    var firebaseConfig = {
      apiKey: "AIzaSyCyTSsRmX642krpJYOI-TfFpIhnxJBbzxk",
      authDomain: "smart-waste2568.firebaseapp.com",
      projectId: "smart-waste2568",
      storageBucket: "smart-waste2568.firebasestorage.app",
      messagingSenderId: "122699752010",
      appId: "1:122699752010:web:c22ab9b28ac15beaedbcb3",
      measurementId: "G-H82914YP66",
      // üö® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ (‡∏Å‡πä‡∏≠‡∏õ URL ‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Realtime Database ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
      databaseURL: "https://smart-waste2568-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

  </script>
  <!-- Auth + ‡πÄ‡∏°‡∏ô‡∏π -->
  <script src="../Login/auth.js"></script>
  <script src="admin-lang.js"></script>
  <script src="../i18n/lang.js"></script>
  <script src="../i18n/th.js"></script>
  <script src="../i18n/en.js"></script>
  <script src="../i18n/ms.js"></script>
  <script src="admin-user.js" defer></script>
  <script src="admin-nav.js" defer></script>
  <script src="admin-profile.js" defer></script>
  <script src="admin-auth-bootstrap.js" defer></script>

</head>

<body>

  <button id="menuToggle" class="toggle-btn"></button>

  <aside class="sidebar" id="sidebar">
    <h2>Smart Waste</h2>
    <nav class="menu" data-admin-menu data-active="schedule"></nav>
    <div class="sw-logout-slot" data-sw-logout-slot></div>
  </aside>
  <!-- ‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á sidebar ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ -->
  <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

  <main>

    <div class="topbar">
      <div>
        <h1 id="mainTitle"></h1>
      </div>
      <div class="topbar-right">
        <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏©‡∏≤ -->
        <div class="lang-switcher">
          <button class="icon-btn" id="langIconBtn" type="button" aria-label="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤">
            <img src="images/lang-icon.png" alt="Language" class="top-icon">
          </button>
          <div class="lang-menu" id="langMenu">
            <button type="button" data-lang="th">‡πÑ‡∏ó‡∏¢</button>
            <button type="button" data-lang="en">English</button>
            <button type="button" data-lang="ms">Bahasa Melayu</button>
          </div>
          <select id="langSelect" style="display:none;">
            <option value="th">‡πÑ‡∏ó‡∏¢</option>
            <option value="en">English</option>
            <option value="ms">Bahasa Melayu</option>
          </select>
        </div>

        <!-- ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Firestore /users) -->
        <a href="profile.html" class="user-chip" id="profileBtn">
          <img src="images/profile-icon.png" alt="Profile" class="top-icon user-avatar">
          <div class="user-chip-text">
            <div class="user-chip-name" id="profileName">User Name</div>
            <div class="user-chip-role" id="profileRole">Role</div>
          </div>
        </a>
      </div>
    </div>

    <div class="content">
      <!-- ‡πÅ‡∏ñ‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ + ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏° (‡πÅ‡∏ó‡∏ô card ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏î‡∏¥‡∏°) -->
      <div class="add-schedule-header">
        <div class="add-schedule-title" id="addScheduleHeaderTitle"></div>
        <button type="button" class="primary" id="btnOpenScheduleForm"></button>
      </div>

      <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÉ‡∏´‡πâ‡∏Ç‡∏ô‡∏≤‡∏î/‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô -->
      <div class="card">
        <h3 id="tableTitle"></h3>
        <p class="muted" id="countLabel"></p>

        <div style="overflow-x:auto">
          <table>
            <thead>
              <tr>
                <th id="thWorkDate"></th>
                <th id="thZoneArea"></th>
                <th id="thTruck"></th>
                <th id="thDriver"></th>
                <th id="thWorkStatus"></th>
                <th id="thCreatedBy"></th>
                <th id="thCreated"></th>
              </tr>
            </thead>

            <tbody id="scheduleTbody">
              <tr>
                <td colspan="5" class="muted" id="loadingText"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ñ‡∏±‡∏á) -->
  <div class="modal-backdrop" id="scheduleModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="scheduleModalTitle"></div>
        <button type="button" class="modal-close" id="btnScheduleClose">‚úï</button>
      </div>

      <form id="scheduleForm">

        <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô -->
        <div class="row">
          <div>
            <label id="labelPickDate"></label>
            <input id="weekPicker" type="date" required />
            <div class="muted" id="hintPickDate"></div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">

          <div>
            <label id="labelZone"></label>
            <select id="zoneSelect" required disabled>
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï...</option>
            </select>
          </div>
        </div>

        <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà -->
        <div class="row" id="areaWrapper" style="display:none;">
          <div>
            <label id="labelArea"></label>
            <div id="areaCheckboxes"></div>
          </div>
        </div>

        <!-- ‡∏£‡∏ñ + ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö -->
        <div class="row">
          <div>
            <label id="labelTruck">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ</label>
            <select id="truckSelect" required disabled>
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô‡∏Å‡πà‡∏≠‡∏ô...</option>
            </select>
          </div>

          <div>
            <label id="labelDriver">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</label>
            <select id="driverSelect" required disabled>
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô‡∏Å‡πà‡∏≠‡∏ô...</option>
            </select>
          </div>
        </div>

        <!-- ‡∏õ‡∏∏‡πà‡∏° -->
        <div class="row" style="margin-top:12px;">
          <div id="formStatus" class="muted"></div>
          <button type="button" class="ghost" id="btnClear"></button>
          <button type="submit" class="primary" id="btnSave"></button>
        </div>

      </form>
    </div>
  </div>
  <!-- Modal ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö -->
  <div class="modal-backdrop" id="conflictBackdrop" style="display:none;">
    <div class="modal" style="max-width:420px;">
      <div class="modal-header">
        <div class="modal-title" id="conflictTitle"></div>
        <button type="button" class="modal-close" id="conflictClose">‚úï</button>
      </div>

      <div style="padding:16px;">
        <p id="conflictMessage" style="white-space:pre-line;"></p>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:16px;">
          <button class="ghost" id="btnConflictCancel"></button>
          <button class="primary" id="btnConflictConfirm"></button>
        </div>
      </div>
    </div>
  </div>


  <script>
    /* -------- ‡πÄ‡∏°‡∏ô‡∏π‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ + sidebar backdrop (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ñ‡∏±‡∏á) -------- */
    function toggleMenu(force) {
      const sidebar = document.getElementById('sidebar');
      const btn = document.getElementById('menuToggle');
      const backdrop = document.getElementById('sidebarBackdrop');
      let show;

      if (typeof force === 'boolean') {
        show = force;
      } else {
        show = !sidebar.classList.contains('show');
      }

      sidebar.classList.toggle('show', show);
      if (backdrop) {
        backdrop.classList.toggle('show', show);
      }

      if (window.innerWidth <= 900) {
        btn.style.display = show ? 'none' : 'inline-flex';
      }
    }

    document.getElementById("menuToggle").addEventListener("click", () => {
      toggleMenu();
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.menu a').forEach(a => {
        a.addEventListener('click', () => {
          if (window.innerWidth <= 900) toggleMenu(false);
        });
      });

      const backdrop = document.getElementById('sidebarBackdrop');
      if (backdrop) {
        backdrop.addEventListener('click', () => toggleMenu(false));
      }
    });

    window.addEventListener('resize', () => {
      const btn = document.getElementById('menuToggle');
      const sidebar = document.getElementById('sidebar');
      const backdrop = document.getElementById('sidebarBackdrop');

      if (window.innerWidth > 900) {
        btn.style.display = 'none';
        sidebar.classList.remove('show');
        if (backdrop) backdrop.classList.remove('show');
      } else {
        btn.style.display = sidebar.classList.contains('show') ? 'none' : 'inline-flex';
      }
    });

    firebase.firestore().enableNetwork().catch(console.error);

    const fs = firebase.firestore();
    const zonesCol = fs.collection("zones");
    const trucksCol = fs.collection("trucks");
    const usersCol = fs.collection("users");
    const scheduleCol = fs.collection("truck_schedule");

    /* DOM */

    const zoneSelect = document.getElementById("zoneSelect");
    const truckSelect = document.getElementById("truckSelect");
    const driverSelect = document.getElementById("driverSelect");
    const formStatus = document.getElementById("formStatus");
    const scheduleTbody = document.getElementById("scheduleTbody");
    const countLabel = document.getElementById("countLabel");
    const weekPicker = document.getElementById("weekPicker");
    const btnClear = document.getElementById("btnClear");
    let isSaving = false;
    const areaWrapper = document.getElementById("areaWrapper");
    // ===== popup ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ã‡πâ‡∏≥ =====
    const conflictBackdrop = document.getElementById("conflictBackdrop");
    const conflictMessageEl = document.getElementById("conflictMessage");
    const btnConflictCancel = document.getElementById("btnConflictCancel");
    const btnConflictConfirm = document.getElementById("btnConflictConfirm");
    const conflictClose = document.getElementById("conflictClose");

    let pendingSaveCallback = null;

    function openConflictPopup(message) {
      conflictMessageEl.textContent = message;
      pendingSaveCallback = null; // ‚ùå ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ callback
      conflictBackdrop.style.display = "flex";
      lockBodyScroll(true);
      btnConflictConfirm.style.display = "none";
    }

    function closeConflictPopup() {
      conflictBackdrop.style.display = "none";
      lockBodyScroll(false);
      btnConflictConfirm.style.display = "";
    }

    btnConflictCancel.addEventListener("click", () => {
      closeConflictPopup();
      isSaving = false;
      btnSave.disabled = false;
      btnSave.textContent = tr("btnSave");
    });

    conflictClose.addEventListener("click", () => {
      btnConflictCancel.click();
    });

    const btnOpenScheduleForm = document.getElementById("btnOpenScheduleForm");
    const scheduleModalBackdrop = document.getElementById("scheduleModalBackdrop");
    const btnScheduleClose = document.getElementById("btnScheduleClose");

    // ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
    const profileNameEl = document.getElementById("profileName");
    const profileRoleEl = document.getElementById("profileRole");

    let zones = [];
    let trucks = []; // üëà ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    let drivers = []; // üëà ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    let schedules = [];
    let workStatusMap = {};

    function setMinDateToday() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      weekPicker.min = `${yyyy}-${mm}-${dd}`;
    }

    function lockAllSelectors() {
      zoneSelect.disabled = true;
      truckSelect.disabled = true;
      driverSelect.disabled = true;
    }

    function lockBodyScroll(lock) {
      document.body.classList.toggle("modal-open", !!lock);
    }

    const LangState = window.AdminLang || null;
    let currentLang = (LangState && typeof LangState.getLang === "function")
      ? LangState.getLang()
      : (localStorage.getItem("sw_lang") || "th");
    const langSelect = document.getElementById("langSelect");
    const langIconBtn = document.getElementById("langIconBtn");
    const langMenu = document.getElementById("langMenu");

    function tr(key) {
      const dict =
        (window.SW_Translations && window.SW_Translations[currentLang]) ||
        (window.SW_Translations && window.SW_Translations.th) ||
        {};
      return dict[key] !== undefined ? dict[key] : key;
    }

    function setFormStatusText(text, type) {
      formStatus.textContent = text || "";
      formStatus.className = "muted" + (type === "ok" ? " ok" : type === "err" ? " err" : "");
    }

    function clearFormAlert() {
      setFormStatusText("", "");
    }

    function updateLangMenuActive() {
      if (!langMenu) return;

      const lang =
        (window.AdminLang && typeof window.AdminLang.getLang === "function")
          ? window.AdminLang.getLang()
          : currentLang;

      langMenu.querySelectorAll("button[data-lang]").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.lang === lang);
      });
    }

    function setText(id, key) {
      const el = document.getElementById(id);
      if (el) el.textContent = tr(key);
    }

    function applyLanguage() {
      currentLang =
        (window.AdminLang && typeof window.AdminLang.getLang === "function")
          ? window.AdminLang.getLang()
          : currentLang;

      document.body.setAttribute("data-lang", currentLang);

      // ===== Page =====
      document.title = tr("pageTitle_schedule");
      setText("mainTitle", "mainTitle_schedule");

      // ===== Form / Modal =====
      setText("labelPickDate", "labelPickDate");
      setText("hintPickDate", "hintPickDate");
      setText("labelArea", "labelArea");

      setText("scheduleModalTitle", "formTitle");
      setText("labelZone", "labelZone");
      setText("labelTruck", "labelTruck");
      setText("labelDriver", "labelDriver");
      setText("btnClear", "btnClear");
      setText("btnSave", "btnSave");

      // ===== Conflict modal =====
      setText("conflictTitle", "conflictTitle");
      setText("btnConflictCancel", "btnCancel");
      setText("btnConflictConfirm", "btnConfirm");

      // ===== Header =====
      setText("addScheduleHeaderTitle", "addScheduleHeaderTitle");
      setText("btnOpenScheduleForm", "btnOpenSchedule");

      // ===== Table =====
      setText("tableTitle", "tableTitle");
      setText("thWorkDate", "thWorkDate");
      setText("thZoneArea", "thZoneArea");
      setText("thTruck", "thTruck");
      setText("thDriver", "thDriver");
      setText("thWorkStatus", "thWorkStatus");
      setText("thCreatedBy", "thCreatedBy");
      setText("thCreated", "thCreated");
      setText("loadingText", "loadingText");

      // ===== Select placeholder =====
      if (zoneSelect?.options?.length) {
        zoneSelect.options[0].textContent = tr("zonePlaceholder");
      }

      if (truckSelect.disabled) {
        truckSelect.innerHTML = `<option value="">${tr("truckPlaceholder")}</option>`;
      }
      if (driverSelect.disabled) {
        driverSelect.innerHTML = `<option value="">${tr("driverPlaceholder")}</option>`;
      }

      // ===== Sync ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á =====
      if (window.AdminNav?.setLanguage) {
        window.AdminNav.setLanguage(currentLang);
      }
      if (window.AdminUser?.setLanguage) {
        window.AdminUser.setLanguage(currentLang);
      }
      if (window.AdminProfile?.setLanguage) {
        window.AdminProfile.setLanguage(currentLang);
      }

      renderSchedules();
      updateLangMenuActive();
    }

    function changeLanguage(lang) {
      if (!window.SW_Translations || !window.SW_Translations[lang]) return;

      if (LangState && typeof LangState.setLang === "function") {
        LangState.setLang(lang);
        currentLang = LangState.getLang();
      } else {
        currentLang = lang;
        localStorage.setItem("sw_lang", lang);
      }

      langSelect.value = currentLang;
      applyLanguage();
    }

    langSelect.addEventListener("change", e => changeLanguage(e.target.value));
    langSelect.value = currentLang;

    langIconBtn.addEventListener("click", () => {
      langMenu.classList.toggle("show");
    });

    langMenu.addEventListener("click", e => {
      const btn = e.target.closest("button[data-lang]");
      if (!btn) return;
      changeLanguage(btn.dataset.lang);
      langMenu.classList.remove("show");
    });

    if (LangState && typeof LangState.onChange === "function") {
      LangState.onChange(lang => {
        if (lang && lang !== currentLang) {
          currentLang = lang;
          langSelect.value = lang;
          applyLanguage();
        }
      });
    }

    // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏†‡∏≤‡∏©‡∏≤ (‡πÑ‡∏°‡πà‡∏¢‡∏∏‡πà‡∏á‡∏Å‡∏±‡∏ö sidebar ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ä‡πâ backdrop ‡πÅ‡∏•‡πâ‡∏ß)
    document.addEventListener("click", e => {
      const clickedInLang = langMenu.contains(e.target) || langIconBtn.contains(e.target);
      if (!clickedInLang) langMenu.classList.remove("show");
    });

    /* ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Zones, Trucks, Drivers) */
    async function loadInitialData() {
      const snapZones = await zonesCol.get();
      console.log("zones size =", snapZones.size);

      try {
        // ===== 1. ZONES =====
        const snapZones = await zonesCol.get();
        zones = [];
        zoneSelect.innerHTML =
          `<option value="">${tr("zonePlaceholder")}</option>`;

        for (const doc of snapZones.docs) {
          const zoneId = doc.id;
          const zData = doc.data();

          const zoneObj = {
            id: zoneId,
            name: zData.name || zoneId,
            areas: []
          };

          // dropdown zone
          const opt = document.createElement("option");
          opt.value = zoneId;
          opt.textContent = zoneObj.name;
          zoneSelect.appendChild(opt);

          // ===== areas =====
          const areaSnap = await zonesCol.doc(zoneId).collection("areas").get();
          areaSnap.forEach(a => {
            zoneObj.areas.push({
              id: a.id,
              name: a.data().name || a.id
            });
          });

          zones.push(zoneObj);
        }

        console.log("Zones loaded:", zones);
      } catch (err) {
        console.error("loadInitialData error", err);
        alert(tr("alertLoadZoneFail"));
      }
    }

    function renderAreaCheckboxes(zoneId) {
      const wrapper = document.getElementById("areaCheckboxes");
      wrapper.innerHTML = "";

      const z = zones.find(z => z.id === zoneId);
      if (!z || !z.areas.length) {
        wrapper.innerHTML =
          "<div class='muted'>" + tr("areaNoData") + "</div>";
        return;
      }

      z.areas.forEach(a => {
        const label = document.createElement("label");
        label.style.display = "block";
        label.innerHTML = `
      <input type="checkbox" value="${a.id}" data-name="${a.name}">
      ${a.name}
    `;
        wrapper.appendChild(label);
      });
    }

    async function loadTrucks(zoneId) {
      truckSelect.innerHTML =
        `<option value="">${tr("truckPlaceholder")}</option>`;
      truckSelect.disabled = true;

      try {
        const snap = await fs
          .collection("trucks")
          .doc(zoneId)
          .collection("vehicles")   // ‚úÖ ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Firestore ‡∏à‡∏£‡∏¥‡∏á
          .get();

        if (snap.empty) {
          truckSelect.innerHTML =
            '<option value="">' + tr("truckNoData") + '</option>';
          return;
        }

        snap.forEach(doc => {
          const d = doc.data();
          const opt = document.createElement("option");
          opt.value = doc.id; // ‡πÄ‡∏ä‡πà‡∏ô TRUCK_Y001
          opt.textContent = d.truckId || doc.id;
          truckSelect.appendChild(opt);
        });

      } catch (err) {
        console.error("loadTrucks error", err);
        truckSelect.innerHTML =
          '<option value="">' + tr("truckLoadFail") + '</option>';
      }

      truckSelect.disabled = false;
    }

    async function loadDrivers(zoneId) {
      driverSelect.innerHTML =
        `<option value="">${tr("driverPlaceholder")}</option>`;
      driverSelect.disabled = true;

      const snap = await usersCol
        .where("status", "==", 1)
        .where("zoneId", "==", zoneId)
        .where("isDeleted", "==", false)
        .get();

      snap.forEach(doc => {
        const d = doc.data();
        const opt = document.createElement("option");
        opt.value = doc.id;
        opt.textContent = `${d.driverId} ‚Ä¢ ${d.fullName}`;
        driverSelect.appendChild(opt);
      });

      driverSelect.disabled = false;
    }

    zoneSelect.addEventListener("change", () => {
      const zoneId = zoneSelect.value;
      if (!zoneId) return;

      areaWrapper.style.display = "block";
      renderAreaCheckboxes(zoneId);

      loadTrucks(zoneId);
      loadDrivers(zoneId);
    });

    weekPicker.addEventListener("change", () => {
      zoneSelect.disabled = false;
    });

    function isBeyond4Weeks(dateStr) {
      const pick = new Date(dateStr);
      const now = new Date();
      return (pick - now) / (1000 * 60 * 60 * 24) > 28;
    }

    async function checkScheduleExists(zoneId, workDate) {
      const docRef = fs
        .collection("truck_schedule")
        .doc(zoneId)
        .collection("days")
        .doc(workDate);

      const snap = await docRef.get();
      return snap.exists;
    }

    document.getElementById("scheduleForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (isSaving) return;

      isSaving = true;
      btnSave.disabled = true;
      btnSave.textContent = tr("statusSaving");

      const pickDate = weekPicker.value;
      const zone = zoneSelect.value;
      const truck = truckSelect.value;
      const driver = driverSelect.value;

      // üîΩ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å checkbox
      const areas = Array.from(
        document.querySelectorAll("#areaCheckboxes input:checked")
      ).map(cb => ({
        areaId: cb.value,
        areaName: cb.dataset.name
      }));

      if (!pickDate || !zone || !truck || !driver) {
        alert(tr("alertFillAll"));
        resetSaveState();
        return;
      }

      if (!areas.length) {
        alert(tr("alertSelectArea"));
        resetSaveState();
        return;
      }

      if (isBeyond4Weeks(pickDate)) {
        setFormStatusText(tr("statusAdvanceLimit"), "err");
        resetSaveState();
        return;
      }

      // ===== ‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏ä‡πá‡∏Å‡∏ã‡πâ‡∏≥‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ =====
      const isDuplicate = await checkScheduleExists(zone, pickDate);

      if (isDuplicate) {
        openConflictPopup(tr("conflictSameDay"));
        resetSaveState();
        return;
      }


      try {
        const zoneName =
          zoneSelect.options[zoneSelect.selectedIndex]?.textContent || "";

        const truckName =
          truckSelect.options[truckSelect.selectedIndex]?.textContent || "";

        const driverName =
          driverSelect.options[driverSelect.selectedIndex]?.textContent || "";

        await fs
          .collection("truck_schedule")
          .doc(zone)
          .collection("days")
          .doc(pickDate)
          .set({
            workDate: pickDate,
            zoneId: zone,
            zoneName,
            areas,
            truckId: truck,
            truckName,
            driverId: driver,
            driverName,
            createdBy:
              window.ADMIN_AUTH?.fullName ||
              window.ADMIN_AUTH?.username ||
              "admin",
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

        setFormStatusText(tr("statusSaveOk"), "ok");
        resetScheduleForm();
        closeScheduleModal();

      } catch (err) {
        console.error(err);
        setFormStatusText(err.message || tr("statusError"), "err");
      } finally {
        resetSaveState();
      }
    });



    function resetSaveState() {
      isSaving = false;
      btnSave.disabled = false;
      btnSave.textContent = tr("btnSave");
    }

    function resetScheduleForm() {
      // reset native form
      document.getElementById("scheduleForm").reset();

      // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå date
      weekPicker.value = "";

      // reset zone
      zoneSelect.value = "";
      zoneSelect.disabled = true;

      // ‡∏ã‡πà‡∏≠‡∏ô area + ‡∏•‡πâ‡∏≤‡∏á checkbox
      areaWrapper.style.display = "none";
      document.getElementById("areaCheckboxes").innerHTML = "";

      // reset truck
      truckSelect.disabled = true;
      truckSelect.innerHTML =
        `<option value="">${tr("truckPlaceholder")}</option>`;

      // reset driver
      driverSelect.disabled = true;
      driverSelect.innerHTML =
        `<option value="">${tr("driverPlaceholder")}</option>`;

      // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      clearFormAlert();
      setFormStatusText("", "");
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° */
    btnClear.addEventListener("click", () => {
      weekPicker.value = "";
      zoneSelect.value = "";

      areaWrapper.style.display = "none";
      document.getElementById("areaCheckboxes").innerHTML = "";

      truckSelect.disabled = true;
      driverSelect.disabled = true;
      truckSelect.innerHTML = '<option value="">' + tr("truckPlaceholder") + '</option>';
      driverSelect.innerHTML = '<option value="">' + tr("driverPlaceholder") + '</option>';

      setFormStatusText("", "");
      clearFormAlert();
    });

    /* Modal ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    function openScheduleModal() {
      resetScheduleForm();   // ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö reset ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      lockAllSelectors();
      scheduleModalBackdrop.classList.add("show");
      lockBodyScroll(true);
    }


    function closeScheduleModal() {
      isSaving = false;
      btnSave.disabled = false;
      btnSave.textContent = tr("btnSave");

      clearFormAlert(); // üëà ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

      scheduleModalBackdrop.classList.remove("show");
      lockBodyScroll(false);
    }

    btnOpenScheduleForm.addEventListener("click", openScheduleModal);
    btnScheduleClose.addEventListener("click", closeScheduleModal);

    scheduleModalBackdrop.addEventListener("click", (e) => {
      if (e.target === scheduleModalBackdrop) {
        closeScheduleModal();
      }
    });

    function toYMD(dateObj) {
      // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô yyyy-mm-dd (‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö workDate ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô schedule)
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth() + 1).padStart(2, "0");
      const d = String(dateObj.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    /* ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    function renderSchedules() {
      if (!scheduleTbody) return;

      if (!schedules.length) {
        countLabel.textContent = tr("countPrefix") + " 0 " + tr("countSuffix");
        scheduleTbody.innerHTML = '<tr><td colspan="5" class="muted">' + tr("noData") + '</td></tr>';
        return;
      }

      countLabel.textContent = tr("countPrefix") + " " + schedules.length + " " + tr("countSuffix");

      scheduleTbody.innerHTML = schedules.map(s => {
        const key = `${s._zoneId}_${s.truckId}_${s.workDate}`;
        const status = workStatusMap[key]; // "ONTIME" | "LATE" | "NOT_DONE"

        let badgeHtml = "";
        if (status === "ONTIME") {
          badgeHtml = `<span class="badge badge-status-ontime">${tr("workCompletedOnTime")}</span>`;
        } else if (status === "LATE") {
          badgeHtml = `<span class="badge badge-status-late">${tr("workCompletedLate")}</span>`;
        } else {
          badgeHtml = `<span class="badge badge-status-notdone">${tr("workNotFinished")}</span>`;
        }

        return `
        <tr>
          <td>${new Date(s.workDate).toLocaleDateString(
          currentLang === "en" ? "en-GB" :
            currentLang === "ms" ? "ms-MY" : "th-TH"
        )}</td>

          <td>
            <strong>${s.zoneName}</strong><br>
            <span class="muted">${(s.areas || []).map(a => a.areaName).join(", ")}</span>
          </td>

          <td>${s.truckName}</td>
          <td>${s.driverName}</td>

          <td>${badgeHtml}</td>

          <td>${s.createdBy}</td>
          <td>${s.created}</td>
        </tr>
      `;
      }).join("");
    }
    function setupScheduleListener() {
    schedules = [];
    workStatusMap = {}; // ‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á

    zonesCol.get().then(zoneSnap => {
      zoneSnap.forEach(zoneDoc => {
        const zoneId = zoneDoc.id;

        fs.collection("truck_schedule")
          .doc(zoneId)
          .collection("days")
          .onSnapshot(async (sn) => {

            // ‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡πÇ‡∏ã‡∏ô‡∏ô‡∏µ‡πâ
            schedules = schedules.filter(s => s._zoneId !== zoneId);

            const temp = [];

            for (const doc of sn.docs) {
              const d = doc.data();
              const workDate = d.workDate;   // "yyyy-mm-dd"
              const truckId = d.truckId;

              let status = "NOT_DONE"; // üî¥ default

              try {
                const runSnap = await fs
                  .collection("trucks")
                  .doc(zoneId)
                  .collection("vehicles")
                  .doc(truckId)
                  .collection("truck_operating_time")
                  .doc(workDate)
                  .get();

                if (runSnap.exists) {
                  const runData = runSnap.data();
                  const isFinished = runData.isFinished === true;

                  if (isFinished) {
                    // ‡πÉ‡∏ä‡πâ finishedAt ‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≠‡∏¢‡πÉ‡∏ä‡πâ endAt
                    const ts = runData.finishedAt || runData.endAt;

                    if (ts && typeof ts.toDate === "function") {
                      const finishedDateStr = toYMD(ts.toDate());

                      status = (finishedDateStr === workDate)
                        ? "ONTIME"   // ‚úÖ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                        : "LATE";    // üü° ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
                    } else {
                      // ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ß‡∏±‡∏ô
                      status = "LATE";
                    }
                  } else {
                    status = "NOT_DONE";
                  }
                } else {
                  status = "NOT_DONE";
                }
              } catch (e) {
                console.warn("‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", e);
                status = "NOT_DONE";
              }

              const statusKey = `${zoneId}_${truckId}_${workDate}`;
              workStatusMap[statusKey] = status;

              temp.push({
                _zoneId: zoneId,
                workDate: d.workDate,
                zoneName: d.zoneName,
                areas: d.areas || [],
                truckId: truckId,
                truckName: d.truckName,
                driverName: d.driverName,
                createdBy: d.createdBy,
                created: d.createdAt?.toDate()?.toLocaleString?.() || ""
              });
            }

            schedules.push(...temp);

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô)
            schedules.sort((a, b) => (b.workDate || "").localeCompare(a.workDate || ""));

            renderSchedules();
          });
      });
    });
  }

    (async () => {
      langSelect.value = currentLang;
      setMinDateToday();
      await loadInitialData(); // üëà ‡πÇ‡∏´‡∏•‡∏î zones, trucks, drivers ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      setupScheduleListener();
      applyLanguage();
    })();
  </script>

</body>

</html>