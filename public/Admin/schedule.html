<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Waste - à¸ˆà¸±à¸”à¸•à¸²à¸£à¸²à¸‡à¸‚à¸±à¸šà¸£à¸–à¹€à¸à¹‡à¸šà¸‚à¸¢à¸°</title>
  <link rel="stylesheet" href="a_style.css">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- Auth + à¹€à¸¡à¸™à¸¹ -->
  <script src="../Login/auth.js"></script>
  <script src="admin-lang.js"></script>
  <script src="admin-user.js" defer></script>
  <script src="admin-nav.js" defer></script>
  <script>
    const currentUser = window.SWAuth.requireAuth([0]); // à¹€à¸‰à¸à¸²à¸°à¹à¸­à¸”à¸¡à¸´à¸™
  </script>

</head>

<body>

  <button id="menuToggle" class="toggle-btn">â˜° à¹€à¸¡à¸™à¸¹</button>

  <aside class="sidebar" id="sidebar">
    <h2>Smart Waste</h2>
    <nav class="menu" data-admin-menu data-active="schedule"></nav>
    <div class="sw-logout-slot" data-sw-logout-slot></div>
  </aside>
  <!-- à¸‰à¸²à¸à¸«à¸¥à¸±à¸‡à¸‚à¸­à¸‡ sidebar à¸šà¸™à¸¡à¸·à¸­à¸–à¸·à¸­ -->
  <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

  <main>

      <div class="topbar">
        <div>
          <h1 id="mainTitle">à¸ˆà¸±à¸”à¸•à¸²à¸£à¸²à¸‡à¸‚à¸±à¸šà¸£à¸–à¹€à¸à¹‡à¸šà¸‚à¸¢à¸°</h1>
        </div>
        <div class="topbar-right">
          <!-- à¹„à¸­à¸„à¸­à¸™à¹€à¸¥à¸·à¸­à¸à¸ à¸²à¸©à¸² -->
          <div class="lang-switcher">
            <button class="icon-btn" id="langIconBtn" type="button" aria-label="à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ à¸²à¸©à¸²">
              <img src="images/lang-icon.png" alt="Language" class="top-icon">
            </button>
            <div class="lang-menu" id="langMenu">
              <button type="button" data-lang="th">à¹„à¸—à¸¢</button>
              <button type="button" data-lang="en">English</button>
              <button type="button" data-lang="ms">Bahasa Melayu</button>
            </div>
            <select id="langSelect" style="display:none;">
              <option value="th">à¹„à¸—à¸¢</option>
              <option value="en">English</option>
              <option value="ms">Bahasa Melayu</option>
            </select>
          </div>

          <!-- à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰ (à¸”à¸¶à¸‡à¸ˆà¸²à¸ Firestore /users) -->
          <a href="profile.html" class="user-chip" id="profileBtn">
            <img src="images/profile-icon.png" alt="Profile" class="top-icon user-avatar">
            <div class="user-chip-text">
              <div class="user-chip-name" id="profileName">User Name</div>
              <div class="user-chip-role" id="profileRole">Role</div>
            </div>
          </a>
        </div>
      </div>

      <div class="content">
        <!-- à¹à¸–à¸šà¸«à¸±à¸§à¸‚à¹‰à¸­ + à¸›à¸¸à¹ˆà¸¡à¹€à¸›à¸´à¸”à¸Ÿà¸­à¸£à¹Œà¸¡ (à¹à¸—à¸™ card à¸Ÿà¸­à¸£à¹Œà¸¡à¹€à¸”à¸´à¸¡) -->
        <div class="add-schedule-header">
          <div class="add-schedule-title" id="addScheduleHeaderTitle">à¸ªà¸£à¹‰à¸²à¸‡à¸•à¸²à¸£à¸²à¸‡à¸‚à¸±à¸šà¸£à¸–</div>
          <button type="button" class="primary" id="btnOpenScheduleForm">à¸ªà¸£à¹‰à¸²à¸‡à¸•à¸²à¸£à¸²à¸‡à¸‚à¸±à¸šà¸£à¸–</button>
        </div>

        <!-- à¸à¸²à¸£à¹Œà¸”à¸•à¸²à¸£à¸²à¸‡à¸¥à¹ˆà¸²à¸ªà¸¸à¸” à¹ƒà¸«à¹‰à¸‚à¸™à¸²à¸”/à¸ªà¹„à¸•à¸¥à¹Œà¹€à¸«à¸¡à¸·à¸­à¸™à¸«à¸™à¹‰à¸²à¸­à¸·à¹ˆà¸™ -->
        <div class="card">
          <h3 id="tableTitle">à¸•à¸²à¸£à¸²à¸‡à¸‚à¸±à¸šà¸£à¸–à¸¥à¹ˆà¸²à¸ªà¸¸à¸”</h3>
          <p class="muted" id="countLabel">à¹à¸ªà¸”à¸‡ 0 à¸£à¸²à¸¢à¸à¸²à¸£</p>

          <div style="overflow-x:auto">
            <table>
              <thead>
                <tr>
                  <th id="thZone">à¹€à¸‚à¸•</th>
                  <th id="thRange">à¸Šà¹ˆà¸§à¸‡à¸§à¸±à¸™à¸—à¸µà¹ˆ</th>
                  <th id="thTruck">à¸£à¸–</th>
                  <th id="thDriver">à¸„à¸™à¸‚à¸±à¸š</th>
                  <th id="thCreated">à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸¡à¸·à¹ˆà¸­</th>
                </tr>
              </thead>
              <tbody id="scheduleTbody">
                <tr>
                  <td colspan="5" class="muted" id="loadingText">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
  </main>

  <!-- Modal à¸Ÿà¸­à¸£à¹Œà¸¡à¸ˆà¸±à¸”à¸•à¸²à¸£à¸²à¸‡ (à¹€à¸«à¸¡à¸·à¸­à¸™à¸Ÿà¸­à¸£à¹Œà¸¡à¹€à¸à¸´à¹ˆà¸¡à¸–à¸±à¸‡) -->
  <div class="modal-backdrop" id="scheduleModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="scheduleModalTitle">à¸ªà¸£à¹‰à¸²à¸‡à¸•à¸²à¸£à¸²à¸‡à¸‚à¸±à¸šà¸£à¸–</div>
        <button type="button" class="modal-close" id="btnScheduleClose">âœ•</button>
      </div>

      <form id="scheduleForm">
        <div class="row">
          <div>
            <label id="labelStart">à¸§à¸±à¸™à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™</label>
            <input id="startDate" type="date" required />
          </div>
          <div>
            <label id="labelEnd">à¸§à¸±à¸™à¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”</label>
            <input id="endDate" type="date" required />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label id="labelZone">à¹€à¸‚à¸•à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆ</label>
            <select id="zoneSelect" required>
              <option value="">à¹€à¸¥à¸·à¸­à¸à¹€à¸‚à¸•...</option>
            </select>
          </div>

          <div>
            <label id="labelTruck">à¹€à¸¥à¸·à¸­à¸à¸£à¸–</label>
            <select id="truckSelect" required disabled>
              <option value="">à¹€à¸¥à¸·à¸­à¸à¹€à¸‚à¸•à¸à¹ˆà¸­à¸™...</option>
            </select>
          </div>

          <div>
            <label id="labelDriver">à¹€à¸¥à¸·à¸­à¸à¸„à¸™à¸‚à¸±à¸š</label>
            <select id="driverSelect" required disabled>
              <option value="">à¹€à¸¥à¸·à¸­à¸à¹€à¸‚à¸•à¸à¹ˆà¸­à¸™...</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div id="formStatus" class="muted"></div>
          <button type="button" class="ghost" id="btnClear">à¸¥à¹‰à¸²à¸‡à¸Ÿà¸­à¸£à¹Œà¸¡</button>
          <button type="submit" class="primary" id="btnSave">à¸šà¸±à¸™à¸—à¸¶à¸à¸•à¸²à¸£à¸²à¸‡</button>
        </div>
      </form>
    </div>
  </div>

  <script>
Â  Â  /* -------- à¹€à¸¡à¸™à¸¹à¸¡à¸·à¸­à¸–à¸·à¸­ + sidebar backdrop (à¹€à¸«à¸¡à¸·à¸­à¸™à¸«à¸™à¹‰à¸²à¹€à¸à¸´à¹ˆà¸¡à¸–à¸±à¸‡) -------- */
Â  Â  function toggleMenu(force) {
Â  Â  Â  const sidebar = document.getElementById('sidebar');
Â  Â  Â  const btn = document.getElementById('menuToggle');
Â  Â  Â  const backdrop = document.getElementById('sidebarBackdrop');
Â  Â  Â  let show;

Â  Â  Â  if (typeof force === 'boolean') {
Â  Â  Â  Â  show = force;
Â  Â  Â  } else {
Â  Â  Â  Â  show = !sidebar.classList.contains('show');
Â  Â  Â  }

Â  Â  Â  sidebar.classList.toggle('show', show);
Â  Â  Â  if (backdrop) {
Â  Â  Â  Â  backdrop.classList.toggle('show', show);
Â  Â  Â  }

Â  Â  Â  if (window.innerWidth <= 900) {
Â  Â  Â  Â  btn.style.display = show ? 'none' : 'inline-flex';
Â  Â  Â  }
Â  Â  }

Â  Â  document.getElementById("menuToggle").addEventListener("click", () => {
Â  Â  Â  toggleMenu();
Â  Â  });

Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  document.querySelectorAll('.menu a').forEach(a => {
Â  Â  Â  Â  a.addEventListener('click', () => {
Â  Â  Â  Â  Â  if (window.innerWidth <= 900) toggleMenu(false);
Â  Â  Â  Â  });
Â  Â  Â  });

Â  Â  Â  const backdrop = document.getElementById('sidebarBackdrop');
Â  Â  Â  if (backdrop) {
Â  Â  Â  Â  backdrop.addEventListener('click', () => toggleMenu(false));
Â  Â  Â  }
Â  Â  });

Â  Â  window.addEventListener('resize', () => {
Â  Â  Â  const btn = document.getElementById('menuToggle');
Â  Â  Â  const sidebar = document.getElementById('sidebar');
Â  Â  Â  const backdrop = document.getElementById('sidebarBackdrop');

Â  Â  Â  if (window.innerWidth > 900) {
Â  Â  Â  Â  btn.style.display = 'none';
Â  Â  Â  Â  sidebar.classList.remove('show');
Â  Â  Â  Â  if (backdrop) backdrop.classList.remove('show');
Â  Â  Â  } else {
Â  Â  Â  Â  btn.style.display = sidebar.classList.contains('show') ? 'none' : 'inline-flex';
Â  Â  Â  }
Â  Â  });

Â  Â  /* -------- Firebase -------- */
Â  Â  var firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyBNPan4f39QzbwLn5A1SLOLNNhqnf-bZyo",
Â  Â  Â  authDomain: "smart-waste-a2bf4.firebaseapp.com",
Â  Â  Â  projectId: "smart-waste-a2bf4",
Â  Â  Â  storageBucket: "smart-waste-a2bf4.firebasestorage.app",
Â  Â  Â  messagingSenderId: "522733244689",
Â  Â  Â  appId: "1:522733244689:web:5c6a0cbe1aaa9e9185fcb0"
Â  Â  };
Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  const fs = firebase.firestore();

Â  Â  const zonesCol = fs.collection("zones");
Â  Â  const trucksCol = fs.collection("trucks");
Â  Â  const usersCol = fs.collection("users");
Â  Â  const scheduleCol = fs.collection("truck_schedule");

Â  Â  /* DOM */
Â  Â  const zoneSelect = document.getElementById("zoneSelect");
Â  Â  const truckSelect = document.getElementById("truckSelect");
Â  Â  const driverSelect = document.getElementById("driverSelect");
Â  Â  const formStatus = document.getElementById("formStatus");
Â  Â  const scheduleTbody = document.getElementById("scheduleTbody");
Â  Â  const countLabel = document.getElementById("countLabel");
Â  Â  const startDate = document.getElementById("startDate");
Â  Â  const endDate = document.getElementById("endDate");
Â  Â  const btnClear = document.getElementById("btnClear");

Â  Â  const btnOpenScheduleForm = document.getElementById("btnOpenScheduleForm");
Â  Â  const scheduleModalBackdrop = document.getElementById("scheduleModalBackdrop");
Â  Â  const btnScheduleClose = document.getElementById("btnScheduleClose");

Â  Â  // à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œ
Â  Â  const profileNameEl = document.getElementById("profileName");
Â  Â  const profileRoleEl = document.getElementById("profileRole");

Â  Â  let zones = [];
Â  Â  let trucks = []; // ğŸ‘ˆ à¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸–à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
Â  Â  let drivers = []; // ğŸ‘ˆ à¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸™à¸‚à¸±à¸šà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
Â  Â  let schedules = [];

    function lockBodyScroll(lock) {
      document.body.classList.toggle("modal-open", !!lock);
    }

    let currentUserProfile = null;

Â  Â  /* -------- i18n -------- */
Â  Â  const translations = {
Â  Â  Â  th: {
Â  Â  Â  Â  pageTitle: "Smart Waste - à¸ˆà¸±à¸”à¸•à¸²à¸£à¸²à¸‡à¸‚à¸±à¸šà¸£à¸–à¹€à¸à¹‡à¸šà¸‚à¸¢à¸°",
Â  Â  Â  Â  menuBtn: "â˜° à¹€à¸¡à¸™à¸¹",
Â  Â  Â  Â  mainTitle: "à¸ˆà¸±à¸”à¸•à¸²à¸£à¸²à¸‡à¸‚à¸±à¸šà¸£à¸–à¹€à¸à¹‡à¸šà¸‚à¸¢à¸°",
Â  Â  Â  Â  pageHint: "à¸ªà¸£à¹‰à¸²à¸‡à¸•à¸²à¸£à¸²à¸‡à¸¡à¸­à¸šà¸«à¸¡à¸²à¸¢à¸£à¸–à¹à¸¥à¸°à¸„à¸™à¸‚à¸±à¸šà¸•à¸²à¸¡à¹€à¸‚à¸•à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆ",

Â  Â  Â  Â  formTitle: "à¸ªà¸£à¹‰à¸²à¸‡à¸•à¸²à¸£à¸²à¸‡à¸‚à¸±à¸šà¸£à¸–",
Â  Â  Â  Â  labelStart: "à¸§à¸±à¸™à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™",
Â  Â  Â  Â  labelEnd: "à¸§à¸±à¸™à¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”",
Â  Â  Â  Â  labelZone: "à¹€à¸‚à¸•à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆ",
Â  Â  Â  Â  labelTruck: "à¹€à¸¥à¸·à¸­à¸à¸£à¸–",
Â  Â  Â  Â  labelDriver: "à¹€à¸¥à¸·à¸­à¸à¸„à¸™à¸‚à¸±à¸š",
Â  Â  Â  Â  zonePlaceholder: "à¹€à¸¥à¸·à¸­à¸à¹€à¸‚à¸•...",
Â  Â  Â  Â  truckLoading: "à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸£à¸–à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”...", // ğŸ‘ˆ à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹‚à¸«à¸¥à¸”à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
Â  Â  Â  Â  truckPlaceholder: "à¹€à¸¥à¸·à¸­à¸à¹€à¸‚à¸•à¸à¹ˆà¸­à¸™...", // ğŸ‘ˆ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸™à¸µà¹‰
Â  Â  Â  Â  truckSelect: "à¹€à¸¥à¸·à¸­à¸à¸£à¸–...", // ğŸ‘ˆ à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸¥à¸·à¸­à¸à¹€à¸‚à¸•à¹à¸¥à¹‰à¸§
Â  Â  Â  Â  truckNoData: "à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸–à¹ƒà¸™à¹€à¸‚à¸•à¸™à¸µà¹‰",
Â  Â  Â  Â  driverLoading: "à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸„à¸™à¸‚à¸±à¸šà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”...", // ğŸ‘ˆ à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹‚à¸«à¸¥à¸”à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
Â  Â  Â  Â  driverPlaceholder: "à¹€à¸¥à¸·à¸­à¸à¹€à¸‚à¸•à¸à¹ˆà¸­à¸™...", // ğŸ‘ˆ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸™à¸µà¹‰
Â  Â  Â  Â  driverSelect: "à¹€à¸¥à¸·à¸­à¸à¸„à¸™à¸‚à¸±à¸š...",// ğŸ‘ˆ à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸¥à¸·à¸­à¸à¹€à¸‚à¸•à¹à¸¥à¹‰à¸§
Â  Â  Â  Â  driverNoData: "à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸„à¸™à¸‚à¸±à¸šà¹ƒà¸™à¹€à¸‚à¸•à¸™à¸µà¹‰",
Â  Â  Â  Â  btnClear: "à¸¥à¹‰à¸²à¸‡à¸Ÿà¸­à¸£à¹Œà¸¡",
Â  Â  Â  Â  btnSave: "à¸šà¸±à¸™à¸—à¸¶à¸à¸•à¸²à¸£à¸²à¸‡",
Â  Â  Â  Â  addScheduleHeaderTitle: "à¸ªà¸£à¹‰à¸²à¸‡à¸•à¸²à¸£à¸²à¸‡à¸‚à¸±à¸šà¸£à¸–",
Â  Â  Â  Â  btnOpenSchedule: "à¸ªà¸£à¹‰à¸²à¸‡à¸•à¸²à¸£à¸²à¸‡à¸‚à¸±à¸šà¸£à¸–",

Â  Â  Â  Â  tableTitle: "à¸•à¸²à¸£à¸²à¸‡à¸‚à¸±à¸šà¸£à¸–à¸¥à¹ˆà¸²à¸ªà¸¸à¸”",
Â  Â  Â  Â  countPrefix: "à¹à¸ªà¸”à¸‡",
Â  Â  Â  Â  countSuffix: "à¸£à¸²à¸¢à¸à¸²à¸£",
Â  Â  Â  Â  loadingText: "à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...",
Â  Â  Â  Â  noData: "à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥",

Â  Â  Â  Â  thZone: "à¹€à¸‚à¸•",
Â  Â  Â  Â  thRange: "à¸Šà¹ˆà¸§à¸‡à¸§à¸±à¸™à¸—à¸µà¹ˆ",
Â  Â  Â  Â  thTruck: "à¸£à¸–",
Â  Â  Â  Â  thDriver: "à¸„à¸™à¸‚à¸±à¸š",
Â  Â  Â  Â  thCreated: "à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸¡à¸·à¹ˆà¸­",

Â  Â  Â  Â  statusEndBeforeStart: "à¸§à¸±à¸™à¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”à¸•à¹‰à¸­à¸‡à¹„à¸¡à¹ˆà¸à¹ˆà¸­à¸™à¸§à¸±à¸™à¹€à¸£à¸´à¹ˆà¸¡",
Â  Â  Â  Â  statusPastDate: "à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸”à¹‰ à¹„à¸¡à¹ˆà¸­à¸™à¸¸à¸à¸²à¸•à¹ƒà¸«à¹‰à¸ˆà¸±à¸”à¸•à¸²à¸£à¸²à¸‡à¸¢à¹‰à¸­à¸™à¸«à¸¥à¸±à¸‡",
Â  Â  Â  Â  statusSaveOk: "à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢",
Â  Â  Â  Â  statusConflict: "à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸”à¹‰ à¹€à¸™à¸·à¹ˆà¸­à¸‡à¸ˆà¸²à¸à¹€à¸‚à¸•à¸™à¸µà¹‰à¸¡à¸µà¹€à¸§à¸£à¸‚à¸±à¸šà¸£à¸–à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¸§à¸±à¸™à¸—à¸µà¹ˆà¸™à¸µà¹‰à¹à¸¥à¹‰à¸§",

Â  Â  Â  Â  cleared: ""
Â  Â  Â  },
Â  Â  Â  en: {
Â  Â  Â  Â  pageTitle: "Smart Waste - Truck Schedule",
Â  Â  Â  Â  menuBtn: "â˜° Menu",
Â  Â  Â  Â  mainTitle: "Garbage Truck Schedule",
Â  Â  Â  Â  pageHint: "Create schedules assigning trucks and drivers to each zone.",

Â  Â  Â  Â  formTitle: "Create Schedule",
Â  Â  Â  Â  labelStart: "Start date",
Â  Â  Â  Â  labelEnd: "End date",
Â  Â  Â  Â  labelZone: "Zone",
Â  Â  Â  Â  labelTruck: "Select truck",
Â  Â  Â  Â  labelDriver: "Select driver",
Â  Â  Â  Â  zonePlaceholder: "Select zone...",
Â  Â  Â  Â  truckLoading: "Loading all trucks...",
Â  Â  Â  Â  truckPlaceholder: "Select zone first...",
Â  Â  Â  Â  truckSelect: "Select truck...",
Â  Â  Â  Â  truckNoData: "No trucks in this zone",
Â  Â  Â  Â  driverLoading: "Loading all drivers...",
Â  Â  Â  Â  driverPlaceholder: "Select zone first...",
Â  Â  Â  Â  driverSelect: "Select driver...",
Â  Â  Â  Â  driverNoData: "No drivers in this zone",
Â  Â  Â  Â  btnClear: "Reset form",
Â  Â  Â  Â  btnSave: "Save schedule",
Â  Â  Â  Â  addScheduleHeaderTitle: "Create schedule",
Â  Â  Â  Â  btnOpenSchedule: "Create schedule",

Â  Â  Â  Â  tableTitle: "Latest Schedules",
Â  Â  Â  Â  countPrefix: "Showing",
Â  Â  Â  Â  countSuffix: "items",
Â  Â  Â  Â  loadingText: "Loading...",
Â  Â  Â  Â  noData: "No schedule data yet",

Â  Â  Â  Â  thZone: "Zone",
Â  Â  Â  Â  thRange: "Date range",
Â  Â  Â  Â  thTruck: "Truck",
Â  Â  Â  Â  thDriver: "Driver",
Â  Â  Â  Â  thCreated: "Created at",

Â  Â  Â  Â  statusEndBeforeStart: "End date must not be before start date",
Â  Â  Â  Â  statusPastDate: "Cannot save. Scheduling in the past is not allowed.",
Â  Â  Â  Â  statusSaveOk: "Schedule saved",
Â  Â  Â  Â  statusConflict: "Cannot save. This zone already has a truck scheduled for the selected date range.",

Â  Â  Â  Â  cleared: ""
Â  Â  Â  },
Â  Â  Â  ms: {
Â  Â  Â  Â  pageTitle: "Smart Waste - Jadual Lori Sampah",
Â  Â  Â  Â  menuBtn: "â˜° Menu",
Â  Â  Â  Â  mainTitle: "Jadual Lori Sampah",
Â  Â  Â  Â  pageHint: "Cipta jadual bagi lori dan pemandu mengikut zon.",

Â  Â  Â  Â  formTitle: "Cipta Jadual",
Â  Â  Â  Â  labelStart: "Tarikh mula",
Â  Â  Â  Â  labelEnd: "Tarikh tamat",
Â  Â  Â  Â  labelZone: "Zon",
Â  Â  Â  Â  labelTruck: "Pilih lori",
Â  Â  Â  Â  labelDriver: "Pilih pemandu",
Â  Â  Â  Â  zonePlaceholder: "Pilih zon...",
Â  Â  Â  Â  truckLoading: "Memuatkan semua lori...",
Â  Â  Â  Â  truckPlaceholder: "Pilih zon dahulu...",
Â  Â  Â  Â  truckSelect: "Pilih lori...",
Â  Â  Â  Â  truckNoData: "Tiada lori dalam zon ini",
Â  Â  Â  Â  driverLoading: "Memuatkan semua pemandu...",
Â  Â  Â  Â  driverPlaceholder: "Pilih zon dahulu...",
Â  Â  Â  Â  driverSelect: "Pilih pemandu...",
Â  Â  Â  Â  driverNoData: "Tiada pemandu dalam zon ini",
Â  Â  Â  Â  btnClear: "Kosongkan borang",
Â  Â  Â  Â  btnSave: "Simpan jadual",
Â  Â  Â  Â  addScheduleHeaderTitle: "Cipta jadual",
Â  Â  Â  Â  btnOpenSchedule: "Cipta jadual",

Â  Â  Â  Â  tableTitle: "Jadual Terkini",
Â  Â  Â  Â  countPrefix: "Menunjukkan",
Â  Â  Â  Â  countSuffix: "rekod",
Â  Â  Â  Â  loadingText: "Sedang memuatkan...",
Â  Â  Â  Â  noData: "Belum ada data jadual",

Â  Â  Â  Â  thZone: "Zon",
Â  Â  Â  Â  thRange: "Julat tarikh",
Â  Â  Â  Â  thTruck: "Lori",
Â  Â  Â  Â  thDriver: "Pemandu",
Â  Â  Â  Â  thCreated: "Direkodkan",

Â  Â  Â  Â  statusEndBeforeStart: "Tarikh tamat tidak boleh sebelum tarikh mula",
Â  Â  Â  Â  statusPastDate: "Tidak boleh simpan. Jadual untuk tarikhà¸—à¸µà¹ˆ sudah lepas tidak dibenarkan.",
Â  Â  Â  Â  statusSaveOk: "Jadual berjaya disimpan",
Â  Â  Â  Â  statusConflict: "Tidak boleh simpan. Zon ini sudah mempunyai jadual lori dalam julat tarikh tersebut.",

Â  Â  Â  Â  cleared: ""
Â  Â  Â  }
Â  Â  };

Â  Â  const LangState = window.AdminLang;
Â  Â  let currentLang = (LangState && typeof LangState.getLang === "function")
Â  Â  Â  ? LangState.getLang()
Â  Â  Â  : (localStorage.getItem("sw_lang") || "th");
Â  Â  const langSelect = document.getElementById("langSelect");
Â  Â  const langIconBtn = document.getElementById("langIconBtn");
Â  Â  const langMenu = document.getElementById("langMenu");

Â  Â  function tr(key) {
Â  Â  Â  const t = translations[currentLang] || translations.th;
Â  Â  Â  return t[key] !== undefined ? t[key] : key;
Â  Â  }

Â  Â  function setFormStatusText(text, type) {
Â  Â  Â  formStatus.textContent = text || "";
Â  Â  Â  formStatus.className = "muted" + (type === "ok" ? " ok" : type === "err" ? " err" : "");
Â  Â  }

Â  Â  /* role label à¸•à¸²à¸¡à¸ à¸²à¸©à¸² (à¹€à¸«à¸¡à¸·à¸­à¸™à¸«à¸™à¹‰à¸² bins) */
Â  Â  const ROLE_LABELS = {
Â  Â  Â  th: {
Â  Â  Â  Â  0: "à¸œà¸¹à¹‰à¸”à¸¹à¹à¸¥à¸£à¸°à¸šà¸š",
Â  Â  Â  Â  1: "à¸à¸™à¸±à¸à¸‡à¸²à¸™à¸‚à¸±à¸šà¸£à¸–",
Â  Â  Â  Â  2: "à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸—à¸±à¹ˆà¸§à¹„à¸›"
Â  Â  Â  },
Â  Â  Â  en: {
Â  Â  Â  Â  0: "Administrator",
Â  Â  Â  Â  1: "Driver",
Â  Â  Â  Â  2: "Resident User"
Â  Â  Â  },
Â  Â  Â  ms: {
Â  Â  Â  Â  0: "Pentadbir",
Â  Â  Â  Â  1: "Pemandu",
Â  Â  Â  Â  2: "Pengguna"
Â  Â  Â  }
Â  Â  };

Â  Â  async function loadCurrentUserProfile() {
Â  Â  Â  try {
Â  Â  Â  Â  let usernameKey = currentUser && (currentUser.username || currentUser.uid || currentUser.email);
Â  Â  Â  Â  if (!usernameKey) return;

Â  Â  Â  Â  const docSnap = await usersCol.doc(usernameKey).get();
Â  Â  Â  Â  if (docSnap.exists) {
Â  Â  Â  Â  Â  const data = docSnap.data() || {};
Â  Â  Â  Â  Â  currentUserProfile = {
Â  Â  Â  Â  Â  Â  ...data,
Â  Â  Â  Â  Â  Â  username: data.username || docSnap.id
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  currentUserProfile = {
Â  Â  Â  Â  Â  Â  username: usernameKey,
Â  Â  Â  Â  Â  Â  status: currentUser && typeof currentUser.status === "number" ? currentUser.status : 0
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  Â  Â  applyProfileInfo();
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("loadCurrentUserProfile error", e);
Â  Â  Â  }
Â  Â  }

Â  Â  function applyProfileInfo() {
Â  Â  Â  if (!profileNameEl || !profileRoleEl || !currentUserProfile) return;

Â  Â  Â  const fullName = (currentUserProfile.fullName || "").trim();
Â  Â  Â  const username = currentUserProfile.username || currentUser?.username || "";
Â  Â  Â  const statusVal = typeof currentUserProfile.status === "number"
Â  Â  Â  Â  ? currentUserProfile.status
Â  Â  Â  Â  : (currentUser && typeof currentUser.status === "number" ? currentUser.status : 0);

Â  Â  Â  const roleMap = ROLE_LABELS[currentLang] || ROLE_LABELS.th;

Â  Â  Â  profileNameEl.textContent = fullName || username || "â€”";
Â  Â  Â  profileRoleEl.textContent = roleMap[statusVal] || "";
Â  Â  }

Â  Â  function updateLangMenuActive() {
Â  Â  Â  if (!langMenu) return;
Â  Â  Â  langMenu.querySelectorAll("button[data-lang]").forEach(btn => {
Â  Â  Â  Â  btn.classList.toggle("active", btn.dataset.lang === currentLang);
Â  Â  Â  });
Â  Â  }

Â  Â  function applyLanguage() {
Â  Â  Â  document.title = tr("pageTitle");
Â  Â  Â  document.getElementById("menuToggle").textContent = tr("menuBtn");

Â  Â  Â  document.getElementById("mainTitle").textContent = tr("mainTitle");
Â  Â  Â  // document.getElementById("pageHint").textContent = tr("pageHint"); // à¹„à¸¡à¹ˆà¸¡à¸µ element à¸™à¸µà¹‰à¹ƒà¸™ HTML

Â  Â  Â  document.getElementById("scheduleModalTitle").textContent = tr("formTitle");
Â  Â  Â  document.getElementById("labelStart").textContent = tr("labelStart");
Â  Â  Â  document.getElementById("labelEnd").textContent = tr("labelEnd");
Â  Â  Â  document.getElementById("labelZone").textContent = tr("labelZone");
Â  Â  Â  document.getElementById("labelTruck").textContent = tr("labelTruck");
Â  Â  Â  document.getElementById("labelDriver").textContent = tr("labelDriver");
Â  Â  Â  document.getElementById("btnClear").textContent = tr("btnClear");
Â  Â  Â  document.getElementById("btnSave").textContent = tr("btnSave");

Â  Â  Â  document.getElementById("addScheduleHeaderTitle").textContent = tr("addScheduleHeaderTitle");
Â  Â  Â  document.getElementById("btnOpenScheduleForm").textContent = tr("btnOpenSchedule");

Â  Â  Â  document.getElementById("tableTitle").textContent = tr("tableTitle");
Â  Â  Â  document.getElementById("thZone").textContent = tr("thZone");
Â  Â  Â  document.getElementById("thRange").textContent = tr("thRange");
Â  Â  Â  document.getElementById("thTruck").textContent = tr("thTruck");
Â  Â  Â  document.getElementById("thDriver").textContent = tr("thDriver");
Â  Â  Â  document.getElementById("thCreated").textContent = tr("thCreated");
Â  Â  Â  document.getElementById("loadingText").textContent = tr("loadingText");

Â  Â  Â  if (zoneSelect.options.length > 0) {
Â  Â  Â  Â  zoneSelect.options[0].textContent = tr("zonePlaceholder");
Â  Â  Â  }

Â  Â  Â  // à¸­à¸±à¸›à¹€à¸”à¸• Placeholder à¸‚à¸­à¸‡ Select
Â  Â  Â  if (truckSelect.disabled) {
Â  Â  Â  Â  truckSelect.innerHTML = '<option value="">' + tr("truckPlaceholder") + '</option>';
Â  Â  Â  }
Â  Â  Â  if (driverSelect.disabled) {
Â  Â  Â  Â  driverSelect.innerHTML = '<option value="">' + tr("driverPlaceholder") + '</option>';
Â  Â  Â  }

Â  Â  Â  // sync à¸à¸±à¸š AdminNav/AdminUser à¸–à¹‰à¸²à¸¡à¸µ
Â  Â  Â  if (window.AdminNav && typeof window.AdminNav.setLanguage === "function") {
Â  Â  Â  Â  window.AdminNav.setLanguage(currentLang);
Â  Â  Â  }
Â  Â  Â  if (window.AdminUser && typeof window.AdminUser.setLanguage === "function") {
Â  Â  Â  Â  window.AdminUser.setLanguage(currentLang);
Â  Â  Â  }

Â  Â  Â  renderSchedules();
Â  Â  Â  applyProfileInfo();
Â  Â  Â  updateLangMenuActive();
Â  Â  }

Â  Â  function changeLanguage(lang) {
Â  Â  Â  if (!translations[lang]) return;
Â  Â  Â  if (LangState && typeof LangState.setLang === "function") {
Â  Â  Â  Â  LangState.setLang(lang);
Â  Â  Â  Â  currentLang = LangState.getLang();
Â  Â  Â  } else {
Â  Â  Â  Â  currentLang = lang;
Â  Â  Â  Â  localStorage.setItem("sw_lang", lang);
Â  Â  Â  }
Â  Â  Â  langSelect.value = currentLang;
Â  Â  Â  applyLanguage();
Â  Â  }

Â  Â  langSelect.addEventListener("change", e => changeLanguage(e.target.value));
Â  Â  langSelect.value = currentLang;

Â  Â  langIconBtn.addEventListener("click", () => {
Â  Â  Â  langMenu.classList.toggle("show");
Â  Â  });

Â  Â  langMenu.addEventListener("click", e => {
Â  Â  Â  const btn = e.target.closest("button[data-lang]");
Â  Â  Â  if (!btn) return;
Â  Â  Â  changeLanguage(btn.dataset.lang);
Â  Â  Â  langMenu.classList.remove("show");
Â  Â  });

Â  Â  if (LangState && typeof LangState.onChange === "function") {
Â  Â  Â  LangState.onChange(lang => {
Â  Â  Â  Â  if (lang && lang !== currentLang) {
Â  Â  Â  Â  Â  currentLang = lang;
Â  Â  Â  Â  Â  langSelect.value = lang;
Â  Â  Â  Â  Â  applyLanguage();
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  // à¸›à¸´à¸”à¹€à¸¡à¸™à¸¹à¸ à¸²à¸©à¸² (à¹„à¸¡à¹ˆà¸¢à¸¸à¹ˆà¸‡à¸à¸±à¸š sidebar à¹€à¸à¸£à¸²à¸°à¹ƒà¸Šà¹‰ backdrop à¹à¸¥à¹‰à¸§)
Â  Â  document.addEventListener("click", e => {
Â  Â  Â  const clickedInLang = langMenu.contains(e.target) || langIconBtn.contains(e.target);
Â  Â  Â  if (!clickedInLang) langMenu.classList.remove("show");
Â  Â  });

Â  Â  /* à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ (Zones, Trucks, Drivers) */
Â  Â  async function loadInitialData() {
Â  Â  Â  try {
Â  Â  Â  Â  // 1. à¹‚à¸«à¸¥à¸” Zones
Â  Â  Â  Â  const snapZones = await zonesCol.get();
Â  Â  Â  Â  zones = [];
Â  Â  Â  Â  zoneSelect.innerHTML = '<option value="">' + tr("zonePlaceholder") + '</option>';
Â  Â  Â  Â  snapZones.forEach(doc => {
Â  Â  Â  Â  Â  const d = doc.data();
Â  Â  Â  Â  Â  zones.push({ id: doc.id, name: d.name });
Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  opt.value = doc.id;
Â  Â  Â  Â  Â  opt.textContent = d.name;
Â  Â  Â  Â  Â  zoneSelect.appendChild(opt);
Â  Â  Â  Â  });

Â  Â  Â  Â  // 2. à¹‚à¸«à¸¥à¸” Trucks à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” (à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸¡à¸µà¸à¸²à¸£à¸à¸£à¸­à¸‡ zone à¹ƒà¸™ Firebase)
Â  Â  Â  Â  const snapTrucks = await trucksCol.get();
Â  Â  Â  Â  trucks = [];
Â  Â  Â  Â  snapTrucks.forEach(doc => {
Â  Â  Â  Â  Â  const d = doc.data();
Â  Â  Â  Â  Â  trucks.push({ id: doc.id, truckId: d.truckId || "", zoneId: d.zone });
Â  Â  Â  Â  });

Â  Â  Â  Â  // 3. à¹‚à¸«à¸¥à¸” Drivers à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” (à¸à¸£à¸­à¸‡à¹€à¸‰à¸à¸²à¸° status: 1)
Â  Â  Â  Â  const snapDrivers = await usersCol.where("status", "==", 1).get();
Â  Â  Â  Â  drivers = [];
Â  Â  Â  Â  snapDrivers.forEach(doc => {
Â  Â  Â  Â  Â  const d = doc.data();
Â  Â  Â  Â  Â  drivers.push({
Â  Â  Â  Â  Â  Â  username: doc.id,
Â  Â  Â  Â  Â  Â  fullName: d.fullName || "",
Â  Â  Â  Â  Â  Â  driverId: d.driverId || "",
Â  Â  Â  Â  Â  Â  zoneId: d.zoneId
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  console.log("Initial data loaded: ", { zones: zones.length, trucks: trucks.length, drivers: drivers.length });
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error loading initial data:", e);
Â  Â  Â  Â  alert("à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¹„à¸”à¹‰: " + e.message);
Â  Â  Â  }
Â  Â  }

Â  Â  /* à¸”à¸¶à¸‡à¸£à¸–à¹ƒà¸™à¹€à¸‚à¸•à¸ˆà¸²à¸à¸•à¸±à¸§à¹à¸›à¸£ JS */
Â  Â  function loadTrucks(zoneId) {
Â  Â  Â  truckSelect.innerHTML = '<option value="">' + tr("truckSelect") + '</option>';
Â  Â  Â  truckSelect.disabled = true;

Â  Â  Â  const filteredTrucks = trucks.filter(t => t.zoneId === zoneId);

Â  Â  Â  if (filteredTrucks.length === 0) {
Â  Â  Â  Â  truckSelect.innerHTML = '<option value="">' + tr("truckNoData") + '</option>';
Â  Â  Â  } else {
Â  Â  Â  Â  filteredTrucks.forEach(d => {
Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  opt.value = d.id;
Â  Â  Â  Â  Â  opt.textContent = d.id + " â€¢ " + d.truckId;
Â  Â  Â  Â  Â  truckSelect.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  truckSelect.disabled = false;
Â  Â  }

Â  Â  /* à¸”à¸¶à¸‡à¸„à¸™à¸‚à¸±à¸šà¹ƒà¸™à¹€à¸‚à¸•à¸ˆà¸²à¸à¸•à¸±à¸§à¹à¸›à¸£ JS */
Â  Â  function loadDrivers(zoneId) {
Â  Â  Â  driverSelect.innerHTML = '<option value="">' + tr("driverSelect") + '</option>';
Â  Â  Â  driverSelect.disabled = true;

Â  Â  Â  const filteredDrivers = drivers.filter(d => d.zoneId === zoneId);

Â  Â  Â  if (filteredDrivers.length === 0) {
Â  Â  Â  Â  driverSelect.innerHTML = '<option value="">' + tr("driverNoData") + '</option>';
Â  Â  Â  } else {
Â  Â  Â  Â  filteredDrivers.forEach(d => {
Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  opt.value = d.username;
Â  Â  Â  Â  Â  opt.textContent = (d.driverId || d.username) + " â€¢ " + d.fullName;
Â  Â  Â  Â  Â  opt.dataset.driverId = d.driverId || "";
Â  Â  Â  Â  Â  opt.dataset.driverName = d.fullName || "";
Â  Â  Â  Â  Â  driverSelect.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  driverSelect.disabled = false;
Â  Â  }

Â  Â  zoneSelect.addEventListener("change", () => {
Â  Â  Â  const selectedZone = zoneSelect.value;
Â  Â  Â  if (!selectedZone) {
Â  Â  Â  Â  truckSelect.value = "";
Â  Â  Â  Â  driverSelect.value = "";
Â  Â  Â  Â  truckSelect.disabled = true;
Â  Â  Â  Â  driverSelect.disabled = true;
Â  Â  Â  Â  truckSelect.innerHTML = '<option value="">' + tr("truckPlaceholder") + '</option>';
Â  Â  Â  Â  driverSelect.innerHTML = '<option value="">' + tr("driverPlaceholder") + '</option>';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  loadTrucks(selectedZone); // ğŸ‘ˆ à¸”à¸¶à¸‡à¸ˆà¸²à¸ Cache (à¹€à¸£à¹‡à¸§à¸‚à¸¶à¹‰à¸™à¸¡à¸²à¸)
Â  Â  Â  loadDrivers(selectedZone); // ğŸ‘ˆ à¸”à¸¶à¸‡à¸ˆà¸²à¸ Cache (à¹€à¸£à¹‡à¸§à¸‚à¸¶à¹‰à¸™à¸¡à¸²à¸)
Â  Â  });

Â  Â  /* helper: list à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ˆà¸²à¸ start à¸–à¸¶à¸‡ end à¹€à¸›à¹‡à¸™ 'YYYY-MM-DD' */
Â  Â  function listDates(startStr, endStr) {
Â  Â  Â  const days = [];
Â  Â  Â  const cur = new Date(startStr + "T00:00:00");
Â  Â  Â  const end = new Date(endStr + "T00:00:00");
Â  Â  Â  while (cur <= end) {
Â  Â  Â  Â  const y = cur.getFullYear();
Â  Â  Â  Â  const m = String(cur.getMonth() + 1).padStart(2, "0");
Â  Â  Â  Â  const d = String(cur.getDate()).padStart(2, "0");
Â  Â  Â  Â  days.push(`${y}-${m}-${d}`);
Â  Â  Â  Â  cur.setDate(cur.getDate() + 1);
Â  Â  Â  }
Â  Â  Â  return days;
Â  Â  }

Â  Â  /* helper: à¹à¸›à¸¥à¸‡ YYYY-MM-DD â†’ string à¸•à¸²à¸¡à¸ à¸²à¸©à¸² */
Â  Â  function formatDateList(arr) {
Â  Â  Â  const locale =
Â  Â  Â  Â  currentLang === "th" ? "th-TH" :
Â  Â  Â  Â  Â  currentLang === "ms" ? "ms-MY" : "en-GB";
Â  Â  Â  return arr.map(str => {
Â  Â  Â  Â  return new Date(str + "T00:00:00").toLocaleDateString(locale);
Â  Â  Â  }).join(", ");
Â  Â  }

Â  Â  /* helper: à¹à¸šà¹ˆà¸‡ freeDays à¹€à¸›à¹‡à¸™à¸Šà¹ˆà¸§à¸‡à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡ */
Â  Â  function groupContiguous(dates) {
Â  Â  Â  if (!dates.length) return [];
Â  Â  Â  const sorted = [...dates].sort();
Â  Â  Â  const groups = [];
Â  Â  Â  let start = sorted[0];
Â  Â  Â  let prev = sorted[0];

Â  Â  Â  function isNextDay(a, b) {
Â  Â  Â  Â  const da = new Date(a + "T00:00:00");
Â  Â  Â  Â  const db = new Date(b + "T00:00:00");
Â  Â  Â  Â  return (db - da) === 24 * 60 * 60 * 1000;
Â  Â  Â  }

Â  Â  Â  for (let i = 1; i < sorted.length; i++) {
Â  Â  Â  Â  const cur = sorted[i];
Â  Â  Â  Â  if (isNextDay(prev, cur)) {
Â  Â  Â  Â  Â  prev = cur;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  groups.push([start, prev]);
Â  Â  Â  Â  Â  start = prev = cur;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  groups.push([start, prev]);
Â  Â  Â  return groups;
Â  Â  }

Â  Â  /* helper: doc id = {zone_YYYY-MM-DD_HH-mm-ss-SSS} */
Â  Â  function buildDocId(zone) {
Â  Â  Â  const now = new Date();
Â  Â  Â  const yyyy = now.getFullYear();
Â  Â  Â  const mm = String(now.getMonth() + 1).padStart(2, "0");
Â  Â  Â  const dd = String(now.getDate()).padStart(2, "0");
Â  Â  Â  const hh = String(now.getHours()).padStart(2, "0");
Â  Â  Â  const mi = String(now.getMinutes()).padStart(2, "0");
Â  Â  Â  const ss = String(now.getSeconds()).padStart(2, "0");
Â  Â  Â  const ms = String(now.getMilliseconds()).padStart(3, "0");
Â  Â  Â  return `${zone}_${yyyy}-${mm}-${dd}_${hh}-${mi}-${ss}-${ms}`;
Â  Â  }

Â  Â  /* à¸šà¸±à¸™à¸—à¸¶à¸à¸•à¸²à¸£à¸²à¸‡ (à¹€à¸«à¸¡à¸·à¸­à¸™à¹€à¸”à¸´à¸¡ à¹„à¸¡à¹ˆà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ logic) */
Â  Â  document.getElementById("scheduleForm").addEventListener("submit", async (e) => {
Â  Â  Â  e.preventDefault();

Â  Â  Â  const s = startDate.value;
Â  Â  Â  const e2 = endDate.value;
Â  Â  Â  const zone = zoneSelect.value;
Â  Â  Â  const truck = truckSelect.value;
Â  Â  Â  const driver = driverSelect.value;

Â  Â  Â  if (!s || !e2 || !zone || !truck || !driver) return;

Â  Â  Â  // à¸§à¸±à¸™à¸™à¸µà¹‰à¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸š YYYY-MM-DD
Â  Â  Â  const now = new Date();
Â  Â  Â  const yyyy = now.getFullYear();
Â  Â  Â  const mm = String(now.getMonth() + 1).padStart(2, "0");
Â  Â  Â  const dd = String(now.getDate()).padStart(2, "0");
Â  Â  Â  const todayStr = `${yyyy}-${mm}-${dd}`;

Â  Â  Â  if (s < todayStr) {
Â  Â  Â  Â  setFormStatusText(tr("statusPastDate"), "err");
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  if (e2 < s) {
Â  Â  Â  Â  setFormStatusText(tr("statusEndBeforeStart"), "err");
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  setFormStatusText("", "");

Â  Â  Â  const driverOpt = driverSelect.options[driverSelect.selectedIndex];
Â  Â  Â  const truckOpt = truckSelect.options[truckSelect.selectedIndex];

Â  Â  Â  // à¹ƒà¸Šà¹‰ startDateObj à¹à¸¥à¸° endDateObj à¹€à¸›à¹‡à¸™ 00:00:00 à¹à¸¥à¸° 23:59:59 à¹€à¸à¸·à¹ˆà¸­à¸„à¸£à¸­à¸šà¸„à¸¥à¸¸à¸¡à¸—à¸±à¹‰à¸‡à¸§à¸±à¸™
Â  Â  Â  const startDateObj = new Date(s + "T00:00:00");
Â  Â  Â  const endDateObj = new Date(e2 + "T23:59:59");
Â  Â  Â  
Â  Â  Â  // à¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™ Timestamp
Â  Â  Â  const startTs = firebase.firestore.Timestamp.fromDate(startDateObj);
Â  Â  Â  const endTs = firebase.firestore.Timestamp.fromDate(endDateObj);

Â  Â  Â  try {
Â  Â  Â  Â  // à¸”à¸¶à¸‡à¸•à¸²à¸£à¸²à¸‡à¸‚à¸­à¸‡à¹€à¸‚à¸•à¸™à¸µà¹‰à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” (à¸¢à¸±à¸‡à¸„à¸‡à¹ƒà¸Šà¹‰ Firestore à¹€à¸à¸·à¹ˆà¸­à¹€à¸Šà¹‡à¸„ Conflict)
Â  Â  Â  Â  const snap = await scheduleCol.where("zoneId", "==", zone).get();

Â  Â  Â  Â  const newDays = listDates(s, e2);
Â  Â  Â  Â  const overlapDays = [];
Â  Â  Â  Â  const freeDays = [];

Â  Â  Â  Â  const existing = [];
Â  Â  Â  Â  snap.forEach(doc => {
Â  Â  Â  Â  Â  const d = doc.data();
Â  Â  Â  Â  Â  if (!d.startDate || !d.endDate) return;
Â  Â  Â  Â  Â  existing.push({
Â  Â  Â  Â  Â  Â  startMs: d.startDate.toMillis(),
Â  Â  Â  Â  Â  Â  endMs: d.endDate.toMillis()
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  newDays.forEach(dStr => {
Â  Â  Â  Â  Â  const t0 = new Date(dStr + "T00:00:00").getTime();
Â  Â  Â  Â  Â  const t1 = new Date(dStr + "T23:59:59").getTime();
Â  Â  Â  Â  Â  let overlapped = false;
Â  Â  Â  Â  Â  for (const ex of existing) {
Â  Â  Â  Â  Â  Â  // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¸Šà¸™à¸à¸±à¸™à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
Â  Â  Â  Â  Â  Â  if (ex.startMs <= t1 && ex.endMs >= t0) {
Â  Â  Â  Â  Â  Â  Â  overlapped = true;
Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (overlapped) {
Â  Â  Â  Â  Â  Â  overlapDays.push(dStr);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  freeDays.push(dStr);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  if (overlapDays.length && !freeDays.length) {
Â  Â  Â  Â  Â  // à¸‹à¹‰à¸³à¸—à¸¸à¸à¸§à¸±à¸™
Â  Â  Â  Â  Â  const listText = formatDateList(overlapDays);
Â  Â  Â  Â  Â  if (currentLang === "th") {
Â  Â  Â  Â  Â  Â  setFormStatusText("à¸§à¸±à¸™à¸—à¸µà¹ˆ " + listText + " à¸¡à¸µà¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸•à¸²à¸£à¸²à¸‡à¹à¸¥à¹‰à¸§", "err");
Â  Â  Â  Â  Â  } else if (currentLang === "en") {
Â  Â  Â  Â  Â  Â  setFormStatusText("Dates " + listText + " already have schedules in this zone.", "err");
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  setFormStatusText("Tarikh " + listText + " sudah mempunyai jadual dalam zon ini.", "err");
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (overlapDays.length && freeDays.length) {
Â  Â  Â  Â  Â  // à¸‹à¹‰à¸³à¸šà¸²à¸‡à¸§à¸±à¸™ â†’ à¸–à¸²à¸¡à¸¢à¸·à¸™à¸¢à¸±à¸™
Â  Â  Â  Â  Â  const dupText = formatDateList(overlapDays);
Â  Â  Â  Â  Â  const freeText = formatDateList(freeDays);
Â  Â  Â  Â  Â  let msg;
Â  Â  Â  Â  Â  if (currentLang === "th") {
Â  Â  Â  Â  Â  Â  msg = `à¸§à¸±à¸™à¸—à¸µà¹ˆ ${dupText} à¸¡à¸µà¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸•à¸²à¸£à¸²à¸‡à¹à¸¥à¹‰à¸§\nà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸‰à¸à¸²à¸°à¸§à¸±à¸™à¸—à¸µà¹ˆ ${freeText} à¸¥à¸‡à¹ƒà¸™à¸•à¸²à¸£à¸²à¸‡à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ?`;
Â  Â  Â  Â  Â  } else if (currentLang === "en") {
Â  Â  Â  Â  Â  Â  msg = `These dates already have schedules: ${dupText}\nDo you want to save only these free dates: ${freeText}?`;
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  msg = `Tarikh berikut sudah ada jadual: ${dupText}\nAdakah anda mahu simpan hanya tarikh berikut: ${freeText}?`;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const ok = window.confirm(msg);
Â  Â  Â  Â  Â  if (!ok) {
Â  Â  Â  Â  Â  Â  setFormStatusText(tr("statusConflict"), "err");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  if (!freeDays.length) {
Â  Â  Â  Â  Â  setFormStatusText(tr("statusConflict"), "err");
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // à¹à¸šà¹ˆà¸‡ freeDays à¹€à¸›à¹‡à¸™à¸Šà¹ˆà¸§à¸‡à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡à¹à¸¥à¹‰à¸§à¸šà¸±à¸™à¸—à¸¶à¸à¸—à¸µà¸¥à¸°à¸Šà¹ˆà¸§à¸‡
Â  Â  Â  Â  const groups = groupContiguous(freeDays);

Â  Â  Â  Â  for (const [startStr, endStr] of groups) {
Â  Â  Â  Â  Â  const startObj = new Date(startStr + "T00:00:00");
Â  Â  Â  Â  Â  const endObj = new Date(endStr + "T23:59:59");

Â  Â  Â  Â  Â  const sTs = firebase.firestore.Timestamp.fromDate(startObj);
Â  Â  Â  Â  Â  const eTs = firebase.firestore.Timestamp.fromDate(endObj);

Â  Â  Â  Â  Â  const docId = buildDocId(zone); // doc id = {zone_à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸§à¸¥à¸² à¸“ à¸•à¸­à¸™à¸šà¸±à¸™à¸—à¸¶à¸}

Â  Â  Â  Â  Â  await scheduleCol.doc(docId).set({
Â  Â  Â  Â  Â  Â  zoneId: zone,
Â  Â  Â  Â  Â  Â  zoneName: zones.find(z => z.id === zone)?.name,
Â  Â  Â  Â  Â  Â  truckId: truck,
Â  Â  Â  Â  Â  Â  truckName: truckOpt.textContent,
Â  Â  Â  Â  Â  Â  driverUsername: driver,
Â  Â  Â  Â  Â  Â  driverName: driverOpt.dataset.driverName,
Â  Â  Â  Â  Â  Â  driverId: driverOpt.dataset.driverId,
Â  Â  Â  Â  Â  Â  startDate: sTs,
Â  Â  Â  Â  Â  Â  endDate: eTs,
Â  Â  Â  Â  Â  Â  createdAt: FieldValue.serverTimestamp()
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  setFormStatusText(tr("statusSaveOk"), "ok");
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  setFormStatusText(err.message || "Error", "err");
Â  Â  Â  }
Â  Â  });

Â  Â  /* à¸›à¸¸à¹ˆà¸¡à¸¥à¹‰à¸²à¸‡à¸Ÿà¸­à¸£à¹Œà¸¡ */
Â  Â  btnClear.addEventListener("click", () => {
Â  Â  Â  startDate.value = "";
Â  Â  Â  endDate.value = "";
Â  Â  Â  zoneSelect.value = "";
Â  Â  Â  truckSelect.disabled = true;
Â  Â  Â  driverSelect.disabled = true;
Â  Â  Â  truckSelect.innerHTML = '<option value="">' + tr("truckPlaceholder") + '</option>';
Â  Â  Â  driverSelect.innerHTML = '<option value="">' + tr("driverPlaceholder") + '</option>';
Â  Â  Â  setFormStatusText(tr("cleared"), "");
Â  Â  });

Â  Â  /* Modal à¸Ÿà¸­à¸£à¹Œà¸¡à¸ˆà¸±à¸”à¸•à¸²à¸£à¸²à¸‡ */
Â  Â  function openScheduleModal() {
Â  Â  Â  // à¸£à¸µà¹€à¸‹à¹‡à¸•à¸Ÿà¸­à¸£à¹Œà¸¡à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆà¹€à¸›à¸´à¸”
Â  Â  Â  btnClear.click(); 
Â  Â  Â  scheduleModalBackdrop.classList.add("show");
Â  Â  Â  lockBodyScroll(true);
Â  Â  }
Â  Â  function closeScheduleModal() {
Â  Â  Â  scheduleModalBackdrop.classList.remove("show");
Â  Â  Â  lockBodyScroll(false);
Â  Â  }

Â  Â  btnOpenScheduleForm.addEventListener("click", openScheduleModal);
Â  Â  btnScheduleClose.addEventListener("click", closeScheduleModal);

Â  Â  scheduleModalBackdrop.addEventListener("click", (e) => {
Â  Â  Â  if (e.target === scheduleModalBackdrop) {
Â  Â  Â  Â  closeScheduleModal();
Â  Â  Â  }
Â  Â  });

Â  Â  /* à¹‚à¸«à¸¥à¸”à¸•à¸²à¸£à¸²à¸‡ */
Â  Â  function setupScheduleListener() {
Â  Â  Â  // à¸¢à¸±à¸‡à¸„à¸‡à¹€à¸›à¹‡à¸™ Real-time listener à¹à¸•à¹ˆà¸ˆà¸³à¸à¸±à¸”à¹à¸„à¹ˆ 100 à¸£à¸²à¸¢à¸à¸²à¸£à¸¥à¹ˆà¸²à¸ªà¸¸à¸”
Â  Â  Â  scheduleCol.orderBy("createdAt", "desc").limit(100)
Â  Â  Â  Â  .onSnapshot(sn => {
Â  Â  Â  Â  Â  schedules = [];
Â  Â  Â  Â  Â  sn.forEach(doc => {
Â  Â  Â  Â  Â  Â  const d = doc.data();
Â  Â  Â  Â  Â  Â  const start = d.startDate?.toDate();
Â  Â  Â  Â  Â  Â  const end = d.endDate?.toDate();
Â  Â  Â  Â  Â  Â  const created = d.createdAt?.toDate();

Â  Â  Â  Â  Â  Â  schedules.push({
Â  Â  Â  Â  Â  Â  Â  zoneName: d.zoneName,
Â  Â  Â  Â  Â  Â  Â  truckId: d.truckId,
Â  Â  Â  Â  Â  Â  Â  truckName: d.truckName,
Â  Â  Â  Â  Â  Â  Â  driverName: d.driverName,
Â  Â  Â  Â  Â  Â  Â  driverId: d.driverId,
Â  Â  Â  Â  Â  Â  Â  start: start?.toLocaleDateString(),
Â  Â  Â  Â  Â  Â  Â  end: end?.toLocaleDateString(),
Â  Â  Â  Â  Â  Â  Â  created: created?.toLocaleString()
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  renderSchedules();
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function renderSchedules() {
Â  Â  Â  if (!scheduleTbody) return;

Â  Â  Â  if (!schedules.length) {
Â  Â  Â  Â  countLabel.textContent = tr("countPrefix") + " 0 " + tr("countSuffix");
Â  Â  Â  Â  scheduleTbody.innerHTML = '<tr><td colspan="5" class="muted">' + tr("noData") + '</td></tr>';
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  countLabel.textContent = tr("countPrefix") + " " + schedules.length + " " + tr("countSuffix");

Â  Â  Â  scheduleTbody.innerHTML = schedules.map(s => `
Â  Â  Â  <tr>
Â  Â  Â  Â  <td><span class="badge-zone">${s.zoneName}</span></td>
Â  Â  Â  Â  <td>${s.start} - ${s.end}</td>
Â  Â  Â  Â  <td>${s.truckId}</td>
Â  Â  Â  Â  <td>${s.driverId} â€¢ ${s.driverName}</td>
Â  Â  Â  Â  <td>${s.created}</td>
Â  Â  Â  </tr>
Â  Â  `).join("");
Â  Â  }

Â  Â  (async () => {
Â  Â  Â  langSelect.value = currentLang;
Â  Â  Â  applyLanguage();
Â  Â  Â  await loadInitialData(); // ğŸ‘ˆ à¹‚à¸«à¸¥à¸” zones, trucks, drivers à¸„à¸£à¸±à¹‰à¸‡à¹€à¸”à¸µà¸¢à¸§
Â  Â  Â  setupScheduleListener();
Â  Â  Â  await loadCurrentUserProfile();
Â  Â  })();
Â  </script>

</body>

</html>