<!doctype html>
<html lang="">

<head>
    <meta charset="utf-8" />
    <title>Smart Waste - ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏á</title>

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="a_style.css">
    <link rel="stylesheet" href="addBin_style.css">

    <!-- ================= Firebase / Libs ================= -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- ================= Auth ================= -->
    <script src="../Login/auth.js"></script>

    <!-- ================= i18n CORE ================= -->
    <script src="../i18n/lang.js"></script>

    <!-- ================= Language packs ================= -->
    <script src="../i18n/th.js"></script>
    <script src="../i18n/en.js"></script>
    <script src="../i18n/ms.js"></script>

    <!-- ================= Admin language bridge ================= -->
    <script src="admin-lang.js"></script>

    <!-- ================= Page logic ================= -->
    <script src="admin-user.js" defer></script>
    <script src="admin-nav.js" defer></script>
    <script src="admin-profile.js" defer></script>
    <script src="admin-auth-bootstrap.js" defer></script>
</head>

<body>
    <button class="toggle-btn" id="menuToggleBtn">‚ò∞ ‡πÄ‡∏°‡∏ô‡∏π</button>

    <aside class="sidebar" id="sidebar">
        <h2>Smart Waste</h2>
        <nav class="menu" data-admin-menu data-active="register"></nav>
        <div class="sw-logout-slot" data-sw-logout-slot></div>
    </aside>

    <main>
        <div class="topbar">
            <div>
                <h1 id="pageTitleHeading">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏á</h1>
            </div>
            <div class="topbar-right">
                <div class="lang-switcher">
                    <button class="icon-btn" id="langIconBtn" type="button" aria-label="">
                        <img src="images/lang-icon.png" alt="Language" class="top-icon">
                    </button>
                    <div class="lang-menu" id="langMenu">
                        <button type="button" data-lang="th">‡πÑ‡∏ó‡∏¢</button>
                        <button type="button" data-lang="en">English</button>
                        <button type="button" data-lang="ms">Bahasa Melayu</button>
                    </div>
                    <select id="langSelect" style="display:none;">
                        <option value="th">‡πÑ‡∏ó‡∏¢</option>
                        <option value="en">English</option>
                        <option value="ms">Bahasa Melayu</option>
                    </select>
                </div>

                <a href="profile.html" class="user-chip" id="profileBtn">
                    <img src="images/profile-icon.png" alt="Profile" class="top-icon user-avatar">
                    <div class="user-chip-text">
                        <div class="user-chip-name" id="profileName">User Name</div>
                        <div class="user-chip-role" id="profileRole">Role</div>
                    </div>
                </a>
            </div>
        </div>

        <div class="content">
            <div class="add-bin-header">
                <div class="add-bin-title" id="addBinHeaderTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞</div>
                <button type="button" class="primary" id="btnToggleForm">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞</button>
            </div>

            <div class="filters">
                <div class="filter-inputs">
                    <label class="filter-field">
                        <span class="muted" id="filterZoneLabel">‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span>
                        <select id="filterZone">
                            <option value="">‡πÄ‡∏Ç‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        </select>
                    </label>

                    <label class="filter-field">
                        <span class="muted" id="filterAreaLabel">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡∏¢ (Area)</span>
                        <select id="filterArea" disabled>
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        </select>
                    </label>

                    <label class="filter-field">
                        <span class="muted" id="filterBinLabel">BIN / ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</span>
                        <input id="filterBinText" type="text">
                    </label>
                </div>
                <span id="binsStatus" class="muted"></span>
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th id="thZone">‡πÄ‡∏Ç‡∏ï</th>
                            <th id="thArea">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡∏¢</th>
                            <th id="thBin">BIN</th>
                            <th id="thOwner">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ñ‡∏±‡∏á</th>
                            <th id="thRfid">RFID</th>
                            <th id="thCoords">‡∏û‡∏¥‡∏Å‡∏±‡∏î (lat,lng)</th>
                            <th id="thDetails">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                            <th id="thUpdated">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                            <th id="thManage">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="binsRows"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div class="modal-backdrop zone-area-modal" id="zoneModalBackdrop">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="zoneModalTitle"></div>
                <button type="button" class="modal-close" id="btnCloseZoneModal">‚úï</button>
            </div>

            <div id="zoneList"></div>


            <hr style="margin:10px 0">

            <div class="zone-row">
                <input type="text" id="newZoneName">
                <button type="button" class="primary" id="btnAddZone">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏ï</button>
            </div>

            <div class="modal-footer">
                <span class="muted" id="zoneModalMsg"></span>
                <button type="button" class="ghost" id="btnZoneDone">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>

        </div>
    </div>

    <div class="modal-backdrop zone-area-modal" id="areaModalBackdrop">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="areaModalTitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡∏¢ (Area) ‡πÉ‡∏ô <span id="currentZoneName"
                        style="color:#2563eb"></span></div>
                <button type="button" class="modal-close" id="btnCloseAreaModal">‚úï</button>
            </div>

            <div id="areaList"></div>


            <hr style="margin:10px 0">

            <div class="zone-row">
                <input type="text" id="newAreaName">
                <button type="button" class="primary" id="btnAddArea">‡πÄ‡∏û‡∏¥‡πà‡∏° Area</button>
            </div>

            <div class="modal-footer">
                <span class="muted" id="areaModalMsg"></span>
                <button type="button" class="ghost" id="btnAreaDone">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>

        </div>
    </div>

    <div class="modal-backdrop" id="addBinBackdrop">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="addBinModalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞</div>
                <button type="button" class="modal-close" id="btnAddClose">‚úï</button>
            </div>

            <form id="binForm" autocomplete="off">

                <!-- 1Ô∏è‚É£ MAC Address -->
                <div class="row">
                    <div style="flex:1 1 100%">
                        <label id="labelMacAddress"></label>
                        <div class="row" style="gap:8px">
                            <select id="macAddress" style="flex: 2 1 180px;">
                                <option value="" id="macLoadingOption"></option>
                            </select>
                            <button type="button" class="ghost" id="btnConfirmMac" disabled>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 2Ô∏è‚É£ RFID -->
                <div class="row">
                    <div style="flex:1 1 100%">
                        <label id="labelRfid">RFID Tag</label>
                        <input id="rfid" type="text" placeholder="‡∏™‡πÅ‡∏Å‡∏ô RFID Tag ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡πâ‡∏≠‡∏ô‡πÄ‡∏≠‡∏á" />
                    </div>
                </div>


                <!-- 3Ô∏è‚É£ Zone / Area -->
                <div class="row">
                    <div style="flex:1 1 260px">
                        <label id="labelZone">‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</label>
                        <select id="zone"></select>
                    </div>

                    <div style="flex:1 1 260px">
                        <label id="labelArea">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡∏¢ (Area)</label>
                        <select id="area" disabled></select>
                    </div>
                </div>

                <!-- 4Ô∏è‚É£ BIN ID + Owner -->
                <div class="row">
                    <div>
                        <label id="labelBinId">‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏±‡∏á</label>
                        <input id="binId" type="text" readonly />
                    </div>
                    <div>
                        <label id="labelOwner">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ñ‡∏±‡∏á</label>
                        <select id="owner"></select>
                    </div>
                </div>

                <!-- 5Ô∏è‚É£ ‡∏û‡∏¥‡∏Å‡∏±‡∏î -->
                <label id="labelPosition">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                <div class="row">
                    <div><input id="lng" type="number" step="any" placeholder="Longitude" /></div>
                    <div><input id="lat" type="number" step="any" placeholder="Latitude" /></div>
                </div>

                <!-- 6Ô∏è‚É£ ‡∏õ‡∏∏‡πà‡∏° GPS -->
                <div class="gps-actions">
                    <button type="button" id="btnGetPos" class="primary">‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å GPS</button>
                </div>

                <!-- 7Ô∏è‚É£ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
                <div class="row">
                    <div style="flex:1 1 100%">
                        <label id="labelDetails">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                        <textarea id="details"></textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="actions">
                        <button type="submit" class="primary" id="btnSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        <button type="button" class="ghost" id="btnReset">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
                    </div>
                    <span id="msg" class="muted"></span>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-backdrop" id="editModalBackdrop">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="editModalTitle">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞</div>
                <button type="button" class="modal-close" id="btnEditClose">‚úï</button>
            </div>

            <form id="editForm" autocomplete="off">
                <input type="hidden" id="editDocZone">
                <input type="hidden" id="editDocArea">
                <input type="hidden" id="editDocBinId">

                <div class="row">
                    <div>
                        <label id="editLabelZone">‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input id="editZoneDisplay" type="text" readonly />
                    </div>
                    <div>
                        <label id="editLabelArea">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡∏¢ (Area)</label>
                        <input id="editAreaDisplay" type="text" readonly />
                    </div>
                    <div>
                        <label id="editLabelBinId">‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏±‡∏á (BIN)</label>
                        <input id="editBinIdDisplay" type="text" readonly />
                    </div>
                </div>

                <div class="row">
                    <div>
                        <label id="editLabelRfid">RFID Tag</label>
                        <input id="editRfid" type="text" />
                    </div>

                    <div>
                        <label id="editLabelMacAddress">MAC Address</label>
                        <input id="editMacAddress" type="text" readonly />
                    </div>
                </div>

                <label id="editLabelPosition">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                <div class="row">
                    <div>
                        <input id="editLng" type="number" step="any" placeholder="‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î (longitude)" />
                    </div>
                    <div>
                        <input id="editLat" type="number" step="any" placeholder="‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î (latitude)" />
                    </div>
                </div>

                <div class="row">
                    <div style="flex:1 1 100%">
                        <label id="editLabelDetails">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                        <textarea id="editDetails"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <span id="editMsg" class="muted"></span>
                    <div style="display:flex;gap:8px;">
                        <button type="button" class="ghost" id="editCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="primary" id="btnSaveChanges">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    </div>
                </div>
                <div class="row">
                    <div class="actions">
                        <button type="submit" class="primary" id="btnSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        <button type="button" class="ghost" id="btnReset">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
                    </div>
                    <span id="msg" class="muted"></span>
                </div>

            </form>
        </div>
    </div>

    <script>
        // ‚úÖ App Check DEBUG MODE (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î)
        // self.FIREBASE_APPCHECK_DEBUG_TOKEN = '69292E90-2881-49B1-8F56-968136924EB1';
        // ---------- Firebase Configuration (‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ----------
        var firebaseConfig = {
            apiKey: "AIzaSyCyTSsRmX642krpJYOI-TfFpIhnxJBbzxk",
            authDomain: "smart-waste2568.firebaseapp.com",
            projectId: "smart-waste2568",
            storageBucket: "smart-waste2568.firebasestorage.app",
            messagingSenderId: "122699752010",
            appId: "1:122699752010:web:c22ab9b28ac15beaedbcb3",
            measurementId: "G-H82914YP66",
            // üö® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ (‡∏Å‡πä‡∏≠‡∏õ URL ‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Realtime Database ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
            databaseURL: "https://smart-waste2568-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const db = firebase.firestore();
        const rtdb = firebase.database();

        const zonesCol = db.collection("zones");
        const usersCol = db.collection("users");
        const allBinsGroup = db.collectionGroup("bin_data");

        // üö® NEW: RTDB Paths for RFID and MAC/Sensor
        const RTDB_RFID_PATH = 'rfid_input/tagId';
        const DEVICES_STATUS_BASE_PATH = 'esp32_devices';
        // END NEW
        // -----------------------------------------------------------
        // üîå ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏ü LED ‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏£‡πå‡∏î ESP32 (ON / OFF)
        // -----------------------------------------------------------
        async function setBoardLed(mac, state) {
            if (!mac) return;
            try {
                await rtdb
                    .ref(`${DEVICES_STATUS_BASE_PATH}/${mac}/command/led`)
                    .set(state);
            } catch (e) {
                console.error("LED command error", e);
            }
        }
        // üî¥ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (‡∏î‡∏±‡∏ö‡πÑ‡∏ü + ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°)
        async function releaseConfirmedMac() {
            if (confirmedMacTemp) {
                await setBoardLed(confirmedMacTemp, "OFF");

                await rtdb
                    .ref(`esp32_devices/${confirmedMacTemp}/currentAdmin`)
                    .remove();

                // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
                await rtdb
                    .ref(`admin_rfid_active/${window.ADMIN_AUTH.uid}`)
                    .remove();

                confirmedMacTemp = null;
            }

            macAddressEl.disabled = false;
            macAddressEl.value = "";

            btnConfirmMac.classList.remove("confirmed");
            btnConfirmMac.disabled = true;
        }

        const $ = id => document.getElementById(id);

        // ‡∏ü‡∏≠‡∏£‡πå‡∏° + ‡∏õ‡∏∏‡πà‡∏°
        const binForm = $("binForm");
        const binIdEl = $("binId");
        const zoneEl = $("zone");
        const areaEl = $("area"); // New Area element
        const ownerEl = $("owner");
        const rfidEl = $("rfid"); // RFID is now the first field
        const latEl = $("lat");
        const lngEl = $("lng");
        const detailsEl = $("details");
        const macAddressEl = $("macAddress"); // üö® NEW
        const btnConfirmMac = $("btnConfirmMac"); // üö® NEW

        const msg = $("msg");
        const btnReset = $("btnReset");
        const btnGetPos = $("btnGetPos");
        const menuToggleBtn = $("menuToggleBtn");
        const sidebarEl = $("sidebar");
        const langSelect = $("langSelect");
        const btnToggleForm = $("btnToggleForm");
        const addBinHeaderTitle = $("addBinHeaderTitle");
        const addBinBackdrop = $("addBinBackdrop");
        const btnAddClose = $("btnAddClose");

        // filter controls
        const binsStatusEl = $("binsStatus");
        const binsRowsEl = $("binsRows");
        const filterBinText = $("filterBinText");
        const filterZoneSelect = $("filterZone");
        const filterAreaSelect = $("filterArea"); // New Area Filter

        // zone modal
        const zoneModalBackdrop = $("zoneModalBackdrop");
        const zoneListEl = $("zoneList");
        const newZoneNameEl = $("newZoneName");
        const btnAddZone = $("btnAddZone");
        const btnCloseZoneModal = $("btnCloseZoneModal");
        const btnZoneDone = $("btnZoneDone");
        const zoneModalMsg = $("zoneModalMsg");

        // area modal
        const areaModalBackdrop = $("areaModalBackdrop");
        const areaListEl = $("areaList");
        const newAreaNameEl = $("newAreaName");
        const btnAddArea = $("btnAddArea");
        const btnCloseAreaModal = $("btnCloseAreaModal");
        const btnAreaDone = $("btnAreaDone");
        const areaModalMsg = $("areaModalMsg");
        const currentZoneNameEl = $("currentZoneName");
        let activeZoneForArea = null;

        // edit modal
        const editModalBackdrop = $("editModalBackdrop");
        const editModal = editModalBackdrop.querySelector('.modal'); // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á Modal content
        const editForm = $("editForm");
        const editDocZone = $("editDocZone");
        const editDocArea = $("editDocArea"); // New Edit Area
        const editDocBinId = $("editDocBinId");
        const editZoneDisplay = $("editZoneDisplay");
        const editAreaDisplay = $("editAreaDisplay"); // New Edit Area Display
        const editBinIdDisplay = $("editBinIdDisplay");
        const editRfid = $("editRfid");
        const editMacAddress = $("editMacAddress"); // üö® NEW
        const editLat = $("editLat");
        const editLng = $("editLng");
        const editMsg = $("editMsg");
        const btnEditClose = $("btnEditClose");
        const btnEditCancel = $("editCancel");

        // language icon + menu
        const langIconBtn = $("langIconBtn");
        const langMenu = $("langMenu");

        // üö® NEW: MAC Address data and listener
        let macAddresses = [];
        let macAddressListenerUnsub = null;
        // üß† MAC ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        let confirmedMacTemp = null;
        // üïí ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏´‡πá‡∏ô MAC ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        const macLastSeenMap = {};
        let lastDevicesSnapshot = {};   // ‚Üê ‡∏Ç‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ
        const OFFLINE_TIMEOUT_MS = 5 * 60 * 1000;
        // END NEW


        function lockBodyScroll(lock) {
            document.body.classList.toggle("modal-open", !!lock);
        }

        let duplicatedRfidDetected = false;
        let isHandlingRfid = false;
        const handlingMacs = new Set(); // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

        const LangState = window.AdminLang;
        let currentLang = (LangState && typeof LangState.getLang === "function") ?
            LangState.getLang() :
            (localStorage.getItem('sw_lang') || 'th');
        // üî• ‡∏ü‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤ ‡∏à‡∏≤‡∏Å admin-lang.js (‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á)
        if (window.AdminLang && typeof window.AdminLang.onChange === "function") {
            window.AdminLang.onChange(lang => {
                if (lang && lang !== currentLang) {
                    currentLang = lang;
                    changeLanguage(lang, true);
                }
            });
        }

        function getTranslation(key) {
            const dict = window.SW_Translations || {};
            const langPack = dict[currentLang] || dict.th || {};
            return langPack[key] || key;
        }


        function t(key) {
            return getTranslation(key);
        }

        function setStatusForm(text, type) {
            msg.textContent = text || "";
            msg.className = "muted" + (type === "ok" ? " ok" : type === "err" ? " err" : "");
        }

        function setBinsStatus(text, type) {
            binsStatusEl.textContent = text || "";
            binsStatusEl.className = "muted" + (type === "ok" ? " ok" : type === "err" ? " err" : "");
        }

        function errStr(e) {
            return (e && (e.code ? e.code + ": " + (e.message || "") : (e.message || String(e)))) || "unknown";
        }

        // =======================
        // üö® SweetAlert ‡πÅ‡∏à‡πâ‡∏á error ‡∏ü‡∏≠‡∏£‡πå‡∏°
        // =======================
        function showFormErrorCard(errors) {

            // üî• ‡∏õ‡∏¥‡∏î modal ‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
            closeEditModal?.();
            closeZoneModal?.();
            closeAreaModal?.();
            // ‚ùó ‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î addBinBackdrop ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ user ‡πÅ‡∏Å‡πâ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ

            Swal.fire({
                icon: "warning",
                title: t('formErrorTitle'),
                html: `
    <div style="text-align:left; line-height:1.6">
      <ul style="padding-left:18px">
        ${errors.map(e => `<li>${e}</li>`).join("")}
      </ul>
    </div>
  `,
                confirmButtonText: t('btnOk'),
                confirmButtonColor: "#2563eb",
                allowOutsideClick: false,
                allowEscapeKey: true
            }).then(() => {
                document.querySelector(".error")?.focus();
            });
        }

        // ---------- owners ----------
        let owners = [];
        let ownerMap = new Map();
        let ownerSelectState = "loading";
        let rfidListenerRef = null;

        function renderOwnerSelect() {
            if (!ownerEl) return;
            const selected = ownerEl.value;
            ownerEl.innerHTML = "";
            const opt = document.createElement("option");
            opt.value = "";
            const state = ownerSelectState;
            if (state === "loading") {
                opt.textContent = getTranslation('ownerSelectLoading');
                ownerEl.disabled = true;
            } else if (state === "error") {
                opt.textContent = getTranslation('ownerSelectError');
                ownerEl.disabled = true;
            } else if (!owners.length) {
                opt.textContent = getTranslation('ownerSelectEmpty');
                ownerEl.disabled = true;
            } else {
                opt.textContent = getTranslation('ownerSelectDefault');
                ownerEl.disabled = false;
            }
            ownerEl.appendChild(opt);
            if (state === "ready" && owners.length) {
                owners.forEach(user => {
                    const option = document.createElement("option");
                    option.value = user.username;
                    option.textContent = `${user.displayName} (${user.username})`;
                    ownerEl.appendChild(option);
                });
                if (selected && ownerMap.has(selected)) {
                    ownerEl.value = selected;
                } else {
                    ownerEl.value = "";
                }
            } else {
                ownerEl.value = "";
            }
        }

        async function loadOwners() {
            ownerSelectState = "loading";
            renderOwnerSelect();
            try {
                const snap = await usersCol.where("status", "==", 2).get();
                const locale = currentLang === "en" ? "en" : currentLang === "ms" ? "ms" : "th";
                owners = snap.docs.map(doc => {
                    const data = doc.data() || {};
                    const fullName = (data.fullName || "").trim();
                    const username = doc.id;
                    return {
                        username,
                        displayName: fullName || username,
                        fullName
                    };
                }).sort((a, b) => a.displayName.localeCompare(b.displayName, locale, {
                    sensitivity: "base"
                }));
                ownerMap = new Map(owners.map(user => [user.username, user]));
                ownerSelectState = "ready";
                renderOwnerSelect();
            } catch (err) {
                console.error("loadOwners error", err);
                ownerSelectState = "error";
                renderOwnerSelect();
                setStatusForm(`${getTranslation('ownerLoadError')} ${errStr(err)}`, "err");
            }
        }

        // ---------- zones ----------
        let zones = [];

        function renderZoneSelect() {
            const selected = zoneEl.value;
            zoneEl.innerHTML = "";
            const opt0 = document.createElement("option");
            opt0.value = "";
            opt0.textContent = zones.length ? getTranslation('zoneSelectDefault') : getTranslation('zoneSelectNoZones');
            zoneEl.appendChild(opt0);

            zones.forEach(z => {
                const opt = document.createElement("option");
                opt.value = z.id;
                opt.textContent = z.name;
                zoneEl.appendChild(opt);
            });

            const addOpt = document.createElement("option");
            addOpt.value = "_add_zone_";
            addOpt.textContent = getTranslation('zoneSelectAdd');
            zoneEl.appendChild(addOpt);

            if (selected) zoneEl.value = selected;
        }

        function renderZoneFilterOptions() {
            if (!filterZoneSelect) return;
            const prev = filterZoneSelect.value;
            filterZoneSelect.innerHTML = "";
            const allOpt = document.createElement("option");
            allOpt.value = "";
            allOpt.textContent = t('filterZoneAll');
            filterZoneSelect.appendChild(allOpt);

            zones.forEach(z => {
                const opt = document.createElement("option");
                opt.value = z.id;
                opt.textContent = z.name;
                filterZoneSelect.appendChild(opt);
            });

            if (prev && zones.some(z => z.id === prev)) {
                filterZoneSelect.value = prev;
            } else {
                filterZoneSelect.value = "";
            }
        }

        function renderZoneList() {
            zoneListEl.innerHTML = "";
            if (!zones.length) {
                zoneListEl.innerHTML = `<p class="muted">${getTranslation('zoneModalNoZones')}</p>`;
                return;
            }

            zones.forEach(z => {
                const row = document.createElement("div");
                row.className = "zone-row";

                const input = document.createElement("input");
                input.value = z.name;
                input.dataset.oldId = z.id;

                const btnSaveZone = document.createElement("button");
                btnSaveZone.type = "button";
                btnSaveZone.className = "primary";
                btnSaveZone.textContent = getTranslation('zoneModalSaveBtn');

                const btnDeleteZone = document.createElement("button");
                btnDeleteZone.type = "button";
                btnDeleteZone.className = "danger";
                btnDeleteZone.textContent = getTranslation('zoneModalDeleteBtn');

                btnSaveZone.addEventListener("click", async () => {
                    const oldId = input.dataset.oldId;
                    const newName = input.value.trim();
                    if (!newName) {
                        zoneModalMsg.textContent = getTranslation('zoneModalEmptyName');
                        zoneModalMsg.className = "muted err";
                        return;
                    }
                    if (oldId === newName) {
                        zoneModalMsg.textContent = getTranslation('zoneModalNoChange');
                        zoneModalMsg.className = "muted";
                        return;
                    }

                    try {
                        const binsSnap = await allBinsGroup.where("zone", "==", oldId).limit(1).get();
                        if (!binsSnap.empty) {
                            zoneModalMsg.textContent = getTranslation('zoneModalCannotChange');
                            zoneModalMsg.className = "muted err";
                            return;
                        }

                        const oldDoc = zonesCol.doc(oldId);
                        const newDoc = zonesCol.doc(newName);
                        const oldData = (await oldDoc.get()).data() || {};

                        // Check if new zone name already exists
                        const newSnap = await newDoc.get();
                        if (newSnap.exists) {
                            zoneModalMsg.textContent = getTranslation('zoneModalExists');
                            zoneModalMsg.className = "muted err";
                            return;
                        }

                        // Firestore transaction to rename (create and delete)
                        await newDoc.set({
                            name: newName,
                            createdAt: oldData.createdAt || firebase.firestore.FieldValue.serverTimestamp()
                        });
                        await oldDoc.delete();

                        zoneModalMsg.textContent = getTranslation('zoneModalSaveSuccess');
                        zoneModalMsg.className = "muted ok";
                    } catch (e) {
                        zoneModalMsg.textContent = `${getTranslation('zoneModalSaveError')} ${e.message || e}`;
                        zoneModalMsg.className = "muted err";
                    }
                });

                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å zonesCol.doc(id).delete(); ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï isHidden
                btnDeleteZone.addEventListener("click", async () => {
                    const id = input.dataset.oldId;
                    if (!confirm(`${t('areaModalConfirmDelete')} "${id}"?`)) return;
                    try {
                        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï isHidden ‡πÄ‡∏õ‡πá‡∏ô true ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏£‡∏¥‡∏á
                        await zonesCol.doc(id).update({
                            isHidden: true,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        zoneModalMsg.textContent = getTranslation('zoneModalDeleteSuccess');
                        zoneModalMsg.className = "muted ok";
                    } catch (e) {
                        zoneModalMsg.textContent = `Error: ${e.message}`;
                        zoneModalMsg.className = "muted err";
                    }
                });

                row.appendChild(input);
                row.appendChild(btnSaveZone);
                row.appendChild(btnDeleteZone);
                zoneListEl.appendChild(row);
            });
        }

        function openZoneModal() {
            // ‡∏õ‡∏¥‡∏î Modal ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏ä‡πà‡∏ô Add Bin Modal) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Zone Modal ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡∏ö
            closeEditModal(); // ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ã‡πâ‡∏≥
            zoneModalMsg.textContent = "";
            zoneModalMsg.className = "muted";
            newZoneNameEl.value = "";
            zoneModalBackdrop.classList.add("show");
        }

        function closeZoneModal() {
            zoneModalBackdrop.classList.remove("show");
            renderZoneSelect();
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î Add Bin Modal ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ ‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà
            if (addBinBackdrop.classList.contains('show')) {
                lockBodyScroll(true);
            } else {
                lockBodyScroll(false);
            }
        }


        btnCloseZoneModal.addEventListener("click", closeZoneModal);
        btnZoneDone.addEventListener("click", closeZoneModal);

        btnAddZone.addEventListener("click", async () => {
            const name = newZoneNameEl.value.trim();
            if (!name) {
                zoneModalMsg.textContent = getTranslation('zoneModalEmptyName');
                zoneModalMsg.className = "muted err";
                return;
            }
            try {
                const docRef = zonesCol.doc(name);
                const snap = await docRef.get();
                if (snap.exists) {
                    zoneModalMsg.textContent = getTranslation('zoneModalExists');
                    zoneModalMsg.className = "muted err";
                    return;
                }
                await docRef.set({
                    name,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // --- ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
                newZoneNameEl.value = "";
                zoneModalMsg.textContent = getTranslation('zoneModalAddSuccess');
                zoneModalMsg.className = "muted ok";

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                renderZoneSelect();
                zoneEl.value = name; // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢
                await loadAreasForZone(name); // ‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà)
                binIdEl.value = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå BIN ID ‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Area
                // -----------------------

            } catch (e) {
                zoneModalMsg.textContent = `${getTranslation('zoneModalAddError')} ${e.message || e}`;
                zoneModalMsg.className = "muted err";
            }
        });


        // ---------- Areas (Sub-zones) ----------

        let areas = [];

        function getAreasCollection(zoneId) {
            if (!zoneId) return null;
            return zonesCol.doc(zoneId).collection("areas");
        }

        async function loadAreasForZone(zoneId) {
            areas = [];
            if (!zoneId) {
                areaEl.innerHTML = `<option value="">${t('areaSelectNoAreas')}</option>`;
                areaEl.disabled = true;
                return;
            }

            areaEl.disabled = true;
            areaEl.innerHTML = `<option value="">${t('areaSelectLoading')}</option>`;

            try {
                const snap = await getAreasCollection(zoneId).orderBy("name").get();
                areas = snap.docs.map(doc => ({
                    id: doc.id,
                    name: (doc.data() && doc.data().name) || doc.id
                }));
                renderAreaSelect();
            } catch (e) {
                console.error("loadAreasForZone error", e);
                areaEl.innerHTML = `<option value="">${t('areaSelectDefault')}</option>`;
                areaEl.disabled = false;
                renderAreaSelect();
            }

        }

        function renderAreaSelect() {
            const selected = areaEl.value;
            areaEl.innerHTML = "";
            const opt0 = document.createElement("option");
            opt0.value = "";

            if (!zoneEl.value) {
                opt0.textContent = t('areaSelectNoAreas');
                areaEl.disabled = true;
            } else if (!areas.length) {
                opt0.textContent = t('areaSelectDefault');
                areaEl.disabled = false;
            } else {
                opt0.textContent = t('areaSelectDefault');
                areaEl.disabled = false;
            }

            areaEl.appendChild(opt0);

            areas.forEach(a => {
                const opt = document.createElement("option");
                opt.value = a.id;
                opt.textContent = a.name;
                areaEl.appendChild(opt);
            });

            if (zoneEl.value) {
                const addOpt = document.createElement("option");
                addOpt.value = "_add_area_";
                addOpt.textContent = t('areaSelectAdd');
                areaEl.appendChild(addOpt);
            }

            // Restore selection if possible
            if (selected && areaEl.querySelector(`option[value="${selected}"]`)) {
                areaEl.value = selected;
            } else {
                areaEl.value = "";
            }
        }

        function renderAreaFilterOptions() {
            if (!filterAreaSelect) return;
            const prev = filterAreaSelect.value;
            filterAreaSelect.innerHTML = "";

            const allOpt = document.createElement("option");
            allOpt.value = "";
            allOpt.textContent = t('filterAreaAll');
            filterAreaSelect.appendChild(allOpt);

            const selectedZone = filterZoneSelect.value;
            if (selectedZone) {
                const zoneAreas = areasCache.get(selectedZone) || [];
                zoneAreas.forEach(a => {
                    const opt = document.createElement("option");
                    opt.value = a.id;
                    opt.textContent = a.name;
                    filterAreaSelect.appendChild(opt);
                });
                filterAreaSelect.disabled = false;
            } else {
                filterAreaSelect.disabled = true;
            }

            if (prev && areasCache.get(selectedZone)?.some(a => a.id === prev)) {
                filterAreaSelect.value = prev;
            } else {
                filterAreaSelect.value = "";
            }
        }

        function renderAreaList(zoneId, currentAreas) {
            areaListEl.innerHTML = "";
            if (!currentAreas.length) {
                areaListEl.innerHTML = `<p class="muted">${t('areaModalNoAreas')}</p>`;
                return;
            }

            currentAreas.forEach(a => {
                const row = document.createElement("div");
                row.className = "zone-row";

                const input = document.createElement("input");
                input.value = a.name;
                input.dataset.oldId = a.id;

                const btnSaveArea = document.createElement("button");
                btnSaveArea.type = "button";
                btnSaveArea.className = "primary";
                btnSaveArea.textContent = t('areaModalSaveBtn');

                const btnDeleteArea = document.createElement("button");
                btnDeleteArea.type = "button";
                btnDeleteArea.className = "danger";
                btnDeleteArea.textContent = t('areaModalDeleteBtn');

                btnSaveArea.addEventListener("click", async () => {
                    const oldId = input.dataset.oldId;
                    const newName = input.value.trim();
                    if (!newName) {
                        areaModalMsg.textContent = t('areaModalEmptyName');
                        areaModalMsg.className = "muted err";
                        return;
                    }
                    if (oldId === newName) {
                        areaModalMsg.textContent = t('areaModalNoChange');
                        areaModalMsg.className = "muted";
                        return;
                    }

                    try {
                        // Check if renaming is possible (no existing bins in this area)
                        const binsSnap = await allBinsGroup.where("zone", "==", zoneId).where("area", "==", oldId).limit(1).get();
                        if (!binsSnap.empty) {
                            areaModalMsg.textContent = t('areaModalCannotChange');
                            areaModalMsg.className = "muted err";
                            return;
                        }

                        const areasColRef = getAreasCollection(zoneId);
                        const oldDoc = areasColRef.doc(oldId);
                        const newDoc = areasColRef.doc(newName);
                        const oldData = (await oldDoc.get()).data() || {};

                        // Check if new area name already exists
                        const newSnap = await newDoc.get();
                        if (newSnap.exists) {
                            areaModalMsg.textContent = t('areaModalExists');
                            areaModalMsg.className = "muted err";
                            return;
                        }

                        // Firestore transaction to rename (create and delete)
                        await newDoc.set({
                            name: newName,
                            createdAt: oldData.createdAt || firebase.firestore.FieldValue.serverTimestamp()
                        });
                        await oldDoc.delete();

                        areaModalMsg.textContent = t('areaModalSaveSuccess');
                        areaModalMsg.className = "muted ok";
                    } catch (e) {
                        areaModalMsg.textContent = `${t('areaModalSaveError')} ${e.message || e}`;
                        areaModalMsg.className = "muted err";
                    }
                });

                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á delete() ‡πÄ‡∏õ‡πá‡∏ô update({ isHidden: true })
                btnDeleteArea.addEventListener("click", async () => {
                    const id = input.dataset.oldId;
                    if (!confirm(`${t('areaModalConfirmDelete')} "${id}"?`)) return;
                    try {
                        await getAreasCollection(zoneId).doc(id).update({
                            isHidden: true,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        areaModalMsg.textContent = t('areaModalDeleteSuccess');
                        areaModalMsg.className = "muted ok";
                        // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÉ‡∏ô Modal
                        const updatedSnap = await getAreasCollection(zoneId).where("isHidden", "==", false).get();
                        // ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡∏°‡πà ...
                    } catch (e) {
                        areaModalMsg.textContent = `Error: ${e.message}`;
                    }
                });
                row.appendChild(input);
                row.appendChild(btnSaveArea);
                row.appendChild(btnDeleteArea);
                areaListEl.appendChild(row);
            });
        }

        async function openAreaModal(zoneId) {
            if (!zoneId) return;

            activeZoneForArea = zoneId;
            currentZoneNameEl.textContent = zoneId;
            areaModalMsg.textContent = "";
            areaModalMsg.className = "muted";
            newAreaNameEl.value = "";

            areaListEl.innerHTML = `<p class="muted">${t('areaSelectLoading')}...</p>`;

            // Re-load areas just for the modal to get the latest
            let currentAreas = [];
            try {
                const snap = await getAreasCollection(zoneId).orderBy("name").get();
                currentAreas = snap.docs.map(doc => ({
                    id: doc.id,
                    name: (doc.data() && doc.data().name) || doc.id
                }));
            } catch (e) {
                console.error("Error loading areas for modal:", e);
            }
            renderAreaList(zoneId, currentAreas);


            areaModalBackdrop.classList.add("show");
            lockBodyScroll(true); // ‡∏•‡πá‡∏≠‡∏Å scroll ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        }


        function closeAreaModal() {
            areaModalBackdrop.classList.remove("show");

            // Reload the main form's area dropdown after closing the modal
            if (zoneEl.value) {
                loadAreasForZone(zoneEl.value);
            }

            activeZoneForArea = null;
            lockBodyScroll(false); // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å scroll ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        }


        btnCloseAreaModal.addEventListener("click", closeAreaModal);
        btnAreaDone.addEventListener("click", closeAreaModal);

        btnAddArea.addEventListener("click", async () => {
            const zoneId = activeZoneForArea;
            const name = newAreaNameEl.value.trim();
            if (!zoneId) return;
            if (!name) {
                areaModalMsg.textContent = t('areaModalEmptyName');
                areaModalMsg.className = "muted err";
                return;
            }
            try {
                const areasColRef = getAreasCollection(zoneId);
                const docRef = areasColRef.doc(name);
                const snap = await docRef.get();
                if (snap.exists) {
                    areaModalMsg.textContent = t('areaModalExists');
                    areaModalMsg.className = "muted err";
                    return;
                }
                await docRef.set({
                    name,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á ---
                newAreaNameEl.value = "";
                areaModalMsg.textContent = t('areaModalAddSuccess');
                areaModalMsg.className = "muted ok";

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏•‡∏±‡∏Å
                await loadAreasForZone(zoneId);
                areaEl.value = name; // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Area ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

                // üî• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡∏±‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á BIN ID ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÄ‡∏ä‡πà‡∏ô A001)
                await assignBinIdForZone(zoneId, name);

                // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô Modal Area (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà)
                const updatedSnap = await getAreasCollection(zoneId).orderBy("name").get();
                const updatedAreas = updatedSnap.docs.map(doc => ({
                    id: doc.id,
                    name: (doc.data() && doc.data().name) || doc.id
                }));
                renderAreaList(zoneId, updatedAreas);
                // -----------------------

            } catch (e) {
                areaModalMsg.textContent = `${t('areaModalAddError')} ${e.message || e}`;
                areaModalMsg.className = "muted err";
            }
        });

        // ---------- BIN ID ----------
        function pad3(n) {
            return n.toString().padStart(3, "0");
        }

        async function assignBinIdForZone(zoneName, areaName) {
            if (!zoneName || !areaName) return "";

            // 1. ‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á Zone (‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà) ‡πÄ‡∏ä‡πà‡∏ô Yala -> Y
            const zonePrefix = zoneName.charAt(0).toUpperCase();

            // 2. ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Prefix ‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô Area ‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô Betong_Y
            const fullPrefix = `${areaName}_${zonePrefix}`;

            try {
                const binsCol = db
                    .collection("smartbins")
                    .doc(zoneName)
                    .collection("bin_data");

                // 3. Query ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Zone ‡πÅ‡∏•‡∏∞ Area ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                const snap = await binsCol
                    .where("zone", "==", zoneName)
                    .where("area", "==", areaName)
                    .get();

                const usedNumbers = new Set();
                snap.forEach(doc => {
                    const data = doc.data() || {};
                    const existingBinId = (data.binId || doc.id || "").toString();

                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö pattern ‡πÄ‡∏ä‡πà‡∏ô Betong_Y001 -> ‡∏î‡∏∂‡∏á 001 ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤
                    const regex = new RegExp(`^${fullPrefix}(\\d+)$`);
                    const match = regex.exec(existingBinId);
                    if (match) {
                        const num = Number(match[1]);
                        if (!Number.isNaN(num)) {
                            usedNumbers.add(num);
                        }
                    }
                });

                // 4. ‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
                let candidate = 1;
                while (usedNumbers.has(candidate)) candidate++;

                // 5. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô Betong_Y001
                const finalBinId = fullPrefix + pad3(candidate);
                binIdEl.value = finalBinId; // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Input ‡∏Ç‡∏≠‡∏á Form
                return finalBinId;
            } catch (err) {
                console.error("assignBinIdForZone error", err);
                const fallback = fullPrefix + "001";
                binIdEl.value = fallback;
                return fallback;
            }
        }

        zoneEl.addEventListener("change", async () => {
            const z = zoneEl.value;

            if (z === "_add_zone_") {
                zoneEl.value = "";
                areaEl.value = "";
                areaEl.disabled = true;
                binIdEl.value = "";
                setStatusForm("", "");
                openZoneModal(); // Open Zone Modal first
                return;
            }

            if (!z) {
                areaEl.innerHTML = `<option value="">${t('areaSelectNoAreas')}</option>`;
                areaEl.disabled = true;
                binIdEl.value = "";
                setStatusForm(t('statusSelectZone'), "err");
                return;
            }

            setStatusForm("", "");
            await loadAreasForZone(z);

            // Re-assign BIN ID only if area is already selected/available
            if (areaEl.value && areaEl.value !== "_add_area_") {
                await assignBinIdForZone(z, areaEl.value);
            } else {
                binIdEl.value = ""; // Clear if area is not selected/selected is add
            }
        });

        areaEl.addEventListener("change", async () => {
            const z = zoneEl.value;
            const a = areaEl.value;

            if (a === "_add_area_") {
                areaEl.value = "";
                binIdEl.value = "";
                setStatusForm("", "");
                openAreaModal(z); // Open Area Modal
                return;
            }

            if (!z) {
                setStatusForm(t('statusSelectZone'), "err");
                binIdEl.value = "";
                return;
            }

            if (!a) {
                setStatusForm(t('statusSelectArea'), "err");
                binIdEl.value = "";
                return;
            }

            setStatusForm("", "");
            await assignBinIdForZone(z, a);
        });

        rfidEl.addEventListener('blur', async () => {
            const rfidValue = rfidEl.value.trim().toUpperCase();
            if (!rfidValue) return;

            const dup = await checkDuplicateRfidRealtime(rfidValue);
            if (dup) {
                showDuplicateRfidModal(dup, rfidValue);
            }
        });

        // ---------- GPS ----------
        btnGetPos.addEventListener("click", () => {
            if (!navigator.geolocation) {
                setStatusForm(getTranslation('statusNoGps'), "err");
                return;
            }
            setStatusForm(getTranslation('statusGettingPos'), "");
            navigator.geolocation.getCurrentPosition(pos => {
                const {
                    latitude,
                    longitude
                } = pos.coords;
                latEl.value = latitude.toFixed(6);
                lngEl.value = longitude.toFixed(6);
                setStatusForm(getTranslation('statusGetPosSuccess'), "ok");
            }, err => {
                setStatusForm(`${getTranslation('statusGetPosError')} ${err.message}`, "err");
            }, {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            });
        });
        // ---------- clear form ----------
        function clearForm() {
            duplicatedRfidDetected = false;   // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
            binForm.reset();
            binIdEl.value = "";
            ownerEl.classList.remove("error");
            zoneEl.classList.remove("error");
            areaEl.classList.remove("error");
            macAddressEl.classList.remove("error"); // üö® NEW
            areaEl.innerHTML = `<option value="">${t('areaSelectNoAreas')}</option>`;
            areaEl.disabled = true;
            setStatusForm("", "");

            // Hide fields when clearing form
            binForm.classList.remove('rfid-entered');
        }

        btnReset.addEventListener("click", async () => {
            await releaseConfirmedMac();
            detachRfidListener();
            clearForm();
        });

        // üö® NEW: Event listeners for MAC Address confirmation
        if (macAddressEl && btnConfirmMac) {

            // 1Ô∏è‚É£ ‡∏ï‡∏£‡∏ß‡∏à MAC ‡∏ã‡πâ‡∏≥ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å dropdown
            macAddressEl.addEventListener("change", async () => {
                const mac = macAddressEl.value;
                if (!mac) return;

                const snap = await db
                    .collectionGroup("bin_data")
                    .where("macAddress", "==", mac)
                    .where("isHidden", "==", false)
                    .limit(1)
                    .get();

                if (!snap.empty) {
                    const d = snap.docs[0].data();

                    showDuplicateMacModal({
                        mac: mac,
                        binId: d.binId,
                        zone: d.zone,
                        area: d.area || "‚Äî",
                        owner: d.ownerName || "‚Äî"
                    });

                    macAddressEl.value = "";
                    await setBoardLed(mac, "OFF"); // üî¥ ‡∏î‡∏±‡∏ö‡πÑ‡∏ü
                    btnConfirmMac.disabled = true;
                    return;
                }

                // üü¢ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                btnConfirmMac.disabled = false;
            });

            // 2Ô∏è‚É£ üî• ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏ö‡∏≠‡∏£‡πå‡∏î ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î ‚Äú‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‚Äù
            btnConfirmMac.addEventListener("click", async () => {
                const mac = macAddressEl.value;
                if (!mac) return;

                confirmedMacTemp = mac;

                const ref = rtdb.ref(`esp32_devices/${mac}/currentAdmin`);

                await ref.transaction(current => {
                    if (current) return;
                    return window.ADMIN_AUTH.uid;
                }, async (error, committed) => {
                    if (!committed) {
                        alert(t('errorMacInUse'));
                        return;
                    }

                    // üî•üî•üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                    await rtdb
                        .ref(`admin_rfid_active/${window.ADMIN_AUTH.uid}`)
                        .set(true);

                    macAddressEl.disabled = true;
                    btnConfirmMac.classList.add("confirmed");
                    btnConfirmMac.disabled = true;

                    attachRfidListener();
                    setBoardLed(mac, "ON");
                });
            });
        }
        // END NEW

        // ---------- submit (‡πÄ‡∏û‡∏¥‡πà‡∏° MAC Address ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å) ----------
        binForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            // =========================
            // ‚úÖ VALIDATION ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            // =========================
            const errors = [];

            // ---------- MAC ----------
            const macAddress = macAddressEl.value.trim();
            if (!macAddress) {
                errors.push(t('errorSelectMac'));
                macAddressEl.classList.add("error");
            } else if (confirmedMacTemp !== macAddress) {
                errors.push(t('errorConfirmMac'));
                macAddressEl.classList.add("error");
            } else {
                macAddressEl.classList.remove("error");
            }

            // ---------- RFID ----------
            const rfid = rfidEl.value.trim().toUpperCase();
            if (!rfid) {
                errors.push(t('errorMissingRfid'));
                rfidEl.classList.add("error");
            } else {
                rfidEl.classList.remove("error");
            }

            // ---------- Zone ----------
            const zone = zoneEl.value;
            if (!zone || zone === "_add_zone_") {
                errors.push(t('errorSelectZone'));
                zoneEl.classList.add("error");
            } else {
                zoneEl.classList.remove("error");
            }

            // ---------- Area ----------
            const area = areaEl.value;
            if (!area || area === "_add_area_") {
                errors.push(t('errorSelectArea'));
                areaEl.classList.add("error");
            } else {
                areaEl.classList.remove("error");
            }

            // ---------- Owner ----------
            const ownerUsername = ownerEl.value;
            if (!ownerUsername) {
                errors.push(t('errorSelectOwner'));
                ownerEl.classList.add("error");
            } else {
                ownerEl.classList.remove("error");
            }

            // ‚ùå ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ error ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î
            if (errors.length > 0) {
                showFormErrorCard(errors);
                return;
            }

            try {
                const rfid = rfidEl.value.trim().toUpperCase() || null;
                if (!rfid) {
                    rfidEl.classList.add("error");
                    setStatusForm(t('errorMissingRfid'), "err");
                    return;
                } else {
                    rfidEl.classList.remove("error");
                }

                const dup = await checkDuplicateRfidRealtime(rfid);
                if (dup) {
                    duplicatedRfidDetected = true;
                    showDuplicateRfidModal(dup, rfid);
                    return;
                }
                if (duplicatedRfidDetected) {
                    setStatusForm(t('errorDuplicateRfid'), "err");
                    return;
                }

                const zone = zoneEl.value.trim();
                if (!zone || zone === "_add_zone_") {
                    zoneEl.classList.add("error");
                    setStatusForm(t('statusSelectZone'), "err");
                    return;
                } else {
                    zoneEl.classList.remove("error");
                }

                const area = areaEl.value.trim();
                if (!area || area === "_add_area_") {
                    areaEl.classList.add("error");
                    setStatusForm(t('statusSelectArea'), "err");
                    return;
                } else {
                    areaEl.classList.remove("error");
                }


                const ownerUsername = ownerEl.value.trim();
                if (!ownerUsername) {
                    ownerEl.classList.add("error");
                    setStatusForm(t('statusSelectOwner'), "err");
                    return;
                } else {
                    ownerEl.classList.remove("error");
                }

                // üö® NEW: MAC Address Validation
                const macAddress = macAddressEl.value.trim() || null;

                // ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å MAC
                if (!macAddress) {
                    macAddressEl.classList.add("error");
                    setStatusForm(t('errorSelectMac'), "err");
                    return;
                }

                // ‚ùå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                if (confirmedMacTemp !== macAddress) {
                    macAddressEl.classList.add("error");
                    setStatusForm(t('errorConfirmMac'), "err");
                    return;
                }

                // ‚úÖ ‡∏ú‡πà‡∏≤‡∏ô
                macAddressEl.classList.remove("error");

                // END NEW

                let binId = binIdEl.value.trim();
                if (!binId) {
                    binId = await assignBinIdForZone(zone, area);
                }

                const lng = lngEl.value ? Number(lngEl.value) : null;
                const lat = latEl.value ? Number(latEl.value) : null;
                const details = detailsEl.value.trim() || null;

                const ownerInfo = ownerMap.get(ownerUsername);
                const ownerName = ownerInfo?.fullName || ownerUsername;

                const zoneDocRef = db.collection("smartbins").doc(zone);

                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• data ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
                const data = {
                    binId, // ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏ä‡πà‡∏ô Betong_Y001)
                    zone,
                    area,
                    ownerUsername,
                    ownerName,
                    RFID: rfid,
                    macAddress,
                    locked: true,
                    lng,
                    lat,
                    details,
                    isHidden: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                setStatusForm(t('statusSaving'), "");

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á bin_data ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ binId ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠ Document
                await zoneDocRef
                    .collection("bin_data")
                    .doc(binId) // ‡∏à‡∏∞‡πÑ‡∏î‡πâ path: smartbins/{zone}/bin_data/Betong_Y001
                    .set(data, { merge: false });

                setStatusForm(`${t('statusSaveSuccess')} (${binId})`, "ok");
                // ‚úÖ ‡∏ö‡∏≠‡∏Å‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ß‡πà‡∏≤‡∏ú‡∏π‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£‡πÅ‡∏•‡πâ‡∏ß
                await rtdb
                    .ref(`esp32_devices/${macAddress}/bound`)
                    .set(true);
                // üîì ‡∏õ‡∏•‡πà‡∏≠‡∏¢ admin lock ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏ú‡∏π‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                await rtdb
                    .ref(`esp32_devices/${macAddress}/currentAdmin`)
                    .remove();

                // üî• ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏™‡πÅ‡∏Å‡∏ô RFID ‡∏Ç‡∏≠‡∏á admin (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)
                await rtdb
                    .ref(`admin_rfid_active/${window.ADMIN_AUTH.uid}`)
                    .remove();


                confirmedMacTemp = null;


                confirmedMacTemp = null;
                btnConfirmMac.classList.remove("confirmed");

                setTimeout(() => {
                    closeAddModal();
                }, 600);
            } catch (err) {
                console.error(err);
                setStatusForm(`${t('statusSaveError')} ${errStr(err)}`, "err");
            }
        });

        // ---------- bins list ----------
        // ---------- RFID Duplicate Check (Firestore) ----------
        async function checkDuplicateRfidRealtime(rfidValue) {
            try {
                const snap = await db
                    .collectionGroup("bin_data")
                    .where("RFID", "==", rfidValue)
                    .limit(5)
                    .get();

                if (snap.empty) return null;

                for (const doc of snap.docs) {
                    const d = doc.data() || {};
                    if (d.isHidden === true) continue; // ‚úÖ ‡∏Å‡∏£‡∏≠‡∏á‡πÉ‡∏ô JS

                    return {
                        binId: d.binId || doc.id,
                        zone: d.zone,
                        area: d.area || "‚Äî",
                        owner: d.ownerName || d.ownerUsername || "‚Äî",
                        updatedAt: d.updatedAt?.toDate?.().toLocaleString() || "‚Äî"
                    };
                }

                return null;
            } catch (e) {
                console.error("checkDuplicateRfidRealtime error", e);
                return null;
            }
        }


        let zoneUnsubMap = {};
        let areasCache = new Map(); // Cache to store areas per zone
        let bins = [];

        function renderBinsTable() {
            binsRowsEl.innerHTML = "";

            let filtered = bins.slice()
                .filter(item => item.data?.isHidden !== true); // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ


            const zoneFilterVal = filterZoneSelect.value;
            if (zoneFilterVal) {
                filtered = filtered.filter(item => item.zone === zoneFilterVal);
                const areaFilterVal = filterAreaSelect.value;
                if (areaFilterVal) {
                    filtered = filtered.filter(item => (item.data.area || "") === areaFilterVal);
                }
            }


            const search = filterBinText.value.trim().toLowerCase();
            if (search) {
                filtered = filtered.filter(item => {
                    const d = item.data || {};
                    const binId = (d.binId || item.binId || "").toString().toLowerCase();
                    const ownerName = (d.ownerName || "").toString().toLowerCase();
                    const ownerUsername = (d.ownerUsername || "").toString().toLowerCase();
                    return (
                        binId.includes(search) ||
                        ownerName.includes(search) ||
                        ownerUsername.includes(search)
                    );
                });
            }

            filtered.sort((a, b) => b.createdAtMs - a.createdAtMs);

            if (!filtered.length) {
                binsRowsEl.innerHTML = `<tr><td colspan="9" class="muted">${t('noData')}</td></tr>`;
                setBinsStatus("", "");
                return;
            }

            filtered.forEach(item => {
                const d = item.data || {};
                const zone = d.zone || item.zone;
                const area = d.area || "‚Äî"; // New Area
                const binId = d.binId || item.binId;
                const rfidVal = d.RFID || "‚Äî";
                const lat = (d.lat !== undefined && d.lat !== null) ? d.lat : "‚Äî";
                const lng = (d.lng !== undefined && d.lng !== null) ? d.lng : "‚Äî";
                const det = d.details || "‚Äî";
                const ownerName = d.ownerName || d.owner || "";
                const ownerUsername = d.ownerUsername || "";
                const ownerDisplay = ownerName || ownerUsername || "‚Äî";
                const updatedAt = item.updatedAt ? item.updatedAt.toLocaleString() : "‚Äî";

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${zone}</td>
                    <td>${area}</td> <td><code>${binId}</code></td>
                    <td>${ownerDisplay}</td>
                    <td>${rfidVal}</td>
                    <td>${lat}, ${lng}</td>
                    <td>${det}</td>
                    <td class="muted">${updatedAt}</td>
                    <td>
                        <div class="bin-actions">
                            <button class="icon-btn icon-delete-btn"
                                            type="button"
                                            onclick="deleteBin('${zone}','${binId}')"
                                            aria-label="${t('btnDelete')}">
                                <svg viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M9 3h6a1 1 0 0 1 1 1v1h4v2h-1v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7H3V5h4V4a1 1 0 0 1 1-1zm1 2v1h4V5h-4zm-2 4h2v9H8V9zm4 0h2v9h-2V9z"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                `;
                binsRowsEl.appendChild(tr);
            });

            setBinsStatus(`${t('showing')} ${filtered.length} ${t('items')}`, "ok");
        }

        filterBinText.addEventListener("input", renderBinsTable);
        filterZoneSelect.addEventListener("change", () => {
            loadAreasForZoneFilter(filterZoneSelect.value);
            renderBinsTable();
        });
        filterAreaSelect.addEventListener("change", renderBinsTable);

        // Load areas for filter separately to keep all options
        let areaFilterUnsubMap = {};
        async function loadAreasForZoneFilter(zoneId) {
            filterAreaSelect.innerHTML = `<option value="">${t('filterAreaAll')}</option>`;
            areasCache.clear();

            // Clear all existing listeners
            Object.values(areaFilterUnsubMap).forEach(fn => fn && fn());
            areaFilterUnsubMap = {};

            if (!zoneId) {
                filterAreaSelect.disabled = true;
                return;
            }

            filterAreaSelect.disabled = true;
            filterAreaSelect.innerHTML = `<option value="">${t('areaSelectLoading')}</option>`;

            try {
                const areasColRef = getAreasCollection(zoneId);
                if (!areasColRef) return;

                const unsub = areasColRef.orderBy("name").onSnapshot(snap => {
                    const zoneAreas = snap.docs.map(doc => ({
                        id: doc.id,
                        name: (doc.data() && doc.data().name) || doc.id
                    }));
                    areasCache.set(zoneId, zoneAreas);

                    filterAreaSelect.innerHTML = `<option value="">${t('filterAreaAll')}</option>`;
                    zoneAreas.forEach(a => {
                        const opt = document.createElement("option");
                        opt.value = a.id;
                        opt.textContent = a.name;
                        filterAreaSelect.appendChild(opt);
                    });
                    filterAreaSelect.disabled = false;
                    renderBinsTable();
                });
                areaFilterUnsubMap[zoneId] = unsub;
            } catch (e) {
                console.error("loadAreasForZoneFilter error", e);
                filterAreaSelect.innerHTML = `<option value="">${t('filterAreaAll')}</option>`;
                filterAreaSelect.disabled = true;
                renderBinsTable();
            }
        }


        zonesCol.orderBy("name").onSnapshot(snap => {
            zones = [];
            // Unsubscribe from old bin listeners
            Object.values(zoneUnsubMap).forEach(fn => fn && fn());
            zoneUnsubMap = {};
            bins = [];

            snap.forEach(doc => {
                const d = doc.data() || {};
                zones.push({
                    id: doc.id,
                    name: d.name || doc.id
                });
            });

            renderZoneSelect();
            renderZoneList();
            renderZoneFilterOptions();
            loadAreasForZoneFilter(filterZoneSelect.value); // Reload area filter options

            if (zones.length) {
                setBinsStatus(t('loading'), "");
            } else {
                setBinsStatus("", "");
            }

            zones.forEach(z => {
                const col = db
                    .collection("smartbins")
                    .doc(z.id)
                    .collection("bin_data")
                    .where("isHidden", "==", false);

                const unsub = col.onSnapshot(zoneSnap => {
                    bins = bins.filter(b => b.zone !== z.id);

                    zoneSnap.forEach(doc => {
                        const d = doc.data() || {};

                        const createdAt =
                            d.createdAt && d.createdAt.toMillis
                                ? d.createdAt.toMillis()
                                : 0;

                        const updatedAt =
                            d.updatedAt && d.updatedAt.toDate
                                ? d.updatedAt.toDate()
                                : null;

                        bins.push({
                            zone: z.id,
                            binId: doc.id,
                            data: d,
                            createdAtMs: createdAt,
                            updatedAt
                        });
                    });

                    renderBinsTable();
                });

                zoneUnsubMap[z.id] = unsub;
            });
        });

        // ---------- Edit modal ----------
        function openEditModal() {
            // ‡∏õ‡∏¥‡∏î Modal ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Zone/Area ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Edit Modal
            closeZoneModal(false);
            closeAreaModal(false);

            editModalBackdrop.classList.add("show");
            lockBodyScroll(true); // ‡∏•‡πá‡∏≠‡∏Å scroll ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        }

        // ‡πÄ‡∏Å‡πá‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á Edit Modal ‡πÑ‡∏ß‡πâ
        const originalEditModalContent = editModal.innerHTML;

        function closeEditModal() {
            editModalBackdrop.classList.remove("show");

            // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Modal ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô Edit Form (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)
            editModal.innerHTML = originalEditModalContent;

            // Re-map elements in case they were removed/replaced
            const editForm = $("editForm");
            if (editForm) {
                editForm.removeEventListener("submit", editFormSubmitHandler);
                editForm.addEventListener("submit", editFormSubmitHandler);
            }

            const btnCancel = $("editCancel");
            if (btnCancel) {
                btnCancel.removeEventListener("click", closeEditModal);
                btnCancel.addEventListener("click", closeEditModal);
            }

            // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            editForm.reset();
            setBinsStatus("", "");
            editMsg.textContent = "";
            editMsg.className = "muted";
            lockBodyScroll(false);
        }
        // ---------- Duplicate RFID Modal ----------
        function showDuplicateRfidModal(info, rfid) {
            // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            closeAddModal(false);
            closeZoneModal();
            closeAreaModal();
            changeLanguage(currentLang, true); // üî•


            const modalHtml = `
        <div class="modal-title">${t('duplicateModalTitle')}</div>
            <button type="button" class="modal-close" id="btnDupCloseTop">‚úï</button>
        </div>
        <div style="padding: 15px 0;">
            <div style="border:1.5px solid #ef4444; background:#fef2f2; border-radius:12px; padding:16px;">
                <p style="font-weight:bold; color:#991b1b; margin-bottom:10px; font-size:1.1rem;">
${t('duplicateRfidTitle')}: ${rfid}
                </p>
                <div style="font-size:0.95rem; color:#451a03; line-height:1.6;">
<p><b>${t('labelBin')}:</b> ${info.binId}</p>
<p><b>${t('labelZoneArea')}:</b> ${info.zone} (${info.area})</p>
<p><b>${t('labelOwner')}:</b> ${info.owner}
    </p>
                </div>
                <p style="margin-top:12px; font-size:0.85rem; color:#b91c1c; font-style:italic;">
                    * ${t('duplicateRfidHint')}
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="primary" id="btnScanNew" style="width:100%">${t('btnScanNew')}</button>
        </div>
    `;

            // ‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á editModal ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            editModal.innerHTML = modalHtml;

            // ‡∏ú‡∏π‡∏Å Event ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î
            document.getElementById("btnScanNew").onclick = closeDuplicateModal;
            document.getElementById("btnDupCloseTop").onclick = closeDuplicateModal;

            editModalBackdrop.classList.add("show");
            lockBodyScroll(true);
        }

        function showDeleteConfirmModal({ zone, area, binId }, onConfirm) {
            closeEditModal();
            closeAddModal(false);

            const modalHtml = `
        <div class="modal-header">
            <div class="modal-title" style="color:#dc2626">
                üóëÔ∏è ${t('confirmDeleteTitle')}
            </div>
            <button type="button" class="modal-close" id="btnDelClose">‚úï</button>
        </div>

        <div style="padding:16px">
            <div style="border:1.5px solid #ef4444; background:#fef2f2; border-radius:12px; padding:16px">
                <p style="font-weight:bold; margin-bottom:8px">
                    ${t('confirmDeleteBin')}
                </p>
                <p><b>BIN:</b> ${binId}</p>
                <p><b>${t('labelZone')}</b> ${zone}</p>
                <p><b>${t('labelArea')}:</b> ${area}</p>

                <p style="margin-top:10px; font-size:0.85rem; color:#991b1b">
                    * ${t('confirmDeleteHint')}
                </p>
            </div>
        </div>

        <div class="modal-footer" style="display:flex; gap:8px">
            <button class="ghost" id="btnDelCancel">${t('btnCancel')}</button>
            <button class="primary" id="btnDelConfirm">${t('btnDelete')}</button>
        </div>
    `;

            editModal.innerHTML = modalHtml;
            editModalBackdrop.classList.add("show");
            lockBodyScroll(true);

            document.getElementById("btnDelCancel").onclick = closeEditModal;
            document.getElementById("btnDelClose").onclick = closeEditModal;

            document.getElementById("btnDelConfirm").onclick = async () => {
                await onConfirm();
                closeEditModal();
            };
        }


        function showDuplicateMacModal(info) {
            // ‡∏õ‡∏¥‡∏î Modal ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
            closeEditModal();

            const modalHtml = `
        <div class="modal-header">
            <div class="modal-title" style="color:#dc2626">‚ùå ${t('duplicateMacTitle')}</div>
            <button type="button" class="modal-close" onclick="closeEditModal()">‚úï</button>
        </div>
        <div style="padding: 15px 0;">
            <div style="border:1.5px solid #ef4444; background:#fef2f2; border-radius:12px; padding:16px;">
                <p style="font-weight:bold; color:#991b1b; margin-bottom:10px;">
                    ${t('duplicateMacDesc')}
                </p>
                <div style="font-size:0.95rem; color:#451a03; line-height:1.6;">
                    <p><b>MAC:</b> ${info.mac}</p>
                    <p><b>${t('labelBin')}:</b> ${info.binId}</p>
                    <p><b>${t('labelZoneArea')}:</b> ${info.zone} (${info.area})</p>
                    <p><b>${t('labelOwner')}:</b> ${info.owner}</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="primary" onclick="closeEditModal()" style="width:100%">${t('btnOk')}</button>
        </div>
    `;

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà editModal (‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á)
            editModal.innerHTML = modalHtml;

            // ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            editModalBackdrop.classList.add("show");
            lockBodyScroll(true);
        }


        function closeDuplicateModal() {
            duplicatedRfidDetected = false;
            editModalBackdrop.classList.remove("show");
            lockBodyScroll(false);

            // ‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Edit Form) ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
            editModal.innerHTML = originalEditModalContent;

            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á) ‡πÅ‡∏•‡∏∞‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á RFID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà
            rfidEl.value = "";
            binForm.classList.remove("rfid-entered");

            setTimeout(() => {
                rfidEl.focus();
            }, 300);
        }

        btnEditClose.addEventListener("click", closeEditModal);
        btnEditCancel.addEventListener("click", closeEditModal);

        // ‡πÉ‡∏ä‡πâ handler ‡πÅ‡∏¢‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Edit Form Submit
        const editFormSubmitHandler = async e => {
            e.preventDefault();
            try {
                const zone = editDocZone.value;
                const binId = editDocBinId.value;
                if (!zone || !binId) {
                    editMsg.textContent = t('editSaveError');
                    editMsg.className = "muted err";
                    return;
                }
                const rfid = editRfid.value.trim() || null;
                const lng = editLng.value ? Number(editLng.value) : null;
                const lat = editLat.value ? Number(editLat.value) : null;
                const det = document.getElementById("editDetails").value.trim() || null; // ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å ID ‡πÄ‡∏î‡∏¥‡∏°

                const docRef = db
                    .collection("smartbins")
                    .doc(zone)
                    .collection("bin_data")
                    .doc(binId);

                const snapOld = await docRef.get();
                if (snapOld.exists && snapOld.data().locked === true) {
                    throw new Error("BIN ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç RFID ‡∏´‡∏£‡∏∑‡∏≠ MAC ‡πÑ‡∏î‡πâ");
                }

                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à RFID ‡∏ã‡πâ‡∏≥ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ñ‡∏±‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
                if (rfid) {
                    const dup = await checkDuplicateRfidRealtime(rfid);
                    if (dup && dup.binId !== binId) {
                        throw new Error("RFID ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏ñ‡∏±‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
                    }
                }


                const data = {
                    RFID: rfid,
                    lng,
                    lat,
                    details: det,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                editMsg.textContent = t('editSaving');
                editMsg.className = "muted";

                await docRef.set(data, {
                    merge: true
                });
                editMsg.textContent = t('editSaveSuccess');
                editMsg.className = "muted ok";
                setBinsStatus(`${t('editSaveSuccess')} ${binId}`, "ok");
                setTimeout(closeEditModal, 600);
            } catch (e) {
                editMsg.textContent = `${t('editSaveError')} ${errStr(e)}`;
                editMsg.className = "muted err";
            }
        };
        // ‡πÅ‡∏ô‡∏ö handler ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
        editForm.addEventListener("submit", editFormSubmitHandler);


        window.editBin = async function (zone, binId) {
            try {
                // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å closeEditModal ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏î‡∏¥‡∏°
                closeEditModal();

                const docRef = db
                    .collection("smartbins")
                    .doc(zone)
                    .collection("bin_data")
                    .doc(binId);

                const snap = await docRef.get();
                if (!snap.exists) {
                    setBinsStatus(`${t('errorBinNotFound')} ${binId}`, "err");
                    return;
                }
                const d = snap.data() || {};

                if (d.locked === true) {
                    editRfid.disabled = true;
                    editMacAddress.disabled = true;
                } else {
                    editRfid.disabled = false;
                }


                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå (‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß)
                editDocZone.value = zone;
                editDocArea.value = d.area || "";
                editDocBinId.value = binId;
                editZoneDisplay.value = zone;
                editAreaDisplay.value = d.area || "‚Äî";
                editBinIdDisplay.value = binId;

                editRfid.value = d.RFID || d.rfid || "";
                if (editMacAddress) editMacAddress.value = d.macAddress || "‚Äî"; // üö® NEW
                editLat.value = d.lat !== undefined && d.lat !== null ? d.lat : "";
                editLng.value = d.lng !== undefined && d.lng !== null ? d.lng : "";
                document.getElementById("editDetails").value = d.details || "";

                openEditModal();
            } catch (e) {
                setBinsStatus("‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + errStr(e), "err");
            }
        };

        // ---------- Delete bin (soft delete) ----------
        window.deleteBin = function (zone, binId) {
            const binData = bins.find(b => b.zone === zone && b.binId === binId);
            const area = binData?.data?.area || "‚Äî";

            showDeleteConfirmModal(
                { zone, area, binId },
                async () => {
                    try {
                        const docRef = db
                            .collection("smartbins")
                            .doc(zone)
                            .collection("bin_data")
                            .doc(binId);

                        await docRef.set({
                            isHidden: true,
                            deletedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });

                        setBinsStatus(`${t('deleteSuccess')} ${binId}`, "ok");
                    } catch (e) {
                        setBinsStatus(`${t('deleteError')} ${errStr(e)}`, "err");
                    }
                }
            );
        };


        // ---------- Add Bin Modal (‡πÄ‡∏û‡∏¥‡πà‡∏° listen/unlisten MAC) ----------
        function openAddModal() {
            // ‡∏õ‡∏¥‡∏î Modal ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Add Bin Modal
            closeZoneModal(false);
            closeAreaModal(false);
            closeEditModal(); // ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ã‡πâ‡∏≥ (‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Edit Modal)

            // Clear form and reset visibility before showing
            clearForm();

            // üö® NEW: Load MAC Addresses
            listenForOnlineMacAddresses();
            // END NEW

            setTimeout(() => {
                macAddressEl.focus();
            }, 100);

            addBinBackdrop.classList.add("show");
            lockBodyScroll(true); // ‡∏•‡πá‡∏≠‡∏Å scroll ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        }

        function closeAddModal(unlockScroll = true) {
            addBinBackdrop.classList.remove("show");
            clearForm();

            detachRfidListener();

            // üö® NEW: Stop listening to MAC Addresses
            if (macAddressListenerUnsub) {
                macAddressListenerUnsub();
                macAddressListenerUnsub = null;
            }
            // END NEW

            if (unlockScroll) {
                lockBodyScroll(false); // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å scroll ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
            }
        }


        btnToggleForm.addEventListener("click", openAddModal);
        btnAddClose.addEventListener("click", async () => {
            await releaseConfirmedMac();
            closeAddModal(true);
        });

        // ‡∏õ‡∏¥‡∏î modal ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á
        addBinBackdrop.addEventListener("click", async (e) => {
            if (e.target === addBinBackdrop) {
                await releaseConfirmedMac();
                closeAddModal(true);
            }
        });



        // ---------- Language (No change needed, but include context for completeness) ----------
        function updateLangMenuActive() {
            langIconBtn.setAttribute("aria-label", t('ariaChangeLanguage'));

            if (!langMenu) return;
            langMenu.querySelectorAll("button[data-lang]").forEach(btn => {
                btn.classList.toggle("active", btn.dataset.lang === currentLang);
            });
        }

        function changeLanguage(lang, isUpdate = false) {
            if (!window.SW_Translations || !window.SW_Translations[lang]) return;
            currentLang = lang;

            langSelect.value = currentLang;

            document.title = getTranslation('pageTitle_bins');
            $("pageTitleHeading").textContent = getTranslation('mainTitle_bins');

            if (window.AdminNav) {
                window.AdminNav.setLanguage(currentLang);
            }
            if (window.AdminUser) {
                window.AdminUser.setLanguage(currentLang);
            }

            if ($("labelZone")) $("labelZone").textContent = getTranslation('labelZone');
            $("labelArea").textContent = getTranslation('labelArea'); // New Area
            $("labelBinId").textContent = getTranslation('labelBinId');
            $("labelOwner").textContent = getTranslation('labelOwner');
            $("labelRfid").textContent = getTranslation('labelRfid');
            $("labelPosition").textContent = getTranslation('labelPosition');
            $("labelDetails").textContent = getTranslation('labelDetails');

            // --- Update Placeholders and button text ---
            rfidEl.placeholder = getTranslation('placeholderRfid');
            binIdEl.placeholder = getTranslation('placeholderBinId');
            lngEl.placeholder = getTranslation('placeholderLng');
            latEl.placeholder = getTranslation('placeholderLat');
            detailsEl.placeholder = getTranslation('placeholderDetails');

            btnGetPos.textContent = getTranslation('btnGetGps');
            $("btnSave").textContent = getTranslation('btnSave');
            btnReset.textContent = getTranslation('btnReset');

            // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ + ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ñ‡∏±‡∏á (‡πÅ‡∏°‡πâ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô CSS ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡∏ã‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß‡πâ)
            if (addBinHeaderTitle) addBinHeaderTitle.textContent = t('addBinHeaderTitle');
            if (btnToggleForm) btnToggleForm.textContent = t('btnShowForm');
            const addBinModalTitle = $("addBinModalTitle");
            if (addBinModalTitle) addBinModalTitle.textContent = t('addBinHeaderTitle');

            renderOwnerSelect();

            $("filterZoneLabel").textContent = t('filterZoneLabel');
            $("filterAreaLabel").textContent = t('filterAreaLabel'); // New Area
            $("filterBinLabel").textContent = t('filterBinLabel');
            filterBinText.placeholder = t('filterBinPlaceholder');

            $("thZone").textContent = t('tableHeaderZone');
            $("thArea").textContent = t('tableHeaderArea'); // New Area
            $("thBin").textContent = t('tableHeaderBin');
            $("thOwner").textContent = t('tableHeaderOwner');
            $("thRfid").textContent = t('tableHeaderRfid');
            $("thCoords").textContent = t('tableHeaderCoords');
            $("thDetails").textContent = t('tableHeaderDetails');
            $("thUpdated").textContent = t('tableHeaderUpdated');
            $("thManage").textContent = t('tableHeaderManage');

            // Edit Modal Texts (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Card ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ Duplicate)
            $("editModalTitle").textContent = t('editModalTitle');
            $("editLabelZone").textContent = t('editLabelZone');
            $("editLabelArea").textContent = t('editLabelArea'); // New Area
            $("editLabelBinId").textContent = t('editLabelBinId');
            $("editLabelRfid").textContent = t('editLabelRfid');
            $("editLabelPosition").textContent = t('editLabelPosition');
            $("editLabelDetails").textContent = t('editLabelDetails');
            $("editCancel").textContent = t('btnCancel');
            $("btnSaveChanges").textContent = t('btnSaveChanges');

            newZoneNameEl.placeholder = t('zoneModalNewPlaceholder');
            newAreaNameEl.placeholder = t('areaModalNewPlaceholder');
            // ---------- MAC Address ----------
            $("labelMacAddress").textContent = t('labelMacAddress');
            $("btnConfirmMac").textContent = t('btnConfirmMac');

            // default option (loading / empty)
            const macLoadingOpt = $("macLoadingOption");
            if (macLoadingOpt) {
                macLoadingOpt.textContent = t('macLoading');
            }

            renderZoneFilterOptions();
            renderAreaFilterOptions(); // New Area
            updateLangMenuActive();

            if (window.AdminProfile) {
                AdminProfile.setLanguage(currentLang);
            }
            if (!isUpdate) {
                renderZoneSelect();
                renderZoneList();
            }
        }

        langIconBtn.addEventListener("click", () => {
            langMenu.classList.toggle("show");
        });

        langMenu.addEventListener("click", e => {
            const btn = e.target.closest("button[data-lang]");
            if (!btn) return;

            const lang = btn.dataset.lang;

            if (window.AdminLang) {
                window.AdminLang.setLang(lang);
            } else {
                changeLanguage(lang);
            }

            langMenu.classList.remove("show");
        });

        // ---------- ‡πÄ‡∏°‡∏ô‡∏π 3 ‡∏Ç‡∏µ‡∏î ----------
        function toggleMenu() {
            const isOpen = sidebarEl.classList.toggle('show');
            if (isOpen) {
                document.body.classList.add('menu-open');
            } else {
                document.body.classList.remove('menu-open');
            }
        }

        menuToggleBtn.addEventListener("click", toggleMenu);

        document.addEventListener("click", (e) => {
            const clickedInLang = langMenu.contains(e.target) || langIconBtn.contains(e.target);

            // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏†‡∏≤‡∏©‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô
            if (!clickedInLang) langMenu.classList.remove("show");

            // ‡∏õ‡∏¥‡∏î sidebar ‡∏ö‡∏ô‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å
            if (window.innerWidth <= 900) {
                const withinSidebar = sidebarEl.contains(e.target);
                const withinBtn = menuToggleBtn.contains(e.target);

                if (!withinSidebar && !withinBtn) {
                    sidebarEl.classList.remove("show");
                    document.body.classList.remove("menu-open");
                }
            }
        });

        // -----------------------------------------------------------
        // üö® NEW: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö MAC Address 
        // -----------------------------------------------------------

        function renderMacAddressSelect() {
            if (!macAddressEl) return;
            const selected = macAddressEl.value;

            macAddressEl.innerHTML = "";
            const opt0 = document.createElement("option");
            opt0.value = "";

            if (!macAddresses.length) {
                opt0.textContent = t('macSelectOffline');
                macAddressEl.disabled = true;
                if (btnConfirmMac) btnConfirmMac.disabled = true;
            } else {
                opt0.textContent = t('macSelectDefault');
                macAddressEl.disabled = false;
                if (btnConfirmMac) btnConfirmMac.disabled = (selected === "");
            }
            macAddressEl.appendChild(opt0);

            macAddresses.forEach(mac => {
                const option = document.createElement("option");
                option.value = mac.mac;
                option.textContent = mac.mac;
                macAddressEl.appendChild(option);
            });

            // ‚≠ê ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ MAC ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏°‡∏≠
            if (confirmedMacTemp) {
                macAddressEl.value = confirmedMacTemp;
            } else if (selected && macAddresses.some(m => m.mac === selected)) {
                macAddressEl.value = selected;
            } else {
                macAddressEl.value = "";
            }

            if (btnConfirmMac) btnConfirmMac.disabled = (macAddressEl.value === "");
        }

        function updateOnlineMacs() {
            const now = Date.now();
            const online = [];

            for (const mac in lastDevicesSnapshot) {
                const device = lastDevicesSnapshot[mac] || {};
                const lastUpdate = Number(device.lastUpdate || 0);

                const isBound = device.bound === true;
                const isInUse = !!device.currentAdmin;

                const isMine = (mac === confirmedMacTemp); // ‚≠ê ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å

                if (
                    now - lastUpdate <= OFFLINE_TIMEOUT_MS &&
                    !isBound &&
                    (!isInUse || isMine)   // üî• ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
                ) {
                    online.push({ mac });
                }
            }

            macAddresses = online;
            renderMacAddressSelect();
        }


        // üü¢üü¢üü¢ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö status) üü¢üü¢üü¢
        function listenForOnlineMacAddresses() {
            if (macAddressListenerUnsub) {
                macAddressListenerUnsub();
                macAddressListenerUnsub = null;
            }

            const macRef = rtdb.ref(DEVICES_STATUS_BASE_PATH);

            const listener = macRef.on("value", snapshot => {
                lastDevicesSnapshot = snapshot.val() || {};
                updateOnlineMacs(); // ‚Üê ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏±‡∏ô‡∏ó‡∏µ 1 ‡∏£‡∏≠‡∏ö
            });

            macAddressListenerUnsub = () => macRef.off("value", listener);
        }

        // ‚è±Ô∏è ‡πÄ‡∏ä‡πá‡∏Ñ MAC ‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)
        setInterval(() => {
            updateOnlineMacs();
        }, 5000);

        // -----------------------------------------------------------
        // üö® NEW: ‡∏ü‡∏±‡∏á RFID ‡∏à‡∏≤‡∏Å RTDB (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö child_added + child_changed)
        // -----------------------------------------------------------

        function attachRfidListener() {
            const uid = window.ADMIN_AUTH?.uid;
            if (!uid || rfidListenerRef) return;

            const ref = rtdb.ref(`admin_rfid_input/${uid}`);
            rfidListenerRef = ref;

            ref.on("value", async snap => {
                const data = snap.val();
                if (!data?.tagId) return;

                const rfidValue = data.tagId.toUpperCase();
                rfidEl.value = rfidValue;
                rfidEl.dispatchEvent(new Event("input"));
                rfidEl.focus();

                // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ö
                await ref.remove();
            });
        }

        function detachRfidListener() {
            if (rfidListenerRef) {
                rfidListenerRef.off();
                rfidListenerRef = null;
            }
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        changeLanguage(currentLang);
        loadOwners();

        // üö® ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ü‡∏±‡∏á RFID ‡∏à‡∏≤‡∏Å RTDB
        // attachRfidListener();

        // üßπ ‡∏õ‡∏¥‡∏î listener ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ (‡∏Å‡∏±‡∏ô memory leak)
        window.addEventListener("beforeunload", () => {
            if (confirmedMacTemp) {
                rtdb
                    .ref(`esp32_devices/${confirmedMacTemp}/currentAdmin`)
                    .remove();
            }
        });

    </script>
</body>

</html>