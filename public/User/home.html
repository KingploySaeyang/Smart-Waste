<!doctype html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <title></title>
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="../i18n/lang.js"></script>
    <script src="../i18n/th.js"></script>
    <script src="../i18n/en.js"></script>
    <script src="../i18n/ms.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        /* =====================================================
           HOME PAGE i18n BOOTSTRAP (CLEAN)
           ===================================================== */
        (function initHomeT() {

            const lang =
                localStorage.getItem("sw_lang") ||
                (window.USER_LANG && window.USER_LANG.getLang?.()) ||
                "th";

            if (!window.SW_Translations || !window.SW_Translations[lang]) {
                console.error("[i18n] Missing translations for lang:", lang);
                window.T = {};
                return;
            }

            window.T = window.SW_Translations[lang];

        })();
    </script>

    <style>
        /* --- 1. Global Theme (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£) --- */
        :root {
            --primary: #059669;
            --primary-dark: #064e3b;
            --accent: #34d399;
            --bg-body: #f0fdf4;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --sidebar-width: 260px;
            --radius: 24px;
            --shadow: 0 10px 30px -10px rgba(5, 150, 105, 0.15);
            --lang-shadow: 0 12px 30px rgba(0, 0, 0, .18);

        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Prompt", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            min-height: 100vh;
            display: flex;
            background-color: var(--bg-body);
            color: var(--text-main);
            overflow-y: auto;
        }

        /* Loading Screen */
        #globalLoader {
            position: fixed;
            inset: 0;
            background: #fff;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        .loader-spin {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Sidebar (Desktop) */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #064e3b 0%, #047857 100%);
            color: #fff;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow: hidden;
            z-index: 50;
            box-shadow: 5px 0 25px rgba(0, 0, 0, 0.1);
        }

        .brand {
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand i {
            font-size: 32px;
            color: var(--accent);
        }

        .brand h2 {
            font-size: 24px;
            font-weight: 700;
        }

        .menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
        }

        .menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #d1fae5;
            text-decoration: none;
            padding: 14px 16px;
            border-radius: 16px;
            transition: 0.3s;
            font-weight: 500;
        }

        .menu a:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .menu a.active {
            background: #fff;
            color: var(--primary-dark);
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .logout-btn {
            background: rgba(0, 0, 0, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(252, 165, 165, 0.2);
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: 0.2s;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        /* Main Content */
        main {
            flex: 1;
            padding: 30px 40px;
            overflow: visible;
            max-width: 1600px;
            margin: 0 auto;
            position: relative;
        }

        /* Topbar */
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .titles h1 {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary-dark);
            margin: 0;
        }

        .titles p {
            font-size: 14px;
            color: var(--text-muted);
            margin-top: 5px;
        }

        /* Desktop: Hide Mobile Brand */
        .mobile-brand {
            display: none;
        }

        /* Profile Chip */
        .user-chip {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #fff;
            padding: 8px 20px 8px 8px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            white-space: nowrap;
        }

        .avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--primary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            font-size: 18px;
        }

        /* Card (Desktop) */
        .card {
            background: #fff;
            border-radius: var(--radius);
            padding: 35px;
            box-shadow: var(--shadow);
            position: relative;
            height: auto;
            min-height: 400px;
        }

        /* Controls */
        .selector {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
            margin-bottom: 40px;
        }

        .select-wrap {
            flex: 1;
            min-width: 280px;
        }

        label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            color: var(--text-main);
        }

        select,
        input,
        textarea {
            width: 100%;
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            background: #f8fafc;
            font-size: 15px;
        }

        select:disabled {
            background: #e2e8f0;
            color: #94a3b8;
            cursor: not-allowed;
        }

        .primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            border: none;
            padding: 14px 24px;
            border-radius: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .primary:active {
            transform: scale(0.98);
        }

        .ghost {
            background: #f1f5f9;
            color: var(--text-muted);
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Empty State */
        .empty {
            text-align: center;
            padding: 60px 20px;
            background: #fff;
            border-radius: 24px;
            border: 2px dashed #cbd5e1;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }

        .empty i {
            font-size: 64px;
            color: #cbd5e1;
            margin-bottom: 20px;
            display: block;
        }

        /* Bin Visual */
        #binCard[hidden] {
            display: none !important;
        }

        #binCard {
            display: flex;
            flex-wrap: wrap;
            gap: 50px;
            justify-content: center;
            align-items: flex-start;
        }

        .bin-shell {
            width: 220px;
            height: 320px;
            border-radius: 30px;
            border: 6px solid #9ca3af;
            background: #f8fafc;
            position: relative;
            overflow: hidden;
        }

        /* ‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß‡πÉ‡∏ô‡∏ñ‡∏±‡∏á */
        .bin-liquid {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 0%;
            background: linear-gradient(180deg,
                    #f97316,
                    #fb923c);
            transition: height 0.8s ease;
        }

        /* ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç % */
        .bin-percent {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            font-weight: 800;
            color: #1f2937;
            text-shadow: 0 2px 8px rgba(255, 255, 255, 0.6);
            z-index: 5;
        }


        /* Wave Animation */
        .bin-fill::after {
            content: "";
            position: absolute;
            top: -10px;
            left: 0;
            width: 200%;
            height: 20px;
            background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1200 120" xmlns="http://www.w3.org/2000/svg"><path d="M0 0v46.29c47.79 22.2 103.59 32.17 158 28 70.36-5.37 136.33-33.31 206.8-37.5 73.84-4.36 147.54 16.88 218.2 35.26 69.27 18 138.3 24.88 209.4 13.08 36.15-6 69.85-17.84 104.45-29.34C989.49 25 1113-14.29 1200 52.47V0z" opacity=".25" fill="%23FFFFFF" /></svg>');
            background-size: 50% 100%;
            animation: wave 3s linear infinite;
        }

        @keyframes wave {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-50%);
            }
        }

        .bin-percent {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 800;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 5;
        }

        .bin-info {
            flex: 1;
            min-width: 300px;
        }

        .bin-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .status-badge {
            background: #dcfce7;
            color: #16a34a;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #16a34a;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(22, 163, 74, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(22, 163, 74, 0);
            }
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }

        .info-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 15px;
            border-radius: 16px;
            transition: 0.2s;
        }

        .info-item span {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            display: block;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
        }

        /* Overlay */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: 0.3s;
        }

        .overlay.show {
            display: flex;
            opacity: 1;
        }

        .panel {
            background: #fff;
            width: 100%;
            max-width: 550px;
            border-radius: 24px;
            padding: 35px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: 0.3s;
        }

        .overlay.show .panel {
            transform: scale(1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .col-span-2 {
            grid-column: span 2;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .success-card {
            background: #fff;
            padding: 40px;
            border-radius: 24px;
            text-align: center;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: #dcfce7;
            color: #16a34a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 20px;
        }

        /* FAB Button */
        .fab-btn {
            display: none;
            position: fixed;
            bottom: 110px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--primary));
            color: #fff;
            border: none;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 90;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .fab-btn:active {
            transform: scale(0.9);
        }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 850px) {
            body {
                flex-direction: column;
                padding: 0;
                overflow: auto;
                /* Allow body scroll */
            }

            /* Sidebar Bottom Nav */
            .sidebar {
                position: fixed;
                bottom: 0;
                top: auto;
                width: 100%;
                height: auto;
                flex-direction: row;
                padding: 10px 20px;
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(10px);
                border-top: 1px solid #e2e8f0;
                z-index: 100;
            }

            .sidebar .brand,
            .sw-logout-slot {
                display: none;
            }

            .menu {
                flex-direction: row;
                justify-content: space-around;
                width: 100%;
                gap: 0;
            }

            .menu a {
                flex-direction: column;
                gap: 4px;
                padding: 8px;
                font-size: 10px;
                color: var(--text-muted);
                background: none;
            }

            .menu a i {
                font-size: 28px;
                margin-bottom: 2px;
            }

            .menu a.active {
                color: var(--primary);
            }

            /* MAIN: Layout Adjustment */
            main {
                padding: 0;
                display: flex;
                flex-direction: column;
                min-height: 100vh;
                width: 100%;
                padding-bottom: 90px;
                /* Space for Bottom Nav */
            }

            /* TOPBAR STYLE */
            .topbar {
                padding: 0;
                margin: 0;
                width: 100%;
                flex-shrink: 0;
                display: flex;
                flex-direction: column;
                /* Stack Brand Bar and Title */
                gap: 0;
            }

            /* 1. Mobile Brand (Full Width Green Header) */
            .mobile-brand {
                display: flex;
                justify-content: space-between;
                /* Brand Left, Profile Right */
                align-items: center;
                width: 100%;
                padding: 15px 25px;

                /* Dark Green Gradient Background */
                background: linear-gradient(180deg, #064e3b 0%, #047857 100%);
                color: #fff;
                /* White Text */
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }

            .brand-left {
                display: flex;
                align-items: center;
                font-size: 20px;
                font-weight: 700;
            }

            .brand-left i {
                font-size: 24px;
                color: var(--accent);
            }

            /* 2. User Profile inside Mobile Brand */
            .user-chip-mobile {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 4px;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.4);
            }

            .user-chip-desktop {
                display: none;
            }

            /* Hide the desktop profile in topbar area */
            .avatar-mobile {
                width: 34px;
                height: 34px;
                border-radius: 50%;
                background: #fff;
                color: var(--primary);
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                font-size: 14px;
            }

            /* 3. Titles (Below Green Header) */
            .titles {
                padding: 20px 25px 0 25px;
                /* Add top spacing */
                width: 100%;
            }

            .titles h1 {
                font-size: 24px;
                color: var(--primary-dark);
                margin: 0;
            }

            .titles p {
                display: block;
                font-size: 13px;
                color: var(--text-muted);
                margin-top: 6px;
                opacity: 0.8;
            }

            /* CARD */
            .card {
                margin: 20px auto;
                width: 92%;
                border-radius: 24px;
                flex: none;
                height: auto;
                min-height: auto;
                padding: 30px 25px 50px 25px;
                border: none;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }

            /* FORM PANEL */
            .panel {
                width: 88%;
                padding: 25px;
            }

            .selector {
                gap: 10px;
                margin-bottom: 20px;
            }

            .select-wrap {
                width: 100%;
                min-width: 0;
            }

            #btnOpenForm {
                display: none;
            }

            .fab-btn {
                display: flex;
            }

            #binCard {
                flex-direction: column;
                align-items: center;
                gap: 30px;
            }

            .bin-info {
                width: 100%;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .col-span-2 {
                grid-column: span 1;
            }
        }

        /* =====================================================
   LANGUAGE SWITCHER (FINAL ‚Äì CLEAN)
   ===================================================== */

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡∏≠‡∏ö */
        .lang-switcher {
            position: relative;
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏•‡∏Å */
        .lang-switcher .icon-btn {
            border-radius: 50%;
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lang-switcher .icon-btn:hover {
            background: #f1f5f9;
        }

        /* Dropdown ‡∏†‡∏≤‡∏©‡∏≤ */
        .lang-menu {
            position: absolute;
            top: 55px;
            right: 0;
            background: #fff;
            border-radius: 14px;
            box-shadow: var(--lang-shadow);
            padding: 6px;
            min-width: 160px;
            display: none;
            z-index: 999;
        }

        /* ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏ô‡∏π */
        .lang-menu.show {
            display: block;
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏†‡∏≤‡∏©‡∏≤ */
        .lang-menu button {
            width: 100%;
            background: none;
            border: none;
            padding: 10px 14px;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
            border-radius: 10px;
            transition: .2s;
        }

        /* hover */
        .lang-menu button:hover {
            background: #f1f5f9;
        }

        /* ‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà */
        .lang-menu button.active {
            background: #e6f9f1;
            color: var(--primary-dark);
            font-weight: 700;
            box-shadow: inset 0 0 0 1px var(--accent);
        }
    </style>
</head>

<body>
    <script>
        // -----------------------------------------------------
        // Firebase Configuration
        // -----------------------------------------------------
        var firebaseConfig = {
            apiKey: "AIzaSyCyTSsRmX642krpJYOI-TfFpIhnxJBbzxk",
            authDomain: "smart-waste2568.firebaseapp.com",
            projectId: "smart-waste2568",
            storageBucket: "smart-waste2568.firebasestorage.app",
            messagingSenderId: "122699752010",
            appId: "1:122699752010:web:c22ab9b28ac15beaedbcb3",
            databaseURL: "https://smart-waste2568-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
    </script>

    <script src="../Login/auth.js"></script>
    <script src="user-auth-bootstrap.js" defer></script>

    <!-- =======================
     GLOBAL LOADER
======================= -->
    <div id="globalLoader">
        <div class="loader-spin"></div>
        <p class="muted" id="loadingText" style="font-size:14px;"></p>
    </div>

    <!-- =======================
     SIDEBAR
======================= -->
    <aside class="sidebar">
        <div class="brand">
            <i class="ri-recycle-line"></i>
            <h2 id="brandTitle"></h2>
        </div>

        <nav class="menu">
            <a href="home.html" class="active">
                <i class="ri-delete-bin-2-line"></i>
                <span id="menuMyBins"></span>
            </a>

            <a href="map.html">
                <i class="ri-map-pin-2-line"></i>
                <span id="menuMap"></span>
            </a>

            <div class="sw-logout-slot">
                <button onclick="SWAuth.logout()" class="logout-btn">
                    <i class="ri-logout-box-line"></i>
                    <span id="menuLogout"></span>
                </button>
            </div>
        </nav>
    </aside>

    <main>

        <!-- ===== TOP BAR ===== -->
        <div class="topbar">

            <!-- MOBILE BRAND -->
            <div class="mobile-brand">
                <div class="brand-left">
                    <i class="ri-recycle-line"></i>
                </div>
                <div class="user-chip-mobile">
                    <div class="avatar-mobile" id="userAvatarMobile">U</div>
                </div>
            </div>

            <!-- TITLES -->
            <div class="titles">
                <h1 id="homeTitle"></h1>
                <p id="homeSubtitle"></p>
            </div>

            <!-- RIGHT SIDE -->
            <div class="topbar-right">

                <!-- USER -->
                <div class="user-chip user-chip-desktop">
                    <div class="avatar" id="userAvatar">U</div>
                    <div>
                        <strong id="userLabel"></strong><br>
                        <small id="userRole" style="font-size:12px;color:#64748b;"></small>
                    </div>
                </div>

                <!-- LANGUAGE SWITCHER -->
                <div class="lang-switcher">
                    <button class="icon-btn" id="langIconBtn" type="button">
                        <i class="ri-global-line"></i>
                    </button>

                    <div class="lang-menu" id="langMenu">
                        <button type="button" data-lang="th">‡πÑ‡∏ó‡∏¢</button>
                        <button type="button" data-lang="en">English</button>
                        <button type="button" data-lang="ms">Bahasa Melayu</button>
                    </div>
                </div>

            </div>
        </div>
        <!-- ===== END TOP BAR ===== -->

        <!-- ===== CARD ===== -->
        <div class="card">

            <div class="selector">
                <div class="select-wrap">
                    <label>
                        <i class="ri-list-check"></i>
                        <span id="labelSelectBin"></span>
                    </label>
                    <select id="binSelect" disabled>
                        <option id="binSelectInit"></option>
                    </select>
                </div>
            </div>

            <div id="binCard" hidden>

                <div class="bin-visual">
                    <div class="bin-shell">
                        <div class="bin-liquid" id="binFill"></div>
                        <div class="bin-percent" id="binPercent">0%</div>
                    </div>
                </div>

                <div class="bin-info">

                    <div class="bin-header">
                        <h2 id="binTitle" style="font-size:26px;color:var(--text-main);"></h2>
                        <span id="liveBadge" class="status-badge" style="display:none;">
                            <span class="live-dot"></span> LIVE
                        </span>
                    </div>

                    <p class="muted" id="binDesc" style="margin-bottom:20px;"></p>

                    <div class="info-grid">

                        <div class="info-item">
                            <span><i class="ri-map-2-line"></i> <span id="labelZoneArea"></span></span>
                            <div class="info-value" id="binZoneArea">-</div>
                        </div>

                        <div class="info-item">
                            <span><i class="ri-barcode-box-line"></i> <span id="labelRfid"></span></span>
                            <div class="info-value" id="binRfid">-</div>
                        </div>

                        <div class="info-item">
                            <span><i class="ri-cpu-line"></i> <span id="labelMac"></span></span>
                            <div class="info-value" id="binMac">-</div>
                        </div>

                        <div class="info-item">
                            <span><i class="ri-gps-line"></i> <span id="labelGps"></span></span>
                            <div class="info-value" id="binCoords" style="font-size:14px;">-</div>
                        </div>

                        <div class="info-item">
                            <span><i class="ri-time-line"></i> <span id="labelUpdated"></span></span>
                            <div class="info-value" id="binUpdated">-</div>
                        </div>

                    </div>

                    <p id="status" class="muted" style="margin-top:20px;text-align:center;font-size:13px;">
                    </p>

                </div>
            </div>
        </div>
        <!-- ===== END CARD ===== -->

    </main>

    <script>
        const $ = id => document.getElementById(id);
        const userLabelEl = $("userLabel");
        const userAvatar = $("userAvatar");
        const userAvatarMobile = $("userAvatarMobile");
        const binSelect = $("binSelect");
        const binCard = $("binCard");
        const liveBadge = $("liveBadge");
        const binFill = $("binFill");
        const binPercent = $("binPercent");
        const binTitle = $("binTitle");
        const binDesc = $("binDesc");

        const binZoneArea = $("binZoneArea");
        const binRfid = $("binRfid");
        const binMac = $("binMac");
        const binCoords = $("binCoords");
        const binUpdated = $("binUpdated");
        const statusEl = $("status");
        const loader = $("globalLoader");

        // Hide Loader
        window.addEventListener('load', () => {
            setTimeout(() => {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
            }, 500);
        });

        const db = firebase.firestore();
        const rtdb = firebase.database();
        let myBins = [];
        let currentBin = null;
        let currentBinId = null;
        let rtdbRef = null;
        let rtdbCallback = null;

        let currentUser = null;

        // Utilities
        function setStatus(text, type) {
            statusEl.textContent = text || "";
            statusEl.style.color = type === "err" ? "#ef4444" : "#059669";
            if (type === "ok") {
                setTimeout(() => statusEl.textContent = "", 4000);
            }
        }

        function formatTimestamp(ts) {
            if (!ts) return "-";
            let date = ts;
            if (typeof ts.toDate === "function") date = ts.toDate();
            else if (!(ts instanceof Date)) date = new Date(ts);
            if (!(date instanceof Date) || isNaN(date)) return "-";
            const localeMap = { th: "th-TH", en: "en-US", ms: "ms-MY" };
            const locale = localeMap[currentLang] || "th-TH";
            return date.toLocaleString(locale, { dateStyle: "medium", timeStyle: "short" });
        }

        // --- UPDATED: Load My Bins (Group Query) ---
        async function loadMyBins() {
            myBins = [];
            binSelect.innerHTML = `<option>${T.loadingData}</option>`;
            binSelect.disabled = true;

            try {
                // ‡πÉ‡∏ä‡πâ collectionGroup ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ bin_data ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å Zone ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏ô‡∏ß‡πà‡∏≤ Zone (Parent) ‡∏à‡∏∞‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const snapshot = await db.collectionGroup("bin_data")
                    .where("ownerUsername", "==", currentUser.username)
                    .where("isHidden", "==", false)
                    .get();

                if (snapshot.empty) {
                    renderBinList();
                    return;
                }

                snapshot.forEach(doc => {
                    const d = doc.data();

                    // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠ Zone ‡∏à‡∏≤‡∏Å Path (Parent ‡∏Ç‡∏≠‡∏á Parent)
                    const zoneId = doc.ref.parent.parent ? doc.ref.parent.parent.id : "Unknown";

                    myBins.push({
                        id: `${zoneId}/${doc.id}`,
                        zone: zoneId,
                        binId: d.binId || doc.id,
                        macAddress: d.macAddress || null,
                        ...d
                    });
                });

                renderBinList();

            } catch (err) {
                console.error("Load Bins Error:", err);
                binSelect.innerHTML = `<option>${T.errorLoading}</option>`;

                // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Index
                if (err.code === 'failed-precondition' || err.message.includes("index")) {
                    alert(T.errNeedIndex);
                }
            }
        }

        // --- 3. Load Bin Details & Listen RTDB ---
        async function loadBinDetail(entry) {
            if (!entry) return;

            if (rtdbRef && rtdbCallback) {
                rtdbRef.off("value", rtdbCallback);
                rtdbRef = null;
                rtdbCallback = null;
            }

            currentBin = entry;

            binTitle.textContent = entry.binId;
            binDesc.textContent = entry.details || "-";
            binZoneArea.textContent = `${entry.zone} / ${entry.area || "-"}`;
            binRfid.textContent = entry.RFID || "-";
            binMac.textContent = entry.macAddress || "-";
            binCoords.textContent =
                entry.lat && entry.lng
                    ? `${entry.lat.toFixed(5)}, ${entry.lng.toFixed(5)}`
                    : "-";
            binUpdated.textContent = formatTimestamp(entry.updatedAt);

            binFill.style.height = "0%";
            binPercent.textContent = "0%";
            liveBadge.style.display = "none";

            if (!entry.macAddress) {
                setStatus(T.errNoMac, "err");
                return;
            }

            const devicePath = `esp32_devices/${entry.macAddress}`;
            console.log("üì° RTDB PATH =", devicePath);

            rtdbRef = rtdb.ref(devicePath);

            rtdbCallback = snapshot => {
                const device = snapshot.val();
                console.log("üì¶ RTDB DATA =", device);

                if (!device || typeof device.lastUpdate !== "number") {
                    setOffline(T.errNoDevice);
                    return;
                }

                const diffSec = (Date.now() - device.lastUpdate) / 1000;

                if (diffSec > 30) {
                    setOffline(`${T.offline} (${Math.floor(diffSec)}s)`);
                    return;
                }

                if (typeof device.fillLevel !== "number") {
                    setStatus(T.errNoFillLevel, "err");
                    return;
                }

                const level = Math.max(0, Math.min(100, Math.round(device.fillLevel)));

                binFill.style.height = level + "%";
                binPercent.textContent = level + "%";

                if (level > 80) {
                    binFill.style.background = "linear-gradient(180deg, #dc2626, #ef4444)";
                    liveBadge.style.background = "#fee2e2";
                    liveBadge.style.color = "#dc2626";
                    liveBadge.innerHTML = T.binNearFull;
                } else {
                    binFill.style.background = "linear-gradient(180deg, #f97316, #fb923c)";
                    liveBadge.style.background = "#dcfce7";
                    liveBadge.style.color = "#16a34a";
                    liveBadge.innerHTML = `<span class="live-dot"></span> ${T.binLive}`;
                }

                liveBadge.style.display = "inline-flex";
                binUpdated.textContent = new Date(device.lastUpdate).toLocaleString("th-TH");
                setStatus(`${T.statusLive} ${level}%`, "ok");
            };

            rtdbRef.on("value", rtdbCallback);

        }
        function setOffline(msg) {
            liveBadge.style.display = "inline-flex";
            liveBadge.style.background = "#fee2e2";
            liveBadge.style.color = "#dc2626";
            liveBadge.innerHTML = T.binOffline;

            binFill.style.height = "0%";
            binPercent.textContent = "--";

            setStatus(msg || T.errOffline, "err");
        }

        // ===============================
        // Refresh bin status text (i18n)
        // ===============================
        function refreshBinStatusText() {
            if (!currentBin) return;

            // live badge (offline)
            if (liveBadge.style.display !== "none") {
                liveBadge.innerHTML = T.binOffline;
            }

            // status message
            if (statusEl.textContent) {
                if (statusEl.textContent.includes("Device")) {
                    statusEl.textContent = T.errNoDevice;
                }
                if (statusEl.textContent.includes("Offline")) {
                    statusEl.textContent = T.errOffline;
                }
            }
        }

        // --- 4. Render Bin List ---
        function renderBinList() {
            if (!myBins.length) {
                binSelect.disabled = true;
                binSelect.innerHTML = `<option>${T.noBins}</option>`;
                binCard.hidden = true;
                setStatus(T.noBins, "err");
                return;
            }

            binCard.hidden = false;
            binSelect.disabled = false;
            binSelect.innerHTML = "";

            myBins.forEach(entry => {
                const opt = document.createElement("option");
                opt.value = entry.id;
                opt.textContent = `${entry.binId} (${entry.area || "-"})`;
                binSelect.appendChild(opt);
            });

            if (!currentBinId || !myBins.some(b => b.id === currentBinId)) {
                currentBinId = myBins[0].id;
            }

            binSelect.value = currentBinId;
            loadBinDetail(myBins.find(b => b.id === currentBinId));
        }

        // Listeners
        binSelect.onchange = () => {
            const entry = myBins.find(b => b.id === binSelect.value);
            if (entry) { currentBinId = entry.id; loadBinDetail(entry); }
        };

        window.onbeforeunload = () => {
            if (rtdbRef && rtdbCallback) {
                rtdbRef.off("value", rtdbCallback);
            }
        };
    </script>
    <script>
        document.addEventListener("user-auth-ready", () => {
            applyTranslations();

            $("binSelectInit").textContent = T.loadingData;
            binTitle.textContent = T.binPlaceholder;
            binDesc.textContent = T.binDescPlaceholder;

            const user = window.USER_AUTH;
            if (!user) return;

            const initial = user.displayName.charAt(0).toUpperCase();

            userLabelEl.textContent = user.displayName;
            userAvatar.textContent = initial;
            if (userAvatarMobile) userAvatarMobile.textContent = initial;

            // role (user page = ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
            document.getElementById("userRole").textContent = T.userRole_user;

            currentUser = user;

            loadMyBins();
        });

        function applyTranslations() {
            document.title = T.pageTitle_userHome;

            $("brandTitle").textContent = T.brandTitle;
            $("loadingText").textContent = T.loadingData;

            $("homeTitle").textContent = T.homeTitle;
            $("homeSubtitle").textContent = T.homeSubtitle;

            $("labelSelectBin").textContent = T.labelSelectBin;
            $("labelZoneArea").textContent = T.labelZoneArea;
            $("labelRfid").textContent = T.labelRfid;
            $("labelMac").textContent = T.labelMac;
            $("labelGps").textContent = T.labelGps;
            $("labelUpdated").textContent = T.labelUpdated;

            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° 3 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            $("menuMyBins").textContent = T.menuMyBins;
            $("menuMap").textContent = T.menuMap;
            $("menuLogout").textContent = T.menuLogout;

            // user role
            const roleEl = document.getElementById("userRole");
            if (roleEl) {
                roleEl.textContent = T.userRole_user;
            }

        }

        /* ===============================
       USER Language Switcher
       =============================== */
        function updateLangMenuActive() {
            if (!langMenu) return;
            langMenu.querySelectorAll("button[data-lang]").forEach(btn => {
                btn.classList.toggle("active", btn.dataset.lang === currentLang);
            });
        }

        let currentLang =
            localStorage.getItem("sw_lang") ||
            (window.USER_LANG && window.USER_LANG.getLang?.()) ||
            "th";

        const langIconBtn = document.getElementById("langIconBtn");
        const langMenu = document.getElementById("langMenu"); // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô

        applyLangTheme(currentLang);
        updateLangMenuActive(); // ‚úÖ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡πâ‡∏ß

        function changeUserLanguage(lang) {
            if (!window.SW_Translations || !window.SW_Translations[lang]) return;

            currentLang = lang; // ‚úÖ FIX ‡∏´‡∏•‡∏±‡∏Å

            localStorage.setItem("sw_lang", lang);

            if (window.USER_LANG && typeof window.USER_LANG.setLang === "function") {
                window.USER_LANG.setLang(lang);
            }

            // re-init T
            (function initHomeT() {
                window.T = window.SW_Translations[lang];
            })();

            applyTranslations();
            refreshBinStatusText();
            updateLangMenuActive();
            applyLangTheme(lang);
        }

        function applyLangTheme(lang) {
            const root = document.documentElement;

            switch (lang) {
                case "th":
                    root.style.setProperty(
                        "--lang-shadow",
                        "0 12px 30px rgba(5,150,105,.25)"
                    );
                    break;

                case "en":
                    root.style.setProperty(
                        "--lang-shadow",
                        "0 16px 40px rgba(37,99,235,.28)"
                    );
                    break;

                case "ms":
                    root.style.setProperty(
                        "--lang-shadow",
                        "0 14px 34px rgba(245,158,11,.28)"
                    );
                    break;
            }
        }

        // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π (SAFE)
        if (langIconBtn && langMenu) {
            langIconBtn.addEventListener("click", () => {
                langMenu.classList.toggle("show");
            });
        }

        // ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏©‡∏≤
        // ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏©‡∏≤ (SAFE)
        if (langMenu) {
            langMenu.addEventListener("click", e => {
                const btn = e.target.closest("button[data-lang]");
                if (!btn) return;

                changeUserLanguage(btn.dataset.lang);
                langMenu.classList.remove("show");
            });
        }

        // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π = ‡∏õ‡∏¥‡∏î
        document.addEventListener("click", e => {
            if (!langMenu.contains(e.target) && !langIconBtn.contains(e.target)) {
                langMenu.classList.remove("show");
            }
        });
    </script>
</body>

</html>