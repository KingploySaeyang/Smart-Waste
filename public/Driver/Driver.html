<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Waste - ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Auth -->
  <script src="../Login/auth.js"></script>
  <script src="../i18n/lang.js"></script>
  <script src="../i18n/th.js"></script>
  <script src="../i18n/en.js"></script>
  <script src="../i18n/ms.js"></script>
  <script src="driver-auth-bootstrap.js" defer></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", system-ui, Roboto, Arial, sans-serif
    }

    body {
      min-height: 100vh;
      background: #f5f6fa;
      display: flex;
      flex-direction: column;
    }

    :root {
      --btn-min-h: 44px;
      --btn-pad-x: 16px;
      --btn-pad-y: 10px;
      --btn-radius: 999px;
      --btn-font: 15px;
      --card-radius: 18px;
      --card-bg: #ffffff;
      --card-shadow: 0 10px 30px rgba(15, 23, 42, .08);
      --muted: #6b7280;
      --brand: #2563eb;
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 18px 26px;
    }

    /* Header */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }

    .brand-area {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-pill {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #e5f0ff;
      color: #1e40af;
      font-weight: 600;
    }

    .page-title-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .page-title {
      font-size: 22px;
      font-weight: 700;
      color: #111827;
    }

    .page-sub {
      font-size: 13px;
      color: var(--muted);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .lang-switcher select {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      background: #fff;
    }

    .user-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #fff;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 8px 12px;
      box-shadow: 0 6px 18px rgba(15, 23, 42, .08);
    }

    .user-chip .avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: linear-gradient(135deg, #38bdf8, #1d4ed8);
      color: #0f172a;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .user-chip__label {
      margin: 0;
      font-size: 11px;
      color: var(--muted);
    }

    .logout-btn {
      min-height: var(--btn-min-h);
      padding: var(--btn-pad-y) 18px;
      border-radius: var(--btn-radius);
      border: none;
      background: #ef4444;
      color: #fff;
      font-size: var(--btn-font);
      cursor: pointer;
    }

    .logout-btn:hover {
      filter: brightness(1.03);
    }

    .logout-btn:active {
      transform: translateY(1px);
    }

    /* Cards section */
    .card-row {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      margin-bottom: 18px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--card-radius);
      box-shadow: var(--card-shadow);
      padding: 16px 18px;
    }

    .card-small {
      flex: 1 1 220px;
      min-width: 0;
    }

    .card-large {
      margin-top: 14px;
    }

    .card-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .card-main {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-pill {
      background: #e5f0ff;
      color: #1e40af;
    }

    .badge-status-work {
      background: #dcfce7;
      color: #15803d;
    }

    .badge-status-off {
      background: #fee2e2;
      color: #b91c1c;
    }

    .muted {
      font-size: 12px;
      color: var(--muted);
    }

    .muted-strong {
      font-size: 12px;
      color: #4b5563;
    }

    /* Filter radio summary */
    .status-options {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 6px;
    }

    .status-options label {
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    /* Map and route */
    .section-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 700;
      color: #111827;
    }

    .section-sub {
      font-size: 12px;
      color: var(--muted);
    }

    .pill-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .pill-tabs button {
      min-height: var(--btn-min-h);
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      background: #f4f4f5;
      color: #111827;
    }

    .pill-tabs button.active {
      background: var(--brand);
      color: #fff;
    }

    #map {
      width: 100%;
      height: 380px;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      margin-top: 10px;
    }

    .route-legend {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
      margin-top: 8px;
    }

    .legend-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-color {
      width: 16px;
      height: 6px;
      border-radius: 999px;
      background: #2563eb;
    }

    /* Bin pins */
    .leaflet-marker-icon.bin-icon {
      background: transparent;
      border: none;
    }

    .bin-pin {
      --pin-color: #16a34a;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      filter: drop-shadow(0 10px 20px rgba(15, 23, 42, .25));
    }

    .bin-pin__bubble {
      position: relative;
      width: 46px;
      height: 46px;
      border-radius: 16px 16px 12px 12px;
      background: linear-gradient(135deg, var(--pin-color), rgba(255, 255, 255, .2));
      border: 2px solid rgba(255, 255, 255, .85);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #0f172a;
    }

    .bin-pin__pointer {
      width: 0;
      height: 0;
      border: 10px solid transparent;
      border-top-color: var(--pin-color);
      margin-top: -6px;
      filter: brightness(.9);
    }

    .bin-pin__label {
      font-size: 12px;
      font-weight: 600;
      color: #0f172a;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 999px;
      padding: 2px 8px;
      line-height: 1;
      box-shadow: 0 4px 10px rgba(15, 23, 42, .12);
    }

    .bin-pin__label.is-unknown {
      color: #475569;
      background: #f8fafc;
    }

    /* Footer buttons */
    .footer-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 18px;
      gap: 10px;
    }

    .btn {
      min-height: var(--btn-min-h);
      padding: var(--btn-pad-y) var(--btn-pad-x);
      border-radius: var(--btn-radius);
      border: none;
      font-size: var(--btn-font);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform .06s ease, filter .2s ease;
    }

    .btn-primary {
      background: var(--brand);
      color: #fff;
    }

    .btn-ghost {
      background: #f4f4f5;
      color: #111827;
    }

    .btn:hover {
      filter: brightness(1.03);
    }

    .btn:active {
      transform: translateY(1px);
    }

    @media(max-width:900px) {
      .app-shell {
        padding: 14px 12px 20px;
      }

      .topbar {
        flex-direction: column;
        align-items: flex-start;
      }

      .card-row {
        flex-direction: column;
      }

      #map {
        height: 320px;
      }

      .footer-actions {
        justify-content: center;
      }
    }

    .scan-popup {
      position: fixed;
      top: 20px;
      right: 20px;

      /* üî• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ Leaflet */
      z-index: 999999 !important;

      pointer-events: auto;
      animation: slideIn 0.3s ease;
    }


    .scan-popup.hidden {
      display: none;
    }

    .scan-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px 20px;
      width: 320px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .15);
      border-left: 6px solid #22c55e;
    }

    .scan-card h3 {
      margin-bottom: 8px;
      color: #15803d;
    }

    @keyframes slideIn {
      from {
        transform: translateX(120%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      to {
        opacity: 0;
        transform: translateX(120%);
      }
    }

    /* üîí ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Leaflet ‡∏ö‡∏±‡∏á UI */
    .leaflet-container {
      z-index: 1;
    }

    .app-shell {
      position: relative;
      z-index: 2;
    }

    .pill-tabs button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pill-tabs button:not(:disabled) {
      cursor: pointer;
    }

    .topbar {
      pointer-events: auto;
    }

    /* üî• FIX Leaflet ‡∏Å‡∏¥‡∏ô click ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    .leaflet-pane,
    .leaflet-top,
    .leaflet-bottom {
      pointer-events: none !important;
    }

    .topbar,
    .topbar *,
    .footer-actions,
    .footer-actions * {
      pointer-events: auto !important;
      position: relative;
      z-index: 999999 !important;
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <!-- Topbar -->
    <header class="topbar">
      <div class="brand-area">
        <div id="brandPill" class="brand-pill"></div>
        <div class="page-title-wrap">
          <div id="pageTitle" class="page-title"></div>
          <div id="pageSub" class="page-sub"></div>
        </div>
      </div>

      <div class="topbar-right">
        <div class="lang-switcher">
          <select id="langSelect">
            <option value="th">‡πÑ‡∏ó‡∏¢</option>
            <option value="en">English</option>
            <option value="ms">Bahasa Melayu</option>
          </select>
        </div>
        <div class="user-chip">
          <span class="avatar" id="driverAvatar">D</span>
          <div>
            <p class="user-chip__label" id="driverRoleLabel"></p>
            <strong id="driverName"></strong>
          </div>
        </div>
        <button id="btnLogout" class="logout-btn"></button>
      </div>
    </header>

    <!-- Summary cards -->
    <section class="card-row">
      <div class="card card-small">
        <div class="card-label" id="cardDriverLabel"></div>
        <div class="card-main" id="cardDriverName"></div>
        <div class="muted" id="cardDriverInfo"></div>
        <div class="muted" id="cardTruckInfo"></div>

      </div>

      <div class="card card-small">
        <div class="card-label" id="cardTodayRouteLabel"></div>
        <div class="card-main" id="cardTodayRoute"></div>
        <div class="muted" id="cardTodayRouteSub">-</div>
      </div>

      <div class="card card-small">
        <div class="card-label" id="cardWorkStatusLabel"></div>
        <div id="cardWorkStatusBadge" class="badge badge-status-off"></div>
        <div class="status-options">
          <label><input type="radio" name="routeStatus" value="notstart" checked> <span
              id="statusOptionNotStart"></span></label>
          <label><input type="radio" name="routeStatus" value="working"> <span id="statusOptionWorking"></span></label>
          <label><input type="radio" name="routeStatus" value="done"> <span id="statusOptionDone"></span></label>
        </div>

        <!-- ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -->
        <div class="muted-strong" style="margin-top:6px;">
          <span id="workTimeLabel"></span>:
          <span id="workTimer"></span>
        </div>
      </div>
    </section>

    <!-- Map + route card -->
    <section class="card card-large">
      <div class="section-title-row">
        <div>
          <h2 id="mapSectionTitle" class="section-title"></h2>
          <p id="mapSectionSub" class="section-sub"></p>
        </div>
        <div class="pill-tabs">
          <button id="tabLive" class="active" type="button"></button>
          <button id="tabBreak" type="button"></button>
        </div>

      </div>

      <div id="map"></div>

      <!-- ‡∏•‡∏ö legend ‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ GPS -->
      <div class="route-legend">
        <div class="legend-row">
          <span class="legend-color"></span>
          <span id="gpsStatus"></span>
        </div>
      </div>
    </section>

    <section class="footer-actions">
      <button id="btnBackLogin" class="btn btn-ghost" type="button"></button>
    </section>
    <!-- Scan Result Popup -->
    <div id="scanPopup" class="scan-popup hidden">
      <div class="scan-card">
        <h3 id="scanTitle"></h3>
        <p id="scanBinId"></p>
        <p id="scanDriver"></p>
        <p id="scanTime"></p>
        <p id="scanFill"></p>
        <p id="scanWeight"></p>
      </div>
    </div>

    <!-- Finish Work Popup -->
    <div id="finishPopup" class="scan-popup hidden">
      <div class="scan-card" style="border-left-color:#ef4444">
        <h3 id="finishTitle"></h3>
        <p id="finishDesc" style="margin:8px 0"></p>

        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
          <button id="btnFinishNo" class="btn btn-ghost"></button>
          <button id="btnFinishYes" class="btn btn-primary"></button>
        </div>
      </div>
    </div>
    <!-- Logout Confirm Popup -->
    <div id="logoutPopup" class="scan-popup hidden">
      <div class="scan-card" style="border-left-color:#ef4444">
        <h3 id="logoutTitle"></h3>
        <p id="logoutDesc" style="margin:8px 0"></p>

        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
          <button id="btnLogoutCancel" class="btn btn-ghost"></button>
          <button id="btnLogoutConfirm" class="btn btn-primary" style="background:#ef4444"></button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== DEBUG MODE =====
    const DEBUG_BINS = true;
    function dbg(...args) {
      if (DEBUG_BINS) console.log("[BIN-DEBUG]", ...args);
    }

    // ===== GLOBAL STATE (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á script) =====
    let currentUser = null;
    let driverId = null;
    let displayName = null;
    let globalDriverId = "-";
    let isStartingWork = false; // üîí ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏ã‡πâ‡∏≥
    let lastRfidTime = 0;
    let lastRfidMap = {};

    function driverLiveRef() {
      if (!driverId) return null;
      return firebase.database().ref(`/driver_live/${driverId}`);
    }

    // ===== Firebase =====
    var firebaseConfig = {
      apiKey: "AIzaSyCyTSsRmX642krpJYOI-TfFpIhnxJBbzxk",
      authDomain: "smart-waste2568.firebaseapp.com",
      projectId: "smart-waste2568",
      storageBucket: "smart-waste2568.firebasestorage.app",
      messagingSenderId: "122699752010",
      appId: "1:122699752010:web:c22ab9b28ac15beaedbcb3",
      databaseURL: "https://smart-waste2568-default-rtdb.asia-southeast1.firebasedatabase.app"

    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const fs = firebase.firestore();
    const rtdb = firebase.database();

    function initAfterAuth() {
  loadTodaySchedule();
  listenLiveTimeFromRTDB();

  // ‚úÖ ‡∏ü‡∏±‡∏á RFID ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô /rfid_events/*
  listenAllDeviceRfid();
  console.log("üëÇ LISTEN RFID FROM ALL DEVICES under /rfid_events");
}

    function fillDriverProfile() {
      displayName = currentUser.fullName || currentUser.username || "-";
      driverId = currentUser.driverId; // ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Firestore 100%

      globalDriverId = driverId;

      driverNameEl.textContent = displayName;
      driverAvatarEl.textContent = displayName.charAt(0).toUpperCase();
      cardDriverName.textContent = displayName;
      updateDriverInfoTexts();
    }

    function afterDriverReady() {
      const ref = driverLiveRef();
      if (!ref) return;

      ref.once("value").then(snap => {
        const d = snap.val();
        if (!d) return;

        const today = new Date().toISOString().slice(0, 10);

        if (d.isWorking && d.day === today) {
          setTabMode("live");
          setWorkStatus("working");

          // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å RTDB
          localTimerBase = d.baseElapsedSec || 0;
          localTimerStartAt = d.lastStartAt || 0;

          startLocalTimer();
        }
        else if (d.day === today && d.isFinished) {
          setTabMode("break");
          setWorkStatus("done");

          localTimerBase = d.baseElapsedSec || 0;
          localTimerStartAt = 0;
          stopLocalTimer();

          workTimerEl.textContent = formatHMS(localTimerBase * 1000);
        }
        else {
          setWorkStatus("notstart");
          stopLocalTimer();
          workTimerEl.textContent = "00:00:00";
        }
      });
    }

    const trucksCol = fs.collection("trucks");
    // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á:
    // Firestore: smartbins/{zone}/bin_data/{BINID}
    // RTDB: /esp32_devices/{mac}/fillLevel
    const smartbinsCol = fs.collection("smartbins");

    // ===== DOM refs =====
    const driverNameEl = document.getElementById("driverName");
    const driverAvatarEl = document.getElementById("driverAvatar");
    const driverRoleLbl = document.getElementById("driverRoleLabel");
    const cardDriverName = document.getElementById("cardDriverName");
    const cardDriverInfo = document.getElementById("cardDriverInfo");
    const cardTruckInfo = document.getElementById("cardTruckInfo");
    const cardTodayRoute = document.getElementById("cardTodayRoute");
    const cardTodayRouteSub = document.getElementById("cardTodayRouteSub");
    const cardWorkStatusBadge = document.getElementById("cardWorkStatusBadge");

    const mapEl = document.getElementById("map");
    const btnLogout = document.getElementById("btnLogout");
    const btnBackLogin = document.getElementById("btnBackLogin");

    const langSelect = document.getElementById("langSelect");
    const tabLive = document.getElementById("tabLive");
    tabLive.disabled = true;
    const tabBreak = document.getElementById("tabBreak");
    const gpsStatusEl = document.getElementById("gpsStatus");
    const workTimerEl = document.getElementById("workTimer");
    const finishPopup = document.getElementById("finishPopup");
    const btnFinishYes = document.getElementById("btnFinishYes");
    const btnFinishNo = document.getElementById("btnFinishNo");
    const finishTitle = document.getElementById("finishTitle");
    const finishDesc = document.getElementById("finishDesc");

    function applyTranslations() {
      brandPill.textContent = tr("brandDriver");
      pageTitle.textContent = tr("pageTitle_driverDashboard");
      pageSub.textContent = tr("pageSub_driverDashboard");

      driverRoleLbl.textContent = tr("driverRole");
      btnLogout.textContent = tr("logout");

      cardDriverLabel.textContent = tr("cardDriverLabel");
      cardTodayRouteLabel.textContent = tr("cardTodayRouteLabel");
      cardWorkStatusLabel.textContent = tr("cardWorkStatusLabel");

      statusOptionNotStart.textContent = tr("statusOptionNotStart");
      statusOptionWorking.textContent = tr("statusOptionWorking");
      statusOptionDone.textContent = tr("statusOptionDone");

      workTimeLabel.textContent = tr("workTimeLabel");

      mapSectionTitle.textContent = tr("mapSectionTitle");
      mapSectionSub.textContent = tr("mapSectionSub");

      tabLive.textContent = tr("tabLive");
      tabBreak.textContent = tr("tabBreak");

      btnBackLogin.textContent = tr("btnBackLogin");
    }

    const logoutPopup = document.getElementById("logoutPopup");
    const logoutTitle = document.getElementById("logoutTitle");
    const logoutDesc = document.getElementById("logoutDesc");
    const btnLogoutCancel = document.getElementById("btnLogoutCancel");
    const btnLogoutConfirm = document.getElementById("btnLogoutConfirm");

    function showLogoutPopup() {
      logoutTitle.textContent = tr("logoutTitle");
      logoutDesc.textContent = tr("logoutText");
      btnLogoutCancel.textContent = tr("btnCancel");
      btnLogoutConfirm.textContent = tr("logout");

      logoutPopup.classList.remove("hidden");
    }

    function hideLogoutPopup() {
      logoutPopup.classList.add("hidden");
    }

    function showFinishPopup() {
      finishTitle.textContent = tr("confirmFinishTitle");
      finishDesc.textContent = tr("confirmFinishDesc");
      btnFinishYes.textContent = tr("confirmYes");
      btnFinishNo.textContent = tr("confirmNo");
      finishPopup.classList.remove("hidden");
    }

    function hideFinishPopup() {
      finishPopup.classList.add("hidden");
    }

    function updateDriverInfoTexts() {
      const prefix = tr("driverCodePrefix");
      cardDriverInfo.textContent = prefix + (globalDriverId || "-");
    }

    // ===== i18n SAFE FALLBACK (‡πÅ‡∏Å‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ) =====
    if (typeof window.currentLang === "undefined") {
      window.currentLang = localStorage.getItem("sw_lang") || "th";
    }

    if (typeof window.tr !== "function") {
      window.tr = function (key) {
        const dict =
          window.SW_Translations &&
          window.SW_Translations[window.currentLang];
        return (dict && dict[key]) || key;
      };
    }

    langSelect.value = currentLang;

    langSelect.addEventListener("change", e => {
      currentLang = e.target.value;
      localStorage.setItem("sw_lang", currentLang);
      location.reload(); // ‡∏á‡πà‡∏≤‡∏¢ + ‡∏ä‡∏±‡∏ß‡∏£‡πå ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
    });

    function pad2(n) { return String(n).padStart(2, "0"); }
    function stampLocal(now = new Date()) {
      return `${now.getFullYear()}${pad2(now.getMonth() + 1)}${pad2(now.getDate())}-${pad2(now.getHours())}${pad2(now.getMinutes())}${pad2(now.getSeconds())}`;
    }

    // ===== Work status radio -> badge text =====
    function updateStatusBadge(status) {
      if (status === "working") {
        cardWorkStatusBadge.textContent = tr("workStatusOn");
        cardWorkStatusBadge.className = "badge badge-status-work";
      } else if (status === "done") {
        cardWorkStatusBadge.textContent = tr("workStatusDone");
        cardWorkStatusBadge.className = "badge badge-status-off";
      } else {
        cardWorkStatusBadge.textContent = tr("workStatusOff");
        cardWorkStatusBadge.className = "badge badge-status-off";
      }
    }

    function setWorkStatus(status) {
      // 1) ‡∏ï‡∏±‡πâ‡∏á radio
      const radio = document.querySelector(
        `input[name="routeStatus"][value="${status}"]`
      );
      if (radio) radio.checked = true;

      // 2) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï badge
      updateStatusBadge(status);
    }

    document.querySelectorAll('input[name="routeStatus"]').forEach(r => {
      r.addEventListener("change", e => updateStatusBadge(e.target.value));
    });

    // ===== Map (Leaflet) + marker ‡∏£‡∏ñ =====
    const defaultCenter = [6.46007, 100.35933];
    const map = L.map(mapEl).setView(defaultCenter, 15);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 20,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    function clampFillValue(value) {
      if (typeof value !== "number" || Number.isNaN(value)) {
        return null;
      }
      return Math.max(0, Math.min(100, Math.round(value)));
    }
    function getFillColor(value) {
      if (value === null) {
        return "#94a3b8";
      }
      if (value >= 80) return "#dc2626";
      if (value >= 50) return "#f97316";
      return "#16a34a";
    }
    function buildBinIcon(entry) {
      const fillValue = clampFillValue(entry.fillLevel);
      const labelText = fillValue === null ? "?" : `${fillValue}%`;
      const labelClass = `bin-pin__label${fillValue === null ? " is-unknown" : ""}`;
      const color = getFillColor(fillValue);
      return L.divIcon({
        className: "bin-icon",
        html: `
          <div class="bin-pin" style="--pin-color:${color};">
            <div class="bin-pin__bubble">üóëÔ∏è</div>
            <div class="bin-pin__pointer"></div>
            <div class="${labelClass}">${labelText}</div>
          </div>
        `.trim(),
        iconSize: [50, 64],
        iconAnchor: [25, 52],
        popupAnchor: [0, -48]
      });
    }

    function attachBinRtdbListener(binId, macAddress, marker) {
      if (!macAddress) return;

      const ref = rtdb.ref(`/esp32_devices/${macAddress}`);

      const cb = ref.on("value", snap => {
        const d = snap.val();
        if (!d) return;

        const fill = typeof d.fillLevel === "number" ? d.fillLevel : null;

        // üî• ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡∏±‡∏á‡∏ó‡∏µ‡πà >= 80%
        if (fill === null || fill < 80) {
          if (map.hasLayer(marker)) {
            map.removeLayer(marker);
          }
          return;
        }

        // ‡∏ñ‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
        if (!map.hasLayer(marker)) {
          marker.addTo(map);
        }

        marker.setIcon(buildBinIcon({ fillLevel: fill }));

      });

      // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ unsubscribe ‡∏ï‡∏≠‡∏ô‡∏•‡∏ö marker
      marker._rtdbUnsub = () => ref.off("value", cb);
    }

    function buildTruckIcon() {
      return L.divIcon({
        className: "truck-icon",
        html: `
      <div style="
        font-size: 32px;
        transform: translate(-50%, -50%);
        filter: drop-shadow(0 6px 12px rgba(0,0,0,.35));
      ">
        üöö
      </div>
    `,
        iconSize: [32, 32],
        iconAnchor: [16, 16] // ‡πÉ‡∏´‡πâ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î
      });
    }

    let truckMarker = L.marker(defaultCenter, {
      icon: buildTruckIcon()
    })
      .addTo(map)
      .bindPopup(tr("truckLocationPopup"));

    let truckUnsub = null;
    let truckFirstUpdate = true; // panTo ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß

    function attachTruckListener() {
      if (truckUnsub) { truckUnsub(); truckUnsub = null; }
      if (!truckDocRef) return;

      truckFirstUpdate = true;

      truckUnsub = truckDocRef.onSnapshot(doc => {
        if (!doc.exists) return;
        const d = doc.data() || {};
        if (typeof d.lat === "number" && typeof d.lng === "number") {
          const pos = [d.lat, d.lng];
          truckMarker.setLatLng(pos);
          if (truckFirstUpdate) {
            map.panTo(pos, { animate: true });
            truckFirstUpdate = false;

            // ‚úÖ FIX ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏°
            setTimeout(() => {
              map.invalidateSize();
            }, 300);
          }
        }
      });
    }

    // ===== ‡πÅ‡∏™‡∏î‡∏á‡∏ñ‡∏±‡∏á‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏ó‡∏µ‡πà fillLevel >= 80% =====
    let zoneTodayId = null;
    let binsUnsub = null;
    let binMarkers = {};
    let binZoneNote = null;

    function clearBinMarkers() {
      Object.keys(binMarkers).forEach(id => {
        if (binMarkers[id]._rtdbUnsub) {
          binMarkers[id]._rtdbUnsub();
        }
        map.removeLayer(binMarkers[id]);

      });
      binMarkers = {};
    }

    function listenBinsForZone(zoneId) {

      if (binsUnsub) { binsUnsub(); binsUnsub = null; }
      clearBinMarkers();
      if (!zoneId) return;

      console.log("listenBinsForZone zoneId =", zoneId);

      binsUnsub = smartbinsCol
        .doc(zoneId)
        .collection("bin_data")
        .onSnapshot(async sn => {
          dbg("Firestore snapshot", {
            zoneId,
            size: sn.size
          });
          const seen = {};
          binZoneNote = zoneId;

          const tasks = sn.docs.map(async doc => {
            const d = doc.data() || {};
            const id = doc.id;
            dbg("BIN DOC", id, d);

            const lat = d.lat ?? d.regLat;
            const lng = d.lng ?? d.regLng;
            if (typeof lat !== "number" || typeof lng !== "number") {
              dbg("‚ùå BIN NO LAT/LNG", id, { lat, lng });
              return;
            }

            const pos = { lat, lng };

            if (!binMarkers[id]) {
              const marker = L.marker([pos.lat, pos.lng], {
                icon: buildBinIcon({ fillLevel: null })
              }).addTo(map);

              binMarkers[id] = marker;

              // üî• ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
              attachBinRtdbListener(
                id,
                d.macAddress,   // ‚Üê ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ field ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Firestore
                marker
              );
            }

            seen[id] = true;
          });

          await Promise.all(tasks);

          // ‡∏•‡∏ö marker ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô snapshot ‡πÅ‡∏•‡πâ‡∏ß
          Object.keys(binMarkers).forEach(id => {
            if (!seen[id]) {
              map.removeLayer(binMarkers[id]);
              delete binMarkers[id];
            }
          });

          // pan ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡∏±‡∏á‡πÅ‡∏£‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          // const ids = Object.keys(binMarkers);
          // if (ids.length) {
          //   const first = binMarkers[ids[0]];
          //   if (first && first.getLatLng) {
          //     map.panTo(first.getLatLng(), { animate: true });
          //   }
          // }
        }, err => {
          console.error("listenBinsForZone error", err);
        });
    }

    function showScanPopup({
      binId,
      driverName,
      savedAt,
      fillLevel,
      weight
    }) {
      const now = Date.now();

      // üîí ‡∏Å‡∏±‡∏ô popup ‡∏ã‡πâ‡∏≠‡∏ô‡πÉ‡∏ô 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      const rfidKey = `${binId}`;
      if (lastRfidMap[rfidKey] && now - lastRfidMap[rfidKey] < 60000) return;
      lastRfidMap[rfidKey] = now;

      const popup = document.getElementById("scanPopup");

      document.getElementById("scanBinId").textContent =
        tr("scanBinId") + ": " + binId;

      document.getElementById("scanDriver").textContent =
        tr("scanDriver") + ": " + driverName;

      document.getElementById("scanTime").textContent =
        tr("scanSavedAt") + ": " + savedAt;

      document.getElementById("scanFill").textContent =
        tr("scanFill") + ": " + fillLevel + "%";

      document.getElementById("scanWeight").textContent =
        tr("scanWeight") + ": " + weight + " g";

      popup.classList.remove("hidden");

      setTimeout(() => {
        popup.style.animation = "fadeOut 0.5s ease forwards";
        setTimeout(() => {
          popup.classList.add("hidden");
          popup.style.animation = "";
        }, 500);
      }, 4000);
    }

    async function handleRfidFromDevice(ev) {
      // ev = { rfid, mac, truckId, driverId, timestamp }

      if (!zoneTodayId) return;
      if (!ev || !ev.rfid) return;

      try {
        // üîç ‡∏´‡∏≤ bin ‡∏à‡∏≤‡∏Å RFID
        const snap = await smartbinsCol
          .doc(zoneTodayId)
          .collection("bin_data")
          .where("RFID", "==", ev.rfid)
          .limit(1)
          .get();

        console.log("üîé FIND BIN BY RFID", {
          rfid: ev.rfid,
          zone: zoneTodayId
        });

        if (snap.empty) {
          console.warn("‚ùå RFID SCAN BUT BIN NOT FOUND", {
            rfid: ev.rfid,
            zone: zoneTodayId,
            truck: currentTruckId
          });
          return;
        }

        const binDoc = snap.docs[0];
        const binRef = binDoc.ref;
        const binData = binDoc.data() || {};

        // ‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å RTDB (/esp32_devices)
        let levelBefore = 0;
        let weightBefore = 0;

        if (binData.macAddress) {
          const snap = await rtdb
            .ref(`/esp32_devices/${binData.macAddress}`)
            .once("value");

          const d = snap.val();
          if (d) {
            levelBefore =
              typeof d.fillLevel === "number" ? d.fillLevel : 0;

            weightBefore =
              typeof d.weightGram === "number"
                ? d.weightGram
                : 0;
          }
        }

        const today = new Date().toISOString().slice(0, 10);

        // üöö ‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏ñ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        if (truckDocRef) {
          const tSnap = await truckDocRef.get();
          if (tSnap.exists) {
            const t = tSnap.data() || {};
            lat = t.lat ?? null;
            lng = t.lng ?? null;
          }
        }

        // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Firestore
        await binRef
          .collection("emptying_trash")
          .doc(today)
          .set({
            binId: binData.binId || binDoc.id,
            driverId: driverId,
            driverName: displayName,
            truckId: currentTruckId,
            levelBefore: levelBefore,
            weightBefore: weightBefore, // ‚úÖ gram
            emptiedAt: firebase.firestore.FieldValue.serverTimestamp()
          });

        // ‚úÖ SHOW POPUP (‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
        showScanPopup({
          binId: binData.binId || binDoc.id,
          driverName: displayName,
          savedAt: new Date().toLocaleString(),
          fillLevel: levelBefore,
          weight: weightBefore.toFixed(4)
        });


      } catch (e) {
        console.error("handleRfidFromDevice error", e);
      }
    }

    // ===== LISTEN RFID FROM DEVICE STYLE (esp32) =====

    function listenAllDeviceRfid() {
  const ref = rtdb.ref(`/rfid_events`);

  ref.on("child_changed", async snap => {
    const deviceKey = snap.key;   // ‡πÄ‡∏ä‡πà‡∏ô esp32_01 ‡∏´‡∏£‡∏∑‡∏≠ MAC ‡∏à‡∏£‡∏¥‡∏á
    const d = snap.val();

    if (!d || !d.rfid || !d.time) return;

    // üîí ‡∏Å‡∏±‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ã‡πâ‡∏≥
    if (lastRfidTime === d.time) return;
    lastRfidTime = d.time;

    console.log("üìå RFID SCAN EVENT", {
      deviceKey,
      rfid: d.rfid,
      time: d.time
    });

    await handleRfidFromDevice({
      rfid: String(d.rfid).trim(),
      mac: deviceKey,
      truckId: currentTruckId,
      driverId: driverId,
      timestamp: d.time
    });
  });

  // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ö‡∏≤‡∏á‡∏Å‡∏£‡∏ì‡∏µ RTDB ‡πÉ‡∏ä‡πâ set ‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥ (‡πÑ‡∏°‡πà trigger child_changed)
  // ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á child_added ‡∏î‡πâ‡∏ß‡∏¢ (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á key ‡πÉ‡∏´‡∏°‡πà)
  ref.on("child_added", async snap => {
    const deviceKey = snap.key;
    const d = snap.val();

    if (!d || !d.rfid || !d.time) return;

    if (lastRfidTime === d.time) return;
    lastRfidTime = d.time;

    console.log("üìå RFID SCAN EVENT (child_added)", {
      deviceKey,
      rfid: d.rfid,
      time: d.time
    });

    await handleRfidFromDevice({
      rfid: String(d.rfid).trim(),
      mac: deviceKey,
      truckId: currentTruckId,
      driverId: driverId,
      timestamp: d.time
    });
  });
}

    // ===== ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ GPS =====
    let currentTruckId = null;
    let truckDocRef = null;
    let posWatcherId = null;
    let activeRunRef = null;
    let lat = null;
    let lng = null;

    function setGpsStatus(msgKeyOrText) {
      const fromDict = tr(msgKeyOrText);
      if (fromDict && fromDict !== msgKeyOrText) {
        gpsStatusEl.textContent = fromDict;
      } else {
        gpsStatusEl.textContent = msgKeyOrText;
      }
    }

    // ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
    function requestLocationPermission() {
      return new Promise(resolve => {
        if (!navigator.geolocation) {
          setGpsStatus("gpsNotSupported");
          resolve(false);
          return;
        }

        navigator.geolocation.getCurrentPosition(
          () => {
            setGpsStatus("gpsIdle");
            resolve(true);   // ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
          },
          err => {
            setGpsStatus(tr("gpsErrorPrefix") + err.message);
            resolve(false);  // ‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
          },
          { enableHighAccuracy: true }
        );
      });
    }

    async function startGpsTracking() {
      console.log("üö¶ startGpsTracking()", {
        currentTruckId,
        truckDocReady: !!truckDocRef,
        hasWatcher: !!posWatcherId
      });

      if (posWatcherId) return;

      if (!currentTruckId || !truckDocRef) {
        console.warn("‚ùå GPS BLOCKED: truck not ready");
        return;
      }

      // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏° watch GPS ‡∏à‡∏£‡∏¥‡∏á
      posWatcherId = navigator.geolocation.watchPosition(
        async pos => {
          lat = pos.coords.latitude;
          lng = pos.coords.longitude;
          const now = Date.now();

          console.log("üìç GPS UPDATE", { lat, lng });

          // üîµ Firestore (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏ñ)
          await truckDocRef.set({
            lat,
            lng,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });

          // üî¥ RTDB (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á + heartbeat ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö)
          const liveRef = driverLiveRef();
          if (liveRef) {
            await liveRef.update({
              lat,
              lng,
              lastUpdate: now
            });
          }

          setGpsStatus("gpsSending");
        },
        err => {
          console.error("‚ùå GPS ERROR", err);
          setGpsStatus(tr("gpsErrorPrefix") + err.message);
        },
        {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 10000
        }
      );
    }

    async function stopGpsTracking() {
      if (posWatcherId) {
        navigator.geolocation.clearWatch(posWatcherId);
        posWatcherId = null;
      }

      if (truckDocRef) {
        await truckDocRef.set({ isTracking: false }, { merge: true });
      }

      activeRunRef = null;

      setGpsStatus("gpsStopped");
    }

    function setTabMode(mode) {
      if (mode === "live") {
        tabLive.classList.add("active");
        tabBreak.classList.remove("active");
      } else {
        tabBreak.classList.add("active");
        tabLive.classList.remove("active");
      }
    }

    // flag ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‚Äú‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‚Äù ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏°‡πâ Firestore ‡∏¢‡∏±‡∏á sync

    tabLive.addEventListener("click", async () => {
      if (isStartingWork) return;
      isStartingWork = true;

      try {
        if (!driverId || !currentTruckId || !truckDocRef) {
          alert(tr("errDriverOrTruckMissing"));
          isStartingWork = false; // üî• ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å
          return;
        }

        // 1Ô∏è‚É£ ‡∏Ç‡∏≠ permission GPS
        const allowed = await requestLocationPermission();
        if (!allowed) {
          setGpsStatus("gpsPermissionRequired");
          isStartingWork = false;
          return;
        }

        const today = new Date().toISOString().slice(0, 10);

        // 2Ô∏è‚É£ Firestore: start work (single session / once per day)
        activeRunRef = truckDocRef
          .collection("truck_operating_time")
          .doc(today);

        const fsSnap = await activeRunRef.get();
        if (fsSnap.exists) {
          const d = fsSnap.data();

          // üîí ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
          if (d.startAt) {
            isStartingWork = false;
            return;
          }
        }

        await activeRunRef.set({
          driverId,
          driverName: displayName,
          startAt: firebase.firestore.FieldValue.serverTimestamp(),
          isFinished: false,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // 3Ô∏è‚É£ RTDB: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö‡∏™‡∏∞‡∏™‡∏°
        // 3Ô∏è‚É£ RTDB: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö‡∏™‡∏∞‡∏™‡∏°
        const liveRef = driverLiveRef();
        if (!liveRef) {
          alert(tr("errSystemNotReady"));
          isStartingWork = false;
          return;
        }

        const liveSnap = await liveRef.once("value");
        if (liveSnap.exists()) {
          const d = liveSnap.val();

          if (d.day === today && d.isFinished) {
            isStartingWork = false;
            return;
          }

          if (d.day === today && d.hasStarted) {
            isStartingWork = false;
            return;
          }
        }

        let baseElapsed = 0;
        if (liveSnap.exists()) {
          const d = liveSnap.val();
          if (d.day === today && typeof d.baseElapsedSec === "number") {
            baseElapsed = d.baseElapsedSec;
          }
        }
        if (
          liveSnap.exists() &&
          liveSnap.val().isWorking &&
          liveSnap.val().day === today
        ) {
          alert(tr("errAlreadyWorkingOtherDevice"));
          isStartingWork = false; // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°
          return;
        }

        await liveRef.set({
          day: today,
          hasStarted: true,
          isFinished: false,
          isWorking: true,
          baseElapsedSec: baseElapsed,
          lastStartAt: Date.now(),
          lastUpdate: Date.now(),
          driverId,
          driverName: displayName,
          truckId: currentTruckId,
          zoneId: zoneTodayId
        });

        // 4Ô∏è‚É£ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á GPS
        await startGpsTracking();

        setTabMode("live");
        setWorkStatus("working");
      } catch (e) {
        console.error("‚ùå START WORK ERROR", e);
        alert(tr("errStartWorkFailed"));
      } finally {
        isStartingWork = false;
      }
    });

    tabBreak.addEventListener("click", async () => {
      if (!truckDocRef) return;

      const today = new Date().toISOString().slice(0, 10);
      const snap = await truckDocRef
        .collection("truck_operating_time")
        .doc(today)
        .get();

      if (snap.exists && snap.data().isFinished === true) {
        console.log("‚õî ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î popup");
        return;
      }

      showFinishPopup();
    });

    btnFinishNo.addEventListener("click", () => {
      hideFinishPopup();
      setTabMode("live");
      setWorkStatus("working");
    });

    btnFinishYes.addEventListener("click", async () => {
      hideFinishPopup();

      const today = new Date().toISOString().slice(0, 10);

      // RTDB
      const liveRef = driverLiveRef();
      let elapsed = 0;

      if (liveRef) {
        const snap = await liveRef.once("value");
        if (snap.exists()) {
          const d = snap.val();
          elapsed = d.baseElapsedSec || 0;
          if (d.isWorking && d.lastStartAt) {
            elapsed += Math.floor((Date.now() - d.lastStartAt) / 1000);
          }

          await liveRef.update({
            isWorking: false,
            isFinished: true,
            baseElapsedSec: elapsed,
            lastStartAt: null,
            finishedAt: Date.now()
          });
        }
      }

      // Firestore
      if (activeRunRef) {
        await activeRunRef.update({
          endAt: firebase.firestore.FieldValue.serverTimestamp(),
          totalSeconds: elapsed,
          isFinished: true,
          finishedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      await stopGpsTracking();

      tabLive.classList.remove("active");
      tabBreak.classList.add("active");
      setWorkStatus("done");
    });
    document
      .querySelectorAll('input[name="routeStatus"]')
      .forEach(r => r.disabled = true);

    // ===== ‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ "‡πÄ‡∏ß‡∏•‡∏≤‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" =====
    let localTimerInterval = null;
    let localTimerBase = 0;     // baseElapsedSec ‡∏à‡∏≤‡∏Å RTDB
    let localTimerStartAt = 0;  // lastStartAt ‡∏à‡∏≤‡∏Å RTDB

    function formatHMS(ms) {
      const totalSec = Math.max(0, Math.floor(ms / 1000));
      const h = Math.floor(totalSec / 3600);
      const m = Math.floor((totalSec % 3600) / 60);
      const s = totalSec % 60;
      return (
        String(h).padStart(2, "0") + ":" +
        String(m).padStart(2, "0") + ":" +
        String(s).padStart(2, "0")
      );
    }

    function startLocalTimer() {
      if (localTimerInterval) return;

      localTimerInterval = setInterval(() => {
        if (!localTimerStartAt) return;

        const elapsedSec =
          localTimerBase +
          Math.floor((Date.now() - localTimerStartAt) / 1000);

        workTimerEl.textContent = formatHMS(elapsedSec * 1000);
      }, 1000);
    }

    function stopLocalTimer() {
      if (localTimerInterval) {
        clearInterval(localTimerInterval);
        localTimerInterval = null;
      }
    }

    let liveTimeListening = false;

    function listenLiveTimeFromRTDB() {
      if (liveTimeListening) return;
      liveTimeListening = true;
      const ref = driverLiveRef();
      if (!ref) return;

      ref.on("value", snap => {
        const d = snap.val();
        if (!d) return;

        const today = new Date().toISOString().slice(0, 10);
        if (d.day !== today) {
          workTimerEl.textContent = "00:00:00";
          stopLocalTimer();
          return;
        }

        localTimerBase = d.baseElapsedSec || 0;
        localTimerStartAt = d.isWorking ? d.lastStartAt : 0;

        if (d.isWorking && d.lastStartAt) {
          startLocalTimer();
        } else {
          stopLocalTimer();
          workTimerEl.textContent = formatHMS(localTimerBase * 1000);
        }
      });
    }

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadTodaySchedule() ‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ
    async function loadTodaySchedule() {
      // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Profile ‡∏™‡∏î‡πÜ ‡∏à‡∏≤‡∏Å Firestore ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ ID ‡∏à‡∏≤‡∏Å session ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å LocalStorage ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      const userSnap = await fs
        .collection("users")
        .doc(currentUser.driverId)
        .get();

      if (!userSnap.exists) {
        console.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
        return;
      }

      const userData = userSnap.data();
      const zoneId = userData.zoneId; // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ "Yala" ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å DB

      if (!zoneId) {
        alert(tr("errNoZoneAssigned"));
        return;
      }

      // 2. ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD)
      const todayId = new Date().toISOString().slice(0, 10);

      const docRef = fs
        .collection("truck_schedule")
        .doc(zoneId)
        .collection("days")
        .doc(todayId);

      const snap = await docRef.get();

      if (!snap.exists) {
        cardTodayRoute.textContent = tr("noScheduleToday");
        cardTodayRouteSub.textContent = tr("noScheduleSub");
        return;
      }

      const data = snap.data();

      // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÄ‡∏ß‡∏£‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (data.driverId !== driverId) {
        cardTodayRoute.textContent = tr("noScheduleForDriver");
        console.log("‚ùå ‡∏°‡∏µ‡πÄ‡∏ß‡∏£‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™: " + data.driverId);
        return;
      }

      // 4. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÄ‡∏ß‡∏£‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
      console.log("‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", data);
      zoneTodayId = zoneId;
      if (!data.truckId) {
        alert(tr("errNoTruckAssigned"));
        return;
      }
      currentTruckId = data.truckId;

      truckDocRef = fs
        .collection("trucks")
        .doc(zoneId)
        .collection("vehicles")
        .doc(currentTruckId);
      // üîí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (Firestore = ‡∏ï‡∏±‡∏ß‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô)
      const today = new Date().toISOString().slice(0, 10);
      const runRef = truckDocRef
        .collection("truck_operating_time")
        .doc(today);

      const runSnap = await runRef.get();

      if (runSnap.exists) {
        const run = runSnap.data();

        if (run.isFinished === true) {
          console.log("üîí ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß (Firestore)");

          // ‚ùå ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å action
          tabLive.disabled = true;
          tabBreak.disabled = true;

          // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ UI
          setTabMode("break");
          setWorkStatus("done");

          // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≤‡∏Å Firestore
          if (typeof run.totalSeconds === "number") {
            workTimerEl.textContent = formatHMS(run.totalSeconds * 1000);
          }

          // üîí ‡∏Å‡∏±‡∏ô popup ‡∏à‡∏ö‡∏á‡∏≤‡∏ô
          tabBreak.onclick = null;

          return; // ‚õî ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ logic ‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠
        }
      }

      // üöö ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏Ç‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      if (cardTruckInfo) {
        cardTruckInfo.textContent =
          tr("truckCodePrefix") + " " + currentTruckId;
      }

      // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏ñ + schedule ‡∏û‡∏£‡πâ‡∏≠‡∏°)
      tabLive.disabled = false;

      console.log("‚úÖ READY TO START WORK", {
        driverId,
        zoneTodayId,
        currentTruckId,
        truckDocReady: !!truckDocRef
      });

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
      cardTodayRoute.textContent = zoneId;
      cardTodayRouteSub.textContent = todayId;
      cardTodayRoute.dataset.hasSchedule = "1";

      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞ GPS
      attachTruckListener();
      listenBinsForZone(zoneTodayId);
      tabLive.disabled = false;
    }

    // ===== Buttons =====
    btnLogout.addEventListener("click", () => {
      showLogoutPopup();
    });

    btnLogoutCancel.addEventListener("click", () => {
      hideLogoutPopup();
    });

    btnLogoutConfirm.addEventListener("click", async () => {
      hideLogoutPopup();

      try {
        await window.SWAuth.logout();
      } catch (e) { }

      window.location.href = "../Login/login.html";
    });

    // ===== Init =====
    // updateStatusBadge("notstart");
    setGpsStatus("gpsIdle");
    if (workTimerEl) workTimerEl.textContent = "00:00:00";

    document.addEventListener("driver-auth-ready", () => {
      const driver = window.DRIVER_AUTH;
      if (!driver) return;

      currentUser = driver;

      fillDriverProfile();

      applyTranslations();

      afterDriverReady();
      initAfterAuth();
    });

  </script>

</body>

</html>